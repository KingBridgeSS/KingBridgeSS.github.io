<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>使用tabby对CVE-2022-39198的挖掘尝试</title>
    <meta name="description" content="">
    <meta name="keywords" content='Web'>

    <meta property="og:url" content="https://kingbridgess.github.io/posts/%E4%BD%BF%E7%94%A8tabby%E5%AF%B9cve-2022-39198%E7%9A%84%E6%8C%96%E6%8E%98%E5%B0%9D%E8%AF%95/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="使用tabby对CVE-2022-39198的挖掘尝试">
    <meta property="og:description" content="">
    <meta property="og:image" content="">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="使用tabby对CVE-2022-39198的挖掘尝试">
    <meta name="twitter:description" content="">
    <meta property="twitter:domain" content="https://kingbridgess.github.io/posts/%E4%BD%BF%E7%94%A8tabby%E5%AF%B9cve-2022-39198%E7%9A%84%E6%8C%96%E6%8E%98%E5%B0%9D%E8%AF%95/">
    <meta property="twitter:url" content="https://kingbridgess.github.io/posts/%E4%BD%BF%E7%94%A8tabby%E5%AF%B9cve-2022-39198%E7%9A%84%E6%8C%96%E6%8E%98%E5%B0%9D%E8%AF%95/">
    <meta name="twitter:image" content="">

    
    <link rel="canonical" href="https://kingbridgess.github.io/posts/%E4%BD%BF%E7%94%A8tabby%E5%AF%B9cve-2022-39198%E7%9A%84%E6%8C%96%E6%8E%98%E5%B0%9D%E8%AF%95/" />

    <link rel="stylesheet" type="text/css" href="https://kingbridgess.github.io/css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://kingbridgess.github.io/css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://kingbridgess.github.io/css/dark.css">

    <script src="https://kingbridgess.github.io/js/svg-injector.min.js"></script>
    <script src="https://kingbridgess.github.io/js/feather-icons.min.js"></script>
    <script src="https://kingbridgess.github.io/js/main.js"></script>

    
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        

        <div class="nav-title">
            <a class="nav-brand" href="https://kingbridgess.github.io">BRIdGE</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/posts/"> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/tags/"> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/about"> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/contact/"> Contact </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/kingbridgess"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/posts/"> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/tags/"> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/about"> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/contact/"> Contact </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/kingbridgess"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>使用tabby对CVE-2022-39198的挖掘尝试</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            January 2, 2023
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://kingbridgess.github.io/tags/web">Web</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <p>新年第一次做正事 = =</p>
<h1 id="一些废话">一些废话</h1>
<p>CVE-2022-39198大概是在去年11月下旬公布的。当时和几位同学看了很久，未果，寻被学校赶回家，后遂无问津者。时隔一个月，终于从期末和omicron的重创中缓过来。现在网上对这个漏洞的分析已经十分详细，Eki博士也现场演示了其复现过程。所以我也算是终于可以把这个史前大坑填了。</p>
<p>另一个坑是tabby。当时在挖这条链的时候，最后就是卡在寻找getter2RCE的sink类。我当时用codeql来跑，其下头程度可想而知。由于codeql需要编译，那么每一个有可能的依赖都要在电脑上单独编译。而且这些编译好的仓库是独立的，不能跑一个总体的链。另外，手动编译jdk的恶心程度也不必言说。当然，可以偷懒去lgtm找版本十分有限的编译好的仓库。但是好巧不巧，lgtm在2022年12月永久关闭。所以也是时候尝试一下可以直接分析jar包的tabby了。</p>
<h1 id="环境配置">环境配置</h1>
<p>POC编写和调试我直接用了Eki博士的大作</p>
<p><a href="https://github.com/EkiXu/marshalexp">https://github.com/EkiXu/marshalexp</a></p>
<p>另外由于sink类是Unix系统独有，所以我在Linux虚拟机运行。</p>
<p>我在windows上跑的neo4j+tabby。相关配置参考</p>
<p><a href="https://github.com/wh1t3p1g/tabby">https://github.com/wh1t3p1g/tabby</a></p>
<h1 id="漏洞分析">漏洞分析</h1>
<h2 id="source-tostring">source: toString</h2>
<p>看commit历史，特别是8月27号的commit</p>
<p><a href="https://github.com/apache/dubbo-hessian-lite/compare/v3.2.12...v3.2.13">https://github.com/apache/dubbo-hessian-lite/compare/v3.2.12...v3.2.13</a></p>
<p>可以看到多加了反序列化时要继承Serializable的限制，和一些黑名单的限制</p>
<p>可以通过这篇文章了解一下Dubbo的历史漏洞</p>
<p><a href="https://tttang.com/archive/1730/">https://tttang.com/archive/1730/</a></p>
<p>可以发现一般hessian的漏洞就是source触发点，或者反序列化链的黑名单绕过。</p>
<p>source触发点这边，yemoli师傅的</p>
<p><a href="https://mp.weixin.qq.com/s/kGcOY8xLCu9LDL6LoWm1Bw">从CVE-2022-39198到春秋杯冬季赛Dubboapp</a></p>
<p>一文中提供了toString触发点<code>org.apache.dubbo.rpc.RpcInvocation#toString</code></p>
<h2 id="tostring2getter">toString2getter</h2>
<p>然后就是toString2RCE了。符合黑名单的目前我只知道两个。</p>
<p>第一个是rome1.0版本，可以利用ToStringBean实现toString2getter。但是这要引入第三方依赖，所以不再赘述。</p>
<p>另一个是fastjson的com.alibaba.fastjson.JSON#toString()，也可以实现toString2getter。而且，fastjson是dubbo的下游依赖</p>
<p><img src="https://s2.loli.net/2023/01/02/j48GRcTHk7L36yE.png" alt="image-20230102153040034"></p>
<p>所以接下来就是getter2RCE，也是本文的重点。</p>
<h2 id="getter2rce">getter2RCE</h2>
<h3 id="条件">条件</h3>
<p>首先hessian-lite对反序列化类有严格的限制。</p>
<p>hessian在反序列化的时候会先寻找cost最小的constructor</p>
<p>JavaDeserializer#JavaDeserializer</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>Constructor<span style="color:#ff79c6">[]</span> constructors <span style="color:#ff79c6">=</span> cl<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredConstructors</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd">long</span> bestCost <span style="color:#ff79c6">=</span> Long<span style="color:#ff79c6">.</span><span style="color:#50fa7b">MAX_VALUE</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> i <span style="color:#ff79c6">&lt;</span> constructors<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">++)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    Class<span style="color:#ff79c6">[]</span> param <span style="color:#ff79c6">=</span> constructors<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">].</span><span style="color:#50fa7b">getParameterTypes</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">long</span> cost <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> j <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> j <span style="color:#ff79c6">&lt;</span> param<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">;</span> j<span style="color:#ff79c6">++)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        cost <span style="color:#ff79c6">=</span> 4 <span style="color:#ff79c6">*</span> cost<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>Object<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>param<span style="color:#ff79c6">[</span>j<span style="color:#ff79c6">]))</span>
</span></span><span style="display:flex;"><span>            cost <span style="color:#ff79c6">+=</span> 1<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>param<span style="color:#ff79c6">[</span>j<span style="color:#ff79c6">]))</span>
</span></span><span style="display:flex;"><span>            cost <span style="color:#ff79c6">+=</span> 2<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>param<span style="color:#ff79c6">[</span>j<span style="color:#ff79c6">]))</span>
</span></span><span style="display:flex;"><span>            cost <span style="color:#ff79c6">+=</span> 3<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">long</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>param<span style="color:#ff79c6">[</span>j<span style="color:#ff79c6">]))</span>
</span></span><span style="display:flex;"><span>            cost <span style="color:#ff79c6">+=</span> 4<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>param<span style="color:#ff79c6">[</span>j<span style="color:#ff79c6">].</span><span style="color:#50fa7b">isPrimitive</span><span style="color:#ff79c6">())</span>
</span></span><span style="display:flex;"><span>            cost <span style="color:#ff79c6">+=</span> 5<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>
</span></span><span style="display:flex;"><span>            cost <span style="color:#ff79c6">+=</span> 6<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>cost <span style="color:#ff79c6">&lt;</span> 0 <span style="color:#ff79c6">||</span> cost <span style="color:#ff79c6">&gt;</span> <span style="color:#ff79c6">(</span>1 <span style="color:#ff79c6">&lt;&lt;</span> 48<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>        cost <span style="color:#ff79c6">=</span> 1 <span style="color:#ff79c6">&lt;&lt;</span> 48<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cost <span style="color:#ff79c6">+=</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">long</span><span style="color:#ff79c6">)</span> param<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span> <span style="color:#ff79c6">&lt;&lt;</span> 48<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>cost <span style="color:#ff79c6">&lt;</span> bestCost<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        _constructor <span style="color:#ff79c6">=</span> constructors<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">];</span>
</span></span><span style="display:flex;"><span>        bestCost <span style="color:#ff79c6">=</span> cost<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>并且，如果constructor的参数不是基本变量的话，在实例化的时候hessian会把它们改成null</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">protected</span> <span style="color:#8be9fd;font-style:italic">static</span> Object <span style="color:#50fa7b">getParamArg</span><span style="color:#ff79c6">(</span>Class cl<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span>cl<span style="color:#ff79c6">.</span><span style="color:#50fa7b">isPrimitive</span><span style="color:#ff79c6">())</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">boolean</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>cl<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> Boolean<span style="color:#ff79c6">.</span><span style="color:#50fa7b">FALSE</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>cl<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Byte<span style="color:#ff79c6">((</span><span style="color:#8be9fd">byte</span><span style="color:#ff79c6">)</span> 0<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">short</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>cl<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Short<span style="color:#ff79c6">((</span><span style="color:#8be9fd">short</span><span style="color:#ff79c6">)</span> 0<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">char</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>cl<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">new</span> Character<span style="color:#ff79c6">((</span><span style="color:#8be9fd">char</span><span style="color:#ff79c6">)</span> 0<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>cl<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> Integer<span style="color:#ff79c6">.</span><span style="color:#50fa7b">valueOf</span><span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">long</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>cl<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> Long<span style="color:#ff79c6">.</span><span style="color:#50fa7b">valueOf</span><span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">float</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>cl<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> Float<span style="color:#ff79c6">.</span><span style="color:#50fa7b">valueOf</span><span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">double</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>cl<span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> Double<span style="color:#ff79c6">.</span><span style="color:#50fa7b">valueOf</span><span style="color:#ff79c6">(</span>0<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">else</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> UnsupportedOperationException<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>结合上面，我们可以知道寻找的类需要满足：</p>
<ol>
<li>constructor的参数是基本类型，或者非基本类型的参数为null的时候不会报错，或者干脆无参</li>
<li>有标准的getter(无参，public)</li>
</ol>
<h3 id="tabby">tabby</h3>
<p>第一个比较坑的地方就是我在开了数据库的情况下居然没办法打开Neo4j Browser，必须要先打开Browser再打开数据库。</p>
<p>然后开着数据库去运行tabby。</p>
<p>先把tabby clone下来，直接用idea打开，让它去读取gradle的依赖。然后去修改settings.properties。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>tabby<span style="color:#ff79c6">.</span><span style="color:#50fa7b">build</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">enable</span>                    <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>tabby<span style="color:#ff79c6">.</span><span style="color:#50fa7b">build</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">isJDKProcess</span>              <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span> 
</span></span><span style="display:flex;"><span>tabby<span style="color:#ff79c6">.</span><span style="color:#50fa7b">build</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">withAllJDK</span>                <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>tabby<span style="color:#ff79c6">.</span><span style="color:#50fa7b">build</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">excludeJDK</span>                <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>tabby<span style="color:#ff79c6">.</span><span style="color:#50fa7b">build</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">isJDKOnly</span>                 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tabby<span style="color:#ff79c6">.</span><span style="color:#50fa7b">build</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">checkFatJar</span>               <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tabby<span style="color:#ff79c6">.</span><span style="color:#50fa7b">build</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">isFullCallGraphCreate</span>     <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tabby<span style="color:#ff79c6">.</span><span style="color:#50fa7b">build</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">target</span>                    <span style="color:#ff79c6">=</span> jars<span style="color:#ff79c6">/</span>
</span></span><span style="display:flex;"><span>tabby<span style="color:#ff79c6">.</span><span style="color:#50fa7b">build</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">libraries</span>                 <span style="color:#ff79c6">=</span> jars<span style="color:#ff79c6">/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tabby<span style="color:#ff79c6">.</span><span style="color:#50fa7b">load</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">enable</span>                     <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tabby<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">details</span>                   <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
</span></span><span style="display:flex;"><span>tabby<span style="color:#ff79c6">.</span><span style="color:#50fa7b">debug</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">inner</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">details</span>             <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">true</span>
</span></span></code></pre></div><p>我这里设置会读取第三方jar包。接下来把下载下来的jar包放在jars目录即可。我用了Linux版本的jdk8u202。解压下载后的文件，找到rt.jar，放入刚才所说的jars文件夹。接下来运行App.java即可。在惊心动魄的CPU和内存接近100%的几分钟后，tabby就会自动把数据导入Neo4j。</p>
<p>Neo4j语法可以参考</p>
<p><a href="https://neo4j.com/docs/">https://neo4j.com/docs/</a></p>
<p>还是从几个小example理解：</p>
<p>输入<code>CALL db.schema.visualization()</code>，可以看到数据库中节点和边的关系：</p>
<p><img src="https://s2.loli.net/2023/01/02/cIhpE1xMBVrK6g7.png" alt="image-20230102163231410"></p>
<p>然后分别输入</p>
<p><code>match (source:Class) return * limit 1</code></p>
<p><code>match (source:Method) return * limit 1</code></p>
<p>可以看到点的属性。</p>
<p>可以套用一些常用的反序列化链的模板：</p>
<p>一条path</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>match path<span style="color:#ff79c6">=(</span>source<span style="color:#ff79c6">:</span>Method<span style="color:#ff79c6">)-[:</span>CALL<span style="color:#ff79c6">*..</span><span style="color:#50fa7b">1</span><span style="color:#ff79c6">]-&gt;(</span>sink<span style="color:#ff79c6">:</span>Method <span style="color:#ff79c6">{})</span> 
</span></span><span style="display:flex;"><span>where source<span style="color:#ff79c6">.</span><span style="color:#50fa7b">PARAMETER_SIZE</span><span style="color:#ff79c6">=</span>0  and source<span style="color:#ff79c6">.</span><span style="color:#50fa7b">NAME</span> <span style="color:#ff79c6">=~</span> <span style="color:#f1fa8c">&#34;get.*&#34;</span> and sink<span style="color:#ff79c6">.</span><span style="color:#50fa7b">NAME</span> <span style="color:#ff79c6">=~</span> <span style="color:#f1fa8c">&#34;exec.*&#34;</span> 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">return</span> path limit 5
</span></span></code></pre></div><p>其中<code>()-[]-&gt;()</code>代表的结构是<code>点-边-点</code>。可以结合上图理解。</p>
<p>完整的paths</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>match <span style="color:#ff79c6">(</span>source<span style="color:#ff79c6">:</span>Method<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>match <span style="color:#ff79c6">(</span>sink<span style="color:#ff79c6">:</span>Method <span style="color:#ff79c6">{</span>NAME<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;exec&#34;</span><span style="color:#ff79c6">})&lt;-[:</span>CALL<span style="color:#ff79c6">]-(</span>m1<span style="color:#ff79c6">:</span>Method<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>where source<span style="color:#ff79c6">.</span><span style="color:#50fa7b">NAME</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;getDefaultPrinterNameBSD&#34;</span> and source<span style="color:#ff79c6">.</span><span style="color:#50fa7b">HAS_PARAMETERS</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">false</span> and sink<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CLASSNAME</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;java.lang.Runtime&#34;</span>
</span></span><span style="display:flex;"><span>call apoc<span style="color:#ff79c6">.</span><span style="color:#50fa7b">algo</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">allSimplePaths</span><span style="color:#ff79c6">(</span>m1<span style="color:#ff79c6">,</span> source<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;&lt;CALL|ALIAS&#34;</span><span style="color:#ff79c6">,</span> 12<span style="color:#ff79c6">)</span> yield path 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">return</span> <span style="color:#ff79c6">*</span> limit 5
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>match <span style="color:#ff79c6">(</span>source<span style="color:#ff79c6">:</span>Method <span style="color:#ff79c6">{</span>NAME<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;readObject&#34;</span><span style="color:#ff79c6">,</span>CLASSNAME<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;java.util.HashMap&#34;</span><span style="color:#ff79c6">})</span>
</span></span><span style="display:flex;"><span>match <span style="color:#ff79c6">(</span>sink<span style="color:#ff79c6">:</span>Method <span style="color:#ff79c6">{</span>NAME<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;toString&#34;</span><span style="color:#ff79c6">})</span>
</span></span><span style="display:flex;"><span>with source<span style="color:#ff79c6">,</span> collect<span style="color:#ff79c6">(</span>sink<span style="color:#ff79c6">)</span> as sinks
</span></span><span style="display:flex;"><span>call tabby<span style="color:#ff79c6">.</span><span style="color:#50fa7b">algo</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">findJavaGadget</span><span style="color:#ff79c6">(</span>source<span style="color:#ff79c6">,</span> sinks<span style="color:#ff79c6">,</span> 12<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">)</span> yield path 
</span></span><span style="display:flex;"><span>where <span style="color:#50fa7b">none</span><span style="color:#ff79c6">(</span>n in <span style="color:#50fa7b">nodes</span><span style="color:#ff79c6">(</span>path<span style="color:#ff79c6">)</span> where n<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CLASSNAME</span> in <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#34;javax.management.BadAttributeValueExpException&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;com.sun.jmx.snmp.SnmpEngineId&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;com.sun.xml.internal.ws.api.BindingID&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;javax.swing.text.html.HTML$UnknownTag&#34;</span><span style="color:#ff79c6">])</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">return</span> path limit 1
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>match <span style="color:#ff79c6">(</span>source<span style="color:#ff79c6">:</span>Method<span style="color:#ff79c6">)</span> where source<span style="color:#ff79c6">.</span><span style="color:#50fa7b">NAME</span> in <span style="color:#ff79c6">[</span><span style="color:#f1fa8c">&#34;equals&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;hashCode&#34;</span><span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;compareTo&#34;</span><span style="color:#ff79c6">]</span> 
</span></span><span style="display:flex;"><span>with <span style="color:#50fa7b">collect</span><span style="color:#ff79c6">(</span>source<span style="color:#ff79c6">)</span> as sources
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">match</span> <span style="color:#ff79c6">(</span>sink<span style="color:#ff79c6">:</span>Method <span style="color:#ff79c6">{</span>IS_SINK<span style="color:#ff79c6">:</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">})</span> where sink<span style="color:#ff79c6">.</span><span style="color:#50fa7b">NAME</span> <span style="color:#ff79c6">=~</span> <span style="color:#f1fa8c">&#34;invoke&#34;</span> and sink<span style="color:#ff79c6">.</span><span style="color:#50fa7b">VUL</span> <span style="color:#ff79c6">=~</span> <span style="color:#f1fa8c">&#34;CODE&#34;</span> and sink<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CLASSNAME</span> <span style="color:#ff79c6">=~</span> <span style="color:#f1fa8c">&#34;java.lang.reflect.Method&#34;</span>
</span></span><span style="display:flex;"><span>with sources<span style="color:#ff79c6">,</span> collect<span style="color:#ff79c6">(</span>sink<span style="color:#ff79c6">)</span> as sinks
</span></span><span style="display:flex;"><span>call tabby<span style="color:#ff79c6">.</span><span style="color:#50fa7b">algo</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">allSimplePaths</span><span style="color:#ff79c6">(</span>sinks<span style="color:#ff79c6">,</span>sources<span style="color:#ff79c6">,</span> 15<span style="color:#ff79c6">,</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">)</span> yield path 
</span></span><span style="display:flex;"><span>where <span style="color:#50fa7b">none</span><span style="color:#ff79c6">(</span>n in <span style="color:#50fa7b">nodes</span><span style="color:#ff79c6">(</span>path<span style="color:#ff79c6">)</span> where <span style="color:#ff79c6">(</span>n<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CLASSNAME</span> <span style="color:#ff79c6">=~</span> <span style="color:#f1fa8c">&#34;java.util.Iterator&#34;</span> or n<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CLASSNAME</span> <span style="color:#ff79c6">=~</span> <span style="color:#f1fa8c">&#34;java.util.Enumeration&#34;</span> or n<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CLASSNAME</span> <span style="color:#ff79c6">=~</span> <span style="color:#f1fa8c">&#34;java.util.Map&#34;</span> or n<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CLASSNAME</span> <span style="color:#ff79c6">=~</span> <span style="color:#f1fa8c">&#34;java.util.List&#34;</span> or n<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CLASSNAME</span><span style="color:#ff79c6">=~</span><span style="color:#f1fa8c">&#34;jdk.nashorn.internal.ir.UnaryNode&#34;</span> or n<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CLASSNAME</span><span style="color:#ff79c6">=~</span><span style="color:#f1fa8c">&#34;com.sun.jndi.ldap.ClientId&#34;</span> or n<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CLASSNAME</span><span style="color:#ff79c6">=~</span><span style="color:#f1fa8c">&#34;org.apache.catalina.webresources.TrackedInputStream&#34;</span><span style="color:#ff79c6">))</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">return</span> path limit 1
</span></span></code></pre></div><p>对于此漏洞，首先想到</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>match <span style="color:#ff79c6">(</span>source<span style="color:#ff79c6">:</span>Method<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>match <span style="color:#ff79c6">(</span>sink<span style="color:#ff79c6">:</span>Method <span style="color:#ff79c6">{</span>NAME<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;exec&#34;</span><span style="color:#ff79c6">})&lt;-[:</span>CALL<span style="color:#ff79c6">]-(</span>m1<span style="color:#ff79c6">:</span>Method<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>where source<span style="color:#ff79c6">.</span><span style="color:#50fa7b">NAME</span><span style="color:#ff79c6">=~</span><span style="color:#f1fa8c">&#34;get.+&#34;</span> and source<span style="color:#ff79c6">.</span><span style="color:#50fa7b">HAS_PARAMETERS</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">false</span> and sink<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CLASSNAME</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;java.lang.Runtime&#34;</span>
</span></span><span style="display:flex;"><span>call apoc<span style="color:#ff79c6">.</span><span style="color:#50fa7b">algo</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">allSimplePaths</span><span style="color:#ff79c6">(</span>m1<span style="color:#ff79c6">,</span> source<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;&lt;CALL|ALIAS&#34;</span><span style="color:#ff79c6">,</span> 12<span style="color:#ff79c6">)</span> yield path 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">return</span> <span style="color:#ff79c6">*</span> limit 1
</span></span></code></pre></div><p>但是发现根本找不到预期UnixPrintServiceLookup这个类。马后炮一下看看其源码(?)，发现这个类的exec是在匿名类里调用的。猜测tabby没有加载进去？</p>
<p>那就看看有没有和<code>UnixPrintService</code>类似的类。这个类不能用的原因是constructor不满足要求。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>match <span style="color:#ff79c6">(</span>source<span style="color:#ff79c6">:</span>Method<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>match <span style="color:#ff79c6">(</span>sink<span style="color:#ff79c6">:</span>Method <span style="color:#ff79c6">{</span>NAME<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;execCmd&#34;</span><span style="color:#ff79c6">})&lt;-[:</span>CALL<span style="color:#ff79c6">]-(</span>m1<span style="color:#ff79c6">:</span>Method<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>where source<span style="color:#ff79c6">.</span><span style="color:#50fa7b">NAME</span><span style="color:#ff79c6">=~</span><span style="color:#f1fa8c">&#34;get.+&#34;</span> and source<span style="color:#ff79c6">.</span><span style="color:#50fa7b">HAS_PARAMETERS</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">false</span> and <span style="color:#50fa7b">not</span><span style="color:#ff79c6">(</span>m1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CLASSNAME</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;sun.print.UnixPrintService&#34;</span><span style="color:#ff79c6">)</span> and <span style="color:#50fa7b">not</span><span style="color:#ff79c6">(</span>sink<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CLASSNAME</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;sun.print.UnixPrintService&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>call apoc<span style="color:#ff79c6">.</span><span style="color:#50fa7b">algo</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">allSimplePaths</span><span style="color:#ff79c6">(</span>m1<span style="color:#ff79c6">,</span> source<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;&lt;CALL|ALIAS&#34;</span><span style="color:#ff79c6">,</span> 12<span style="color:#ff79c6">)</span> yield path 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">return</span> <span style="color:#ff79c6">*</span> limit 10
</span></span></code></pre></div><p>勉强算是找到了<code>UnixPrintServiceLookup</code>这个类吧（</p>
<p><img src="https://s2.loli.net/2023/01/02/ptkHSbucmQ8yO7E.png" alt="image-20230102172635123"></p>
<p>当然到这里强迫症还是很难受的。前面说过class的constructor有限制条件。所以这里尝试一下把source类的constructor设置为无参。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>match <span style="color:#ff79c6">(</span>source<span style="color:#ff79c6">:</span>Method<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>match <span style="color:#ff79c6">(</span>sink<span style="color:#ff79c6">:</span>Method <span style="color:#ff79c6">{</span>NAME<span style="color:#ff79c6">:</span><span style="color:#f1fa8c">&#34;execCmd&#34;</span><span style="color:#ff79c6">})&lt;-[:</span>CALL<span style="color:#ff79c6">]-(</span>m1<span style="color:#ff79c6">:</span>Method<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>match <span style="color:#ff79c6">(</span>constructor<span style="color:#ff79c6">:</span>Method<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>match <span style="color:#ff79c6">(</span>clazz<span style="color:#ff79c6">:</span>Class<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>where source<span style="color:#ff79c6">.</span><span style="color:#50fa7b">NAME</span><span style="color:#ff79c6">=~</span><span style="color:#f1fa8c">&#34;get.+&#34;</span> and source<span style="color:#ff79c6">.</span><span style="color:#50fa7b">HAS_PARAMETERS</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">false</span> and <span style="color:#50fa7b">not</span><span style="color:#ff79c6">(</span>m1<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CLASSNAME</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;sun.print.UnixPrintService&#34;</span><span style="color:#ff79c6">)</span> and <span style="color:#50fa7b">not</span><span style="color:#ff79c6">(</span>sink<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CLASSNAME</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;sun.print.UnixPrintService&#34;</span><span style="color:#ff79c6">)</span> and constructor<span style="color:#ff79c6">.</span><span style="color:#50fa7b">HAS_PARAMETERS</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">false</span> 
</span></span><span style="display:flex;"><span><span style="color:#50fa7b">and</span> <span style="color:#ff79c6">(</span>clazz<span style="color:#ff79c6">)-[:</span>HAS<span style="color:#ff79c6">]-&gt;(</span>constructor<span style="color:#ff79c6">)</span> and <span style="color:#ff79c6">(</span>clazz<span style="color:#ff79c6">)-[:</span>HAS<span style="color:#ff79c6">]-&gt;(</span>source<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>call apoc<span style="color:#ff79c6">.</span><span style="color:#50fa7b">algo</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">allSimplePaths</span><span style="color:#ff79c6">(</span>m1<span style="color:#ff79c6">,</span> source<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;&lt;CALL|ALIAS&#34;</span><span style="color:#ff79c6">,</span> 12<span style="color:#ff79c6">)</span> yield path 
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">return</span> path limit 1
</span></span></code></pre></div><p>结果电脑跑冒烟都跑不出来hh</p>
<p>那就试试一条path</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span>match path<span style="color:#ff79c6">=(</span>source<span style="color:#ff79c6">:</span>Method<span style="color:#ff79c6">)-[:</span>CALL<span style="color:#ff79c6">]-&gt;(</span>sink<span style="color:#ff79c6">:</span>Method <span style="color:#ff79c6">{})</span>
</span></span><span style="display:flex;"><span>match <span style="color:#ff79c6">(</span>constructor<span style="color:#ff79c6">:</span>Method<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>match <span style="color:#ff79c6">(</span>clazz<span style="color:#ff79c6">:</span>Class<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>where source<span style="color:#ff79c6">.</span><span style="color:#50fa7b">HAS_PARAMETERS</span><span style="color:#ff79c6">=</span><span style="color:#ff79c6">false</span> and source<span style="color:#ff79c6">.</span><span style="color:#50fa7b">NAME</span> <span style="color:#ff79c6">=~</span> <span style="color:#f1fa8c">&#34;get.+&#34;</span> and sink<span style="color:#ff79c6">.</span><span style="color:#50fa7b">NAME</span> <span style="color:#ff79c6">=~</span> <span style="color:#f1fa8c">&#34;execCmd&#34;</span> 
</span></span><span style="display:flex;"><span>and <span style="color:#ff79c6">(</span>clazz<span style="color:#ff79c6">)-[:</span>HAS<span style="color:#ff79c6">]-&gt;(</span>constructor<span style="color:#ff79c6">)</span> and <span style="color:#ff79c6">(</span>clazz<span style="color:#ff79c6">)-[:</span>HAS<span style="color:#ff79c6">]-&gt;(</span>source<span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span>and <span style="color:#50fa7b">not</span><span style="color:#ff79c6">(</span>source<span style="color:#ff79c6">.</span><span style="color:#50fa7b">CLASSNAME</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;sun.print.UnixPrintService&#34;</span><span style="color:#ff79c6">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">return</span> path limit 1
</span></span></code></pre></div><p>也算是勉勉强强跑出来了吧大概</p>
<p><img src="https://s2.loli.net/2023/01/02/6vzGHOQKom1kN3U.png" alt="image-20230102174900626"></p>
<h3 id="cups服务">CUPS服务</h3>
<p>最后一个坑点就在于<code>UnixPrintServiceLookup</code>这个类最终运行到命令执行需要满足两个条件。</p>
<p><img src="https://s2.loli.net/2023/01/02/zbcLHtlaUWhVGSQ.png" alt="image-20230102175326184"></p>
<p>isCupsRunning要为false，并且不能是macOS和SunOS。后面这个条件其实读取的是该类的属性。由于我是Linux，就不用去管了。如果目标系统是macOS或SunOS，也可以通过反射绕过。</p>
<p>而isCupsRunning则是检测本机的CUPS服务。我本地的vmware+ubuntu环境是默认开启的。可以通过访问<code>http://127.0.0.1:631/</code>看看是否开启。<img src="https://s2.loli.net/2023/01/02/6x9ejUzIKhBvA8O.png" alt="image-20230102175653210"></p>
<p>关闭CUPS服务并重启，POC就能正常跑通了。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo systemctl mask cups
</span></span><span style="display:flex;"><span>reboot
</span></span></code></pre></div><h1 id="留给2023年的坑">留给2023年的坑</h1>
<p>还有一些由于能力原因尚未解决的问题：</p>
<ol>
<li>归类一下历史漏洞中出现过的链子。</li>
<li>前面提到，我把Class和Method串起来，tabby对此的耗时非常久。所以对于限定source或者sink类的一些性质，目前也没想到有什么解决方案。</li>
<li>我目前用apoc自带的函数<code>apoc.algo.allSimplePaths</code>来完成边的寻找。但是我还没有想到或搜到对paths上的node限定的方法。对于Java反序列化原生链的限定可以通过<a href="%5Btabby-path-finder%5D(https://github.com/wh1t3p1g/tabby-path-finder)">https://github.com/wh1t3p1g/tabby-path-finder</a>插件解决。但是有人嫌编译太麻烦没有去尝试（</li>
</ol>

        </p>
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#一些废话">一些废话</a></li>
    <li><a href="#环境配置">环境配置</a></li>
    <li><a href="#漏洞分析">漏洞分析</a>
      <ul>
        <li><a href="#source-tostring">source: toString</a></li>
        <li><a href="#tostring2getter">toString2getter</a></li>
        <li><a href="#getter2rce">getter2RCE</a>
          <ul>
            <li><a href="#条件">条件</a></li>
            <li><a href="#tabby">tabby</a></li>
            <li><a href="#cups服务">CUPS服务</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#留给2023年的坑">留给2023年的坑</a></li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2023 </span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
